<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% if is_new %}–°–æ–∑–¥–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞{% else %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞{% endif %} - Job Notification Bot</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        /* Setup guide styles */
        .setup-steps {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 1rem;
        }
        .setup-step {
            display: flex;
            gap: 15px;
            align-items: flex-start;
        }
        .step-number {
            width: 32px;
            height: 32px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.1rem;
            flex-shrink: 0;
        }
        .step-content {
            flex: 1;
        }

        /* ID helper button */
        .id-helper {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .id-helper .input {
            flex: 1;
        }
        .btn-helper {
            padding: 8px 12px;
            background: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.85rem;
            white-space: nowrap;
            transition: background 0.2s;
        }
        .btn-helper:hover {
            background: #e0e0e0;
        }

        /* Section divider with title */
        .section-divider {
            display: flex;
            align-items: center;
            margin: 2rem 0;
            gap: 15px;
        }
        .section-divider::before,
        .section-divider::after {
            content: '';
            flex: 1;
            height: 2px;
            background: #e0e0e0;
        }
        .section-divider span {
            color: #666;
            font-size: 0.9rem;
            white-space: nowrap;
        }

        /* Info tooltip */
        .info-tooltip {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            background: #667eea;
            color: white;
            border-radius: 50%;
            font-size: 12px;
            cursor: help;
            margin-left: 5px;
        }

        /* Notification animations */
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>{% if is_new %}‚ûï –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞{% else %}‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞{% endif %}</h1>
            <p>–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∫–∞–Ω–∞–ª –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –≤–∞–∫–∞–Ω—Å–∏—è—Ö</p>
        </div>

        <!-- –ü–æ—à–∞–≥–æ–≤—ã–π –≥–∞–π–¥ –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
        {% if is_new %}
        <div class="card setup-guide" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; margin-bottom: 1.5rem;">
            <h2 style="margin-top: 0; display: flex; align-items: center; gap: 10px;">
                üìã –ö–∞–∫ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤–∞–∫–∞–Ω—Å–∏–π
            </h2>
            <div class="setup-steps">
                <div class="setup-step">
                    <div class="step-number">1</div>
                    <div class="step-content">
                        <strong>–°–æ–∑–¥–∞–π—Ç–µ –∫–∞–Ω–∞–ª –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</strong>
                        <p style="margin: 5px 0 0 0; opacity: 0.9; font-size: 0.9rem;">
                            Telegram ‚Üí –°–æ–∑–¥–∞—Ç—å –∫–∞–Ω–∞–ª ‚Üí –ü—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–∞–Ω–∞–ª<br>
                            –°—é–¥–∞ –±—É–¥—É—Ç –ø—Ä–∏—Ö–æ–¥–∏—Ç—å –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–µ –≤–∞–∫–∞–Ω—Å–∏–∏
                        </p>
                    </div>
                </div>
                <div class="setup-step">
                    <div class="step-number">2</div>
                    <div class="step-content">
                        <strong>–ü–æ–ª—É—á–∏—Ç–µ ID –∫–∞–Ω–∞–ª–∞</strong>
                        <p style="margin: 5px 0 0 0; opacity: 0.9; font-size: 0.9rem;">
                            –ù–∞–ø–∏—à–∏—Ç–µ —á—Ç–æ-–Ω–∏–±—É–¥—å –≤ –∫–∞–Ω–∞–ª ‚Üí –ø–µ—Ä–µ—à–ª–∏—Ç–µ –≠–¢–û —Å–æ–æ–±—â–µ–Ω–∏–µ –±–æ—Ç—É <a href="https://t.me/getmyid_bot" target="_blank" style="color: #fff; text-decoration: underline;">@getmyid_bot</a><br>
                            –ù–∞–π–¥–∏—Ç–µ —Å—Ç—Ä–æ–∫—É <code style="background: rgba(255,255,255,0.2); padding: 2px 6px; border-radius: 3px;">Forwarded from chat: -100...</code>
                        </p>
                    </div>
                </div>
                <div class="setup-step">
                    <div class="step-number">3</div>
                    <div class="step-content">
                        <strong>–î–æ–±–∞–≤—å—Ç–µ –±–æ—Ç–∞ –≤ –∫–∞–Ω–∞–ª</strong>
                        <p style="margin: 5px 0 0 0; opacity: 0.9; font-size: 0.9rem;">
                            –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞–Ω–∞–ª–∞ ‚Üí –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã ‚Üí –î–æ–±–∞–≤–∏—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞<br>
                            –ù–∞–π–¥–∏—Ç–µ –±–æ—Ç–∞ –∏ –¥–∞–π—Ç–µ –ø—Ä–∞–≤–∞ –Ω–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏—é
                        </p>
                    </div>
                </div>
            </div>

            <details style="margin-top: 1rem; background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">
                <summary style="cursor: pointer; font-weight: bold;">ü§ñ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ CRM (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</summary>
                <div style="margin-top: 10px; padding-left: 10px;">
                    <p style="margin: 0 0 10px 0; font-size: 0.9rem;">
                        CRM –ø–æ–∑–≤–æ–ª—è–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–∫–ª–∏–∫–∞—Ç—å—Å—è –Ω–∞ –≤–∞–∫–∞–Ω—Å–∏–∏ –∏ –≤–µ—Å—Ç–∏ –ø–µ—Ä–µ–ø–∏—Å–∫—É –≤ —É–¥–æ–±–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ —Ç–æ–ø–∏–∫–æ–≤.
                    </p>
                    <ol style="margin: 0; padding-left: 20px; font-size: 0.9rem; line-height: 1.8;">
                        <li><strong>–°–æ–∑–¥–∞–π—Ç–µ –≥—Ä—É–ø–ø—É —Å —Ç–æ–ø–∏–∫–∞–º–∏:</strong> Telegram ‚Üí –°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É ‚Üí –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚öôÔ∏è ‚Üí –¢–µ–º—ã ‚Üí –í–∫–ª—é—á–∏—Ç—å</li>
                        <li><strong>–ü–æ–ª—É—á–∏—Ç–µ ID –≥—Ä—É–ø–ø—ã:</strong> –ù–∞–ø–∏—à–∏—Ç–µ —á—Ç–æ-–Ω–∏–±—É–¥—å –≤ –≥—Ä—É–ø–ø—É ‚Üí –ø–µ—Ä–µ—à–ª–∏—Ç–µ —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ @getmyid_bot ‚Üí —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ "Forwarded from chat"</li>
                        <li><strong>–î–æ–±–∞–≤—å—Ç–µ –∞–≥–µ–Ω—Ç–æ–≤:</strong> –≠—Ç–æ –≤–∞—à–∏ Telegram-–∞–∫–∫–∞—É–Ω—Ç—ã –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–∫–ª–∏–∫–æ–≤</li>
                    </ol>
                </div>
            </details>
        </div>
        {% endif %}

        <div class="card">
            <a href="/" class="button button-secondary button-small" style="margin-bottom: 1rem;">
                ‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É
            </a>

            <form id="channel-form">
                <div class="form-group">
                    <label for="name">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞ *</label>
                    <input 
                        type="text" 
                        id="name" 
                        name="name" 
                        class="input" 
                        placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: Python —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∏"
                        value="{% if channel %}{{ channel.name }}{% endif %}"
                        required
                    >
                    <span class="help-text">–£–¥–æ–±–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏</span>
                </div>

                <div class="form-group">
                    <label for="telegram_id">
                        ID –∫–∞–Ω–∞–ª–∞ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π *
                        <span class="info-tooltip" title="–ö—É–¥–∞ –±–æ—Ç –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–µ –≤–∞–∫–∞–Ω—Å–∏–∏">?</span>
                    </label>
                    <div class="id-helper">
                        <input
                            type="text"
                            id="telegram_id"
                            name="telegram_id"
                            class="input"
                            placeholder="-100XXXXXXXXXX"
                            value="{% if channel %}{{ channel.telegram_id }}{% endif %}"
                            required
                        >
                        <button type="button" class="btn-helper" onclick="autoCreateChannel()" title="–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—Ç—å –∫–∞–Ω–∞–ª">
                            ‚ú® –°–æ–∑–¥–∞—Ç—å –∫–∞–Ω–∞–ª
                        </button>
                        <a href="https://t.me/getmyid_bot" target="_blank" class="btn-helper" title="–û—Ç–∫—Ä—ã—Ç—å –±–æ—Ç–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è ID">
                            üîç –£–∑–Ω–∞—Ç—å ID
                        </a>
                    </div>
                    <span class="help-text">
                        <strong>–í–∞—Ä–∏–∞–Ω—Ç 1:</strong> –ù–∞–∂–º–∏—Ç–µ "–°–æ–∑–¥–∞—Ç—å –∫–∞–Ω–∞–ª" ‚Äî –±–æ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—Å—Ç –∫–∞–Ω–∞–ª –∏ –∑–∞–ø–æ–ª–Ω–∏—Ç ID<br>
                        <strong>–í–∞—Ä–∏–∞–Ω—Ç 2 (–≤—Ä—É—á–Ω—É—é):</strong><br>
                        &nbsp;&nbsp;1. –°–æ–∑–¥–∞–π—Ç–µ –∫–∞–Ω–∞–ª –≤ Telegram<br>
                        &nbsp;&nbsp;2. –ù–∞–ø–∏—à–∏—Ç–µ –ª—é–±–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∫–∞–Ω–∞–ª<br>
                        &nbsp;&nbsp;3. –ü–µ—Ä–µ—à–ª–∏—Ç–µ –≠–¢–û —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ <a href="https://t.me/getmyid_bot" target="_blank">@getmyid_bot</a><br>
                        &nbsp;&nbsp;4. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ ID –∏–∑ —Å—Ç—Ä–æ–∫–∏ "Forwarded from chat" (–Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å -100...)
                    </span>
                </div>

                <div class="form-group">
                    <label for="input_sources">–ò—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ *</label>
                    <textarea 
                        id="input_sources" 
                        name="input_sources" 
                        class="input textarea" 
                        placeholder="@channel1&#10;@channel2&#10;@channel3"
                        required
                    >{% if channel %}{{ channel.input_sources|join('\n') }}{% endif %}</textarea>
                    <span class="help-text">
                        –°–ø–∏—Å–æ–∫ –∫–∞–Ω–∞–ª–æ–≤ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ (–ø–æ –æ–¥–Ω–æ–º—É –Ω–∞ —Å—Ç—Ä–æ–∫—É).
                        –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å @username –∏–ª–∏ ID –∫–∞–Ω–∞–ª–∞.
                    </span>
                </div>

                <div class="form-group">
                    <label for="include_keywords">–í–∫–ª—é—á–∞—é—â–∏–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞</label>
                    <textarea 
                        id="include_keywords" 
                        name="include_keywords" 
                        class="input textarea" 
                        placeholder="python&#10;django&#10;flask"
                    >{% if channel %}{{ channel.filters.include_keywords|join('\n') }}{% endif %}</textarea>
                    <span class="help-text">
                        –ï—Å–ª–∏ –æ—Å—Ç–∞–≤–∏—Ç—å –ø—É—Å—Ç—ã–º - –±—É–¥—É—Ç –ø—Ä–∏—Ö–æ–¥–∏—Ç—å –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ (–Ω–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è). 
                        –ï—Å–ª–∏ –∑–∞–ø–æ–ª–Ω–∏—Ç—å - —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –∏–∑ —ç—Ç–∏—Ö —Å–ª–æ–≤.
                    </span>
                </div>

                <div class="form-group">
                    <label for="exclude_keywords">–ò—Å–∫–ª—é—á–∞—é—â–∏–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞</label>
                    <textarea 
                        id="exclude_keywords" 
                        name="exclude_keywords" 
                        class="input textarea" 
                        placeholder="junior&#10;—Å—Ç–∞–∂–µ—Ä&#10;trainee"
                    >{% if channel %}{{ channel.filters.exclude_keywords|join('\n') }}{% endif %}</textarea>
                    <span class="help-text">
                        –°–æ–æ–±—â–µ–Ω–∏—è —Å —ç—Ç–∏–º–∏ —Å–ª–æ–≤–∞–º–∏ –±—É–¥—É—Ç –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω—ã (–ø–æ –æ–¥–Ω–æ–º—É –Ω–∞ —Å—Ç—Ä–æ–∫—É)
                    </span>
                </div>

                <div class="form-group">
                    <label>
                        <input 
                            type="checkbox" 
                            id="enabled" 
                            name="enabled" 
                            {% if is_new or (channel and channel.enabled) %}checked{% endif %}
                        >
                        –ö–∞–Ω–∞–ª –∞–∫—Ç–∏–≤–µ–Ω
                    </label>
                    <span class="help-text">
                        –û—Ç–∫–ª—é—á–∏—Ç–µ –µ—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ –≤—Ä–µ–º–µ–Ω–Ω–æ –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
                    </span>
                </div>

                <div class="section-divider">
                    <span>ü§ñ CRM –∏ –∞–≤—Ç–æ–æ—Ç–≤–µ—Ç—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</span>
                </div>

                <div class="form-group">
                    <label>
                        <input
                            type="checkbox"
                            id="crm_enabled"
                            name="crm_enabled"
                            {% if channel and channel.crm_enabled %}checked{% endif %}
                            onchange="toggleCrmFields()"
                        >
                        –í–∫–ª—é—á–∏—Ç—å CRM —Ä–µ–∂–∏–º
                    </label>
                    <span class="help-text">
                        –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –æ—Ç–∫–ª–∏–∫–∏ –Ω–∞ –≤–∞–∫–∞–Ω—Å–∏–∏ + –≤–µ–¥–µ–Ω–∏–µ –ø–µ—Ä–µ–ø–∏—Å–∫–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ —Ç–æ–ø–∏–∫–æ–≤
                    </span>
                </div>

                <div id="crm-fields" style="display: none;">
                    <div class="alert alert-info" style="margin-bottom: 1.5rem;">
                        <strong>üí° –ß—Ç–æ —Ç–∞–∫–æ–µ CRM —Ä–µ–∂–∏–º?</strong><br>
                        <ul style="margin: 10px 0 0 20px; padding: 0;">
                            <li>–ê–≥–µ–Ω—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ—Ç–∫–ª–∏–∫ —Ä–∞–±–æ—Ç–æ–¥–∞—Ç–µ–ª—é</li>
                            <li>–î–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–æ–Ω—Ç–∞–∫—Ç–∞ —Å–æ–∑–¥–∞—ë—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ç–æ–ø–∏–∫ –≤ –≥—Ä—É–ø–ø–µ</li>
                            <li>–í—Å—è –ø–µ—Ä–µ–ø–∏—Å–∫–∞ —Ç—Ä–∞–Ω—Å–ª–∏—Ä—É–µ—Ç—Å—è –≤ —Ç–æ–ø–∏–∫ –¥–ª—è —É–¥–æ–±–Ω–æ–≥–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è</li>
                        </ul>
                    </div>

                    <div class="form-group">
                        <label for="crm_group_id">
                            ID –≥—Ä—É–ø–ø—ã –¥–ª—è CRM (—Å —Ç–æ–ø–∏–∫–∞–º–∏)
                            <span class="info-tooltip" title="–ì—Ä—É–ø–ø–∞ —Å –≤–∫–ª—é—á–µ–Ω–Ω—ã–º–∏ —Ç–µ–º–∞–º–∏, –≥–¥–µ –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å—Å—è —Ç–æ–ø–∏–∫ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–æ–Ω—Ç–∞–∫—Ç–∞">?</span>
                        </label>
                        <div class="id-helper">
                            <input
                                type="text"
                                id="crm_group_id"
                                name="crm_group_id"
                                class="input"
                                placeholder="-100XXXXXXXXXX"
                                value="{% if channel %}{{ channel.crm_group_id if channel.crm_group_id else '' }}{% endif %}"
                            >
                            <button type="button" class="btn-helper" onclick="autoCreateCrmGroup()" title="–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É —Å —Ç–æ–ø–∏–∫–∞–º–∏">
                                ‚ú® –°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É
                            </button>
                            <a href="https://t.me/getmyid_bot" target="_blank" class="btn-helper" title="–û—Ç–∫—Ä—ã—Ç—å –±–æ—Ç–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è ID">
                                üîç –£–∑–Ω–∞—Ç—å ID
                            </a>
                        </div>
                        <span class="help-text">
                            <strong>–í–∞—Ä–∏–∞–Ω—Ç 1:</strong> –ù–∞–∂–º–∏—Ç–µ "–°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É" ‚Äî –±–æ—Ç —Å–æ–∑–¥–∞—Å—Ç –≥—Ä—É–ø–ø—É —Å —Ç–æ–ø–∏–∫–∞–º–∏ –∏ –∑–∞–ø–æ–ª–Ω–∏—Ç ID<br>
                            <strong>–í–∞—Ä–∏–∞–Ω—Ç 2 (–≤—Ä—É—á–Ω—É—é):</strong><br>
                            &nbsp;&nbsp;1. –°–æ–∑–¥–∞–π—Ç–µ –≥—Ä—É–ø–ø—É ‚Üí –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚öôÔ∏è ‚Üí –¢–µ–º—ã ‚Üí –í–∫–ª—é—á–∏—Ç—å<br>
                            &nbsp;&nbsp;2. –ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –≥—Ä—É–ø–ø—É<br>
                            &nbsp;&nbsp;3. –ü–µ—Ä–µ—à–ª–∏—Ç–µ –µ–≥–æ –≤ <a href="https://t.me/getmyid_bot" target="_blank">@getmyid_bot</a><br>
                            &nbsp;&nbsp;4. ID –≤ —Å—Ç—Ä–æ–∫–µ "Forwarded from chat" (–Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å -100...)
                        </span>
                    </div>

                    <div class="form-group">
                        <label>
                            –ê–≥–µ–Ω—Ç—ã –¥–ª—è –∞–≤—Ç–æ–æ—Ç–≤–µ—Ç–æ–≤
                            <span class="info-tooltip" title="–í–∞—à–∏ Telegram-–∞–∫–∫–∞—É–Ω—Ç—ã, –æ—Ç –∏–º–µ–Ω–∏ –∫–æ—Ç–æ—Ä—ã—Ö –±—É–¥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å—Å—è –æ—Ç–∫–ª–∏–∫–∏">?</span>
                        </label>
                        <div class="alert" style="background: #fff3cd; border: 1px solid #ffc107; margin-bottom: 1rem;">
                            <strong>‚ö†Ô∏è –ß—Ç–æ —Ç–∞–∫–æ–µ –∞–≥–µ–Ω—Ç?</strong><br>
                            –ê–≥–µ–Ω—Ç ‚Äî —ç—Ç–æ –≤–∞—à –ª–∏—á–Ω—ã–π Telegram-–∞–∫–∫–∞—É–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –æ—Ç–∫–ª–∏–∫–∏ —Ä–∞–±–æ—Ç–æ–¥–∞—Ç–µ–ª—è–º.
                            –í–∞–º –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è —á–µ—Ä–µ–∑ –∫–æ–¥ –∏–∑ SMS.
                        </div>
                        <div id="agents-list">
                            {% if channel and channel.agents %}
                                {% for agent in channel.agents %}
                                <div class="agent-item" style="border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 5px; background: #f9f9f9;">
                                    <div style="display: flex; gap: 15px; align-items: end;">
                                        <div style="flex: 1;">
                                            <label>üì± –¢–µ–ª–µ—Ñ–æ–Ω</label>
                                            <input type="text" class="input agent-phone" placeholder="+79991234567" value="{{ agent.phone }}" readonly style="background: #eee;">
                                        </div>
                                        <div style="flex: 1;">
                                            <label>üìÅ –°–µ—Å—Å–∏—è</label>
                                            <input type="text" class="input agent-session" placeholder="agent_1" value="{{ agent.session_name }}" readonly style="background: #eee;">
                                        </div>
                                        <button type="button" class="btn btn-danger" onclick="removeAgent(this)">‚úï</button>
                                    </div>
                                </div>
                                {% endfor %}
                            {% endif %}
                        </div>
                        <button type="button" class="btn btn-secondary" onclick="addAgent()" style="margin-top: 10px;">
                            ‚ûï –î–æ–±–∞–≤–∏—Ç—å –∞–≥–µ–Ω—Ç–∞
                        </button>
                        <span class="help-text">
                            <strong>–°–æ–≤–µ—Ç:</strong> –î–æ–±–∞–≤—å—Ç–µ 2-3 –∞–≥–µ–Ω—Ç–∞ –¥–ª—è –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç–∏.
                            –ü—Ä–∏ FloodWait –æ–¥–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥—Ä—É–≥–æ–π.
                        </span>
                    </div>

                    <div class="form-group">
                        <label>
                            <input 
                                type="checkbox" 
                                id="auto_response_enabled" 
                                name="auto_response_enabled" 
                                {% if channel and channel.auto_response_enabled %}checked{% endif %}
                            >
                            –í–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–æ—Ç–≤–µ—Ç—ã
                        </label>
                        <span class="help-text">
                            –ê–≥–µ–Ω—Ç –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞ –≤–∞–∫–∞–Ω—Å–∏—é
                        </span>
                    </div>

                    <div class="form-group">
                        <label for="auto_response_template">–®–∞–±–ª–æ–Ω –∞–≤—Ç–æ–æ—Ç–≤–µ—Ç–∞</label>
                        <textarea 
                            id="auto_response_template" 
                            name="auto_response_template" 
                            class="input textarea" 
                            placeholder="–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ó–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–ª–∞ –≤–∞—à–∞ –≤–∞–∫–∞–Ω—Å–∏—è. –†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –ø–æ–¥—Ä–æ–±–Ω–µ–µ?"
                        >{% if channel %}{{ channel.auto_response_template }}{% endif %}</textarea>
                        <span class="help-text">
                            –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –∫–æ—Ç–æ—Ä—ã–π –∞–≥–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç —Ä–∞–±–æ—Ç–æ–¥–∞—Ç–µ–ª—é
                        </span>
                    </div>
                </div>

                <div class="section-divider">
                    <span>ü§ñ AI –ø—Ä–æ–º–ø—Ç—ã</span>
                </div>

                <div class="form-group">
                    <p class="help-text" style="margin-bottom: 15px;">
                        –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ AI –ø—Ä–∏ –æ–±—â–µ–Ω–∏–∏ —Å –∫–æ–Ω—Ç–∞–∫—Ç–∞–º–∏. –ï—Å–ª–∏ –æ—Å—Ç–∞–≤–∏—Ç—å –ø—É—Å—Ç—ã–º - –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã.
                        <button type="button" class="btn-helper" onclick="loadDefaultPrompts()" style="margin-left: 10px;">üîÑ –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ</button>
                    </p>

                    <details style="margin-bottom: 15px;">
                        <summary style="cursor: pointer; font-weight: bold;">üìù –ë–∞–∑–æ–≤—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç</summary>
                        <div style="margin-top: 10px;">
                            <textarea id="prompt_base_context" class="input textarea" style="min-height: 150px;" placeholder="–û–±—â–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏ —Å—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è AI">{% if channel and channel.prompts %}{{ channel.prompts.base_context }}{% endif %}</textarea>
                        </div>
                    </details>

                    <details style="margin-bottom: 15px;">
                        <summary style="cursor: pointer; font-weight: bold;">üîç Discovery (–∑–Ω–∞–∫–æ–º—Å—Ç–≤–æ)</summary>
                        <div style="margin-top: 10px;">
                            <textarea id="prompt_discovery" class="input textarea" style="min-height: 100px;" placeholder="–ü—Ä–æ–º–ø—Ç –¥–ª—è —ç—Ç–∞–ø–∞ –∑–Ω–∞–∫–æ–º—Å—Ç–≤–∞">{% if channel and channel.prompts %}{{ channel.prompts.discovery }}{% endif %}</textarea>
                        </div>
                    </details>

                    <details style="margin-bottom: 15px;">
                        <summary style="cursor: pointer; font-weight: bold;">üí¨ Engagement (–≤–æ–≤–ª–µ—á–µ–Ω–∏–µ)</summary>
                        <div style="margin-top: 10px;">
                            <textarea id="prompt_engagement" class="input textarea" style="min-height: 100px;" placeholder="–ü—Ä–æ–º–ø—Ç –¥–ª—è —ç—Ç–∞–ø–∞ –≤–æ–≤–ª–µ—á–µ–Ω–∏—è">{% if channel and channel.prompts %}{{ channel.prompts.engagement }}{% endif %}</textarea>
                        </div>
                    </details>

                    <details style="margin-bottom: 15px;">
                        <summary style="cursor: pointer; font-weight: bold;">üìû Call Ready (–≥–æ—Ç–æ–≤ –∫ –∑–≤–æ–Ω–∫—É)</summary>
                        <div style="margin-top: 10px;">
                            <textarea id="prompt_call_ready" class="input textarea" style="min-height: 100px;" placeholder="–ü—Ä–æ–º–ø—Ç –∫–æ–≥–¥–∞ –≥–æ—Ç–æ–≤ –∫ –∑–≤–æ–Ω–∫—É">{% if channel and channel.prompts %}{{ channel.prompts.call_ready }}{% endif %}</textarea>
                        </div>
                    </details>

                    <details style="margin-bottom: 15px;">
                        <summary style="cursor: pointer; font-weight: bold;">‚è≥ Call Pending (–∑–≤–æ–Ω–æ–∫ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω)</summary>
                        <div style="margin-top: 10px;">
                            <textarea id="prompt_call_pending" class="input textarea" style="min-height: 100px;" placeholder="–ü—Ä–æ–º–ø—Ç –∫–æ–≥–¥–∞ –∑–≤–æ–Ω–æ–∫ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω">{% if channel and channel.prompts %}{{ channel.prompts.call_pending }}{% endif %}</textarea>
                        </div>
                    </details>

                    <details>
                        <summary style="cursor: pointer; font-weight: bold;">‚ùå Call Declined (–∑–≤–æ–Ω–æ–∫ –æ—Ç–∫–ª–æ–Ω–µ–Ω)</summary>
                        <div style="margin-top: 10px;">
                            <textarea id="prompt_call_declined" class="input textarea" style="min-height: 100px;" placeholder="–ü—Ä–æ–º–ø—Ç –∫–æ–≥–¥–∞ –∑–≤–æ–Ω–æ–∫ –æ—Ç–∫–ª–æ–Ω–µ–Ω">{% if channel and channel.prompts %}{{ channel.prompts.call_declined }}{% endif %}</textarea>
                        </div>
                    </details>
                </div>

                <div class="alert alert-info">
                    <strong>üí° –°–æ–≤–µ—Ç:</strong> –ù–∞—á–Ω–∏—Ç–µ —Å –Ω–µ–±–æ–ª—å—à–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤,
                    –∑–∞—Ç–µ–º –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ —Ä–∞—Å—à–∏—Ä—è–π—Ç–µ —Å–ø–∏—Å–æ–∫ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤.
                </div>

                <div class="button-group">
                    <button type="submit" class="button button-primary">
                        {% if is_new %}‚úì –°–æ–∑–¥–∞—Ç—å –∫–∞–Ω–∞–ª{% else %}‚úì –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è{% endif %}
                    </button>
                    <a href="/" class="button button-secondary">–û—Ç–º–µ–Ω–∞</a>
                </div>
            </form>
        </div>
    </div>

    <div class="loading-overlay" id="loading">
        <div class="spinner"></div>
        <p>–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...</p>
    </div>

    <script>
        const isNew = {{ 'true' if is_new else 'false' }};
        const channelId = {% if channel %}'{{ channel.id }}'{% else %}null{% endif %};

        // Toggle CRM fields visibility
        function toggleCrmFields() {
            const crmEnabled = document.getElementById('crm_enabled').checked;
            const crmFields = document.getElementById('crm-fields');
            crmFields.style.display = crmEnabled ? 'block' : 'none';
        }

        // Load default prompts from server
        async function loadDefaultPrompts() {
            try {
                const response = await fetch('/api/channels/prompts/defaults');
                const data = await response.json();
                if (data.success && data.prompts) {
                    document.getElementById('prompt_base_context').value = data.prompts.base_context || '';
                    document.getElementById('prompt_discovery').value = data.prompts.discovery || '';
                    document.getElementById('prompt_engagement').value = data.prompts.engagement || '';
                    document.getElementById('prompt_call_ready').value = data.prompts.call_ready || '';
                    document.getElementById('prompt_call_pending').value = data.prompts.call_pending || '';
                    document.getElementById('prompt_call_declined').value = data.prompts.call_declined || '';
                    showNotification('–î–µ—Ñ–æ–ª—Ç–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã', 'success');
                }
            } catch (e) {
                console.error('Error loading prompts:', e);
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–º–ø—Ç–æ–≤', 'error');
            }
        }

        // Collect prompts from form
        function collectPrompts() {
            return {
                base_context: document.getElementById('prompt_base_context').value,
                discovery: document.getElementById('prompt_discovery').value,
                engagement: document.getElementById('prompt_engagement').value,
                call_ready: document.getElementById('prompt_call_ready').value,
                call_pending: document.getElementById('prompt_call_pending').value,
                call_declined: document.getElementById('prompt_call_declined').value
            };
        }

        // ==================== Auto-create Functions ====================

        async function autoCreateChannel() {
            const channelName = document.getElementById('name').value.trim();
            if (!channelName) {
                alert('‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞ –≤ –ø–æ–ª–µ –≤—ã—à–µ');
                document.getElementById('name').focus();
                return;
            }

            const title = prompt(
                'üì¢ –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π\n\n' +
                '–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞ –≤ Telegram:',
                channelName + ' - –í–∞–∫–∞–Ω—Å–∏–∏'
            );
            if (!title) return;

            const btn = event.target;
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = '‚è≥ –°–æ–∑–¥–∞–Ω–∏–µ...';

            try {
                const response = await fetch('/api/telegram/create-channel', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title: title, about: '–ö–∞–Ω–∞–ª –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –≤–∞–∫–∞–Ω—Å–∏—è—Ö' })
                });

                const data = await response.json();

                if (data.success) {
                    document.getElementById('telegram_id').value = data.channel_id;
                    showNotification('‚úÖ ' + data.message, 'success');
                } else {
                    alert('‚ùå ' + data.message);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É');
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        async function autoCreateCrmGroup() {
            const channelName = document.getElementById('name').value.trim();
            if (!channelName) {
                alert('‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞ –≤ –ø–æ–ª–µ "–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞"');
                document.getElementById('name').focus();
                return;
            }

            const title = prompt(
                'üíº –°–æ–∑–¥–∞–Ω–∏–µ CRM –≥—Ä—É–ø–ø—ã —Å —Ç–æ–ø–∏–∫–∞–º–∏\n\n' +
                '–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã:',
                channelName + ' - CRM'
            );
            if (!title) return;

            const btn = event.target;
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = '‚è≥ –°–æ–∑–¥–∞–Ω–∏–µ...';

            try {
                const response = await fetch('/api/telegram/create-crm-group', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title: title,
                        about: 'CRM –≥—Ä—É–ø–ø–∞ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –æ—Ç–∫–ª–∏–∫–æ–≤',
                        owner_username: 'kbrejes',  // –ê–≤—Ç–æ–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤–ª–∞–¥–µ–ª—å—Ü–∞
                        channel_id: channelId || ''  // –î–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∞–≥–µ–Ω—Ç–æ–≤
                    })
                });

                const data = await response.json();

                if (data.success) {
                    document.getElementById('crm_group_id').value = data.group_id;

                    let message = '‚úÖ ' + data.message;
                    if (data.invited_users && data.invited_users.length > 0) {
                        message += '\nüë• –î–æ–±–∞–≤–ª–µ–Ω—ã: ' + data.invited_users.join(', ');
                    }
                    if (data.invite_errors && data.invite_errors.length > 0) {
                        message += '\n‚ö†Ô∏è –û—à–∏–±–∫–∏: ' + data.invite_errors.join('; ');
                    }
                    if (data.note) {
                        message += '\n' + data.note;
                    }
                    showNotification(message, 'success');
                } else {
                    alert('‚ùå ' + data.message);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É');
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 8px;
                z-index: 10000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                max-width: 400px;
                animation: slideIn 0.3s ease;
            `;

            if (type === 'success') {
                notification.style.background = '#4caf50';
                notification.style.color = 'white';
            } else if (type === 'error') {
                notification.style.background = '#f44336';
                notification.style.color = 'white';
            } else {
                notification.style.background = '#2196f3';
                notification.style.color = 'white';
            }

            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 4000);
        }

        let currentAgentAuth = null;

        async function addAgent() {
            const agentsList = document.getElementById('agents-list');

            const phone = prompt("üì± –í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∞–≥–µ–Ω—Ç–∞ (—Å –∫–æ–¥–æ–º —Å—Ç—Ä–∞–Ω—ã, –Ω–∞–ø—Ä–∏–º–µ—Ä +79991234567):");
            if (!phone) return;

            // –û—á–∏—â–∞–µ–º —Ç–µ–ª–µ—Ñ–æ–Ω –æ—Ç –ø—Ä–æ–±–µ–ª–æ–≤ –∏ –¥–µ—Ñ–∏—Å–æ–≤
            const cleanPhone = phone.replace(/[\s\-]/g, '');

            // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
            const phoneRegex = /^\+\d{10,15}$/;
            if (!phoneRegex.test(cleanPhone)) {
                alert('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–∞.\n\n–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç: +79991234567');
                return;
            }

            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∏–º—è —Å–µ—Å—Å–∏–∏ –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 4 —Ü–∏—Ñ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞
            const lastDigits = cleanPhone.slice(-4);
            const sessionName = `agent_${lastDigits}`;

            currentAgentAuth = { phone: cleanPhone, sessionName };
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            showAuthModal();
            
            // –ò–Ω–∏—Ü–∏–∏—Ä—É–µ–º –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é
            try {
                const response = await fetch('/api/agents/init', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        phone: phone, 
                        session_name: sessionName 
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    if (data.needs_code) {
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –¥–ª—è –≤–≤–æ–¥–∞ –∫–æ–¥–∞
                        showAuthStep2();
                    } else if (data.already_authenticated) {
                        // –£–∂–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
                        showAuthStep3(data.user_info);
                        setTimeout(() => {
                            addAgentToList(phone, sessionName);
                            closeAuthModal();
                        }, 2000);
                    }
                } else {
                    alert(`‚ùå ${data.message}`);
                    closeAuthModal();
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É');
                closeAuthModal();
            }
        }
        
        function addAgentToList(phone, sessionName, userName) {
            const agentsList = document.getElementById('agents-list');
            
            const agentItem = document.createElement('div');
            agentItem.className = 'agent-item';
            agentItem.style.cssText = 'border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 5px;';
            
            agentItem.innerHTML = `
                <div style="display: flex; gap: 15px; align-items: end;">
                    <div style="flex: 1;">
                        <label>Telegram –∞–∫–∫–∞—É–Ω—Ç</label>
                        <input type="text" class="input agent-username" value="${userName || '‚Äî'}" readonly>
                    </div>
                    <div style="flex: 1;">
                        <label>–¢–µ–ª–µ—Ñ–æ–Ω</label>
                        <input type="text" class="input agent-phone" placeholder="+79991234567" value="${phone}" readonly>
                    </div>
                    <div style="flex: 1;">
                        <label>–ò–º—è —Å–µ—Å—Å–∏–∏</label>
                        <input type="text" class="input agent-session" placeholder="agent_1" value="${sessionName}" readonly>
                    </div>
                    <button type="button" class="btn btn-danger" onclick="removeAgent(this)">–£–¥–∞–ª–∏—Ç—å</button>
                </div>
            `;
            
            agentsList.appendChild(agentItem);
        }
        
        async function verifyAgentCode(e) {
            const code = document.getElementById('authCode').value.trim();
            if (!code) {
                alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥');
                return;
            }

            const verifyBtn = e ? e.target : document.getElementById('verifyCodeBtn');
            verifyBtn.disabled = true;
            verifyBtn.textContent = '–ü—Ä–æ–≤–µ—Ä–∫–∞...';
            
            try {
                const response = await fetch('/api/agents/verify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_name: currentAgentAuth.sessionName,
                        code: code
                    })
                });
                
                const data = await response.json();
                
                if (data.success && data.authenticated) {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Å–ø–µ—Ö
                    showAuthStep3(data.user_info);
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –∞–≥–µ–Ω—Ç–∞ –≤ —Å–ø–∏—Å–æ–∫
                    setTimeout(() => {
                        addAgentToList(currentAgentAuth.phone, currentAgentAuth.sessionName);
                        closeAuthModal();
                    }, 2000);
                } else if (data.needs_password) {
                    // –¢—Ä–µ–±—É–µ—Ç—Å—è 2FA –ø–∞—Ä–æ–ª—å
                    showAuthStep2_5();
                } else {
                    document.getElementById('authError').textContent = data.message;
                    document.getElementById('authError').style.display = 'block';
                    verifyBtn.disabled = false;
                    verifyBtn.textContent = '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å';
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                document.getElementById('authError').textContent = '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É';
                document.getElementById('authError').style.display = 'block';
                verifyBtn.disabled = false;
                verifyBtn.textContent = '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å';
            }
        }
        
        function showAuthModal() {
            document.getElementById('agentAuthModal').style.display = 'flex';
            document.getElementById('authPhone').textContent = currentAgentAuth.phone;
            document.getElementById('authStep1').style.display = 'block';
            document.getElementById('authStep2').style.display = 'none';
            document.getElementById('authStep2_5').style.display = 'none';
            document.getElementById('authStep3').style.display = 'none';
        }
        
        function showAuthStep2() {
            document.getElementById('authStep1').style.display = 'none';
            document.getElementById('authStep2').style.display = 'block';
            document.getElementById('authPhoneConfirm').textContent = currentAgentAuth.phone;
            document.getElementById('authCode').value = '';
            document.getElementById('authError').style.display = 'none';
            // –°–±—Ä–æ—Å –∫–Ω–æ–ø–∫–∏
            const btn = document.getElementById('verifyCodeBtn');
            btn.disabled = false;
            btn.textContent = '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å';
        }

        function showAuthStep2_5() {
            document.getElementById('authStep1').style.display = 'none';
            document.getElementById('authStep2').style.display = 'none';
            document.getElementById('authStep2_5').style.display = 'block';
            document.getElementById('authStep3').style.display = 'none';
            document.getElementById('auth2FAPassword').value = '';
            document.getElementById('auth2FAError').style.display = 'none';
            // –°–±—Ä–æ—Å –∫–Ω–æ–ø–∫–∏
            const btn = document.getElementById('verify2FABtn');
            btn.disabled = false;
            btn.textContent = '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å';
        }
        
        function showAuthStep3(userInfo) {
            document.getElementById('authStep1').style.display = 'none';
            document.getElementById('authStep2').style.display = 'none';
            document.getElementById('authStep2_5').style.display = 'none';
            document.getElementById('authStep3').style.display = 'block';
            document.getElementById('authUserInfo').textContent = `${userInfo.name} (@${userInfo.username})`;
        }
        
        async function verify2FAPassword(e) {
            const password = document.getElementById('auth2FAPassword').value.trim();
            if (!password) {
                alert('–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å');
                return;
            }

            const verifyBtn = e ? e.target : document.getElementById('verify2FABtn');
            verifyBtn.disabled = true;
            verifyBtn.textContent = '–ü—Ä–æ–≤–µ—Ä–∫–∞...';
            
            try {
                const response = await fetch('/api/agents/verify-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_name: currentAgentAuth.sessionName,
                        password: password
                    })
                });
                
                const data = await response.json();
                
                if (data.success && data.authenticated) {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Å–ø–µ—Ö
                    showAuthStep3(data.user_info);
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –∞–≥–µ–Ω—Ç–∞ –≤ —Å–ø–∏—Å–æ–∫
                    setTimeout(() => {
                        addAgentToList(currentAgentAuth.phone, currentAgentAuth.sessionName);
                        closeAuthModal();
                    }, 2000);
                } else {
                    document.getElementById('auth2FAError').textContent = data.message;
                    document.getElementById('auth2FAError').style.display = 'block';
                    verifyBtn.disabled = false;
                    verifyBtn.textContent = '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å';
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                document.getElementById('auth2FAError').textContent = '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É';
                document.getElementById('auth2FAError').style.display = 'block';
                verifyBtn.disabled = false;
                verifyBtn.textContent = '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å';
            }
        }
        
        function closeAuthModal() {
            document.getElementById('agentAuthModal').style.display = 'none';
            currentAgentAuth = null;
        }

        async function removeAgent(button) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å –∞–≥–µ–Ω—Ç–∞?')) {
                return;
            }
            
            const agentItem = button.closest('.agent-item');
            const phone = agentItem.querySelector('.agent-phone').value.trim();
            const sessionName = agentItem.querySelector('.agent-session').value.trim();
            
            // –£–¥–∞–ª—è–µ–º –∏–∑ DOM
            agentItem.remove();
            
            // –ï—Å–ª–∏ –∫–∞–Ω–∞–ª —É–∂–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω, –æ–±–Ω–æ–≤–ª—è–µ–º —á–µ—Ä–µ–∑ API
            // channelId –æ–ø—Ä–µ–¥–µ–ª—ë–Ω –≤ –Ω–∞—á–∞–ª–µ —Å–∫—Ä–∏–ø—Ç–∞
            if (channelId && channelId !== 'new') {
                try {
                    // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –∫–∞–Ω–∞–ª–∞
                    const response = await fetch(`/api/channels/${channelId}`);
                    if (!response.ok) {
                        throw new Error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∫–∞–Ω–∞–ª–∞');
                    }
                    const channelData = await response.json();
                    
                    if (channelData.success && channelData.channel) {
                        // –£–¥–∞–ª—è–µ–º –∞–≥–µ–Ω—Ç–∞ –∏–∑ —Å–ø–∏—Å–∫–∞
                        const updatedAgents = (channelData.channel.agents || []).filter(
                            a => !(a.phone === phone && a.session_name === sessionName)
                        );
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–Ω–∞–ª —á–µ—Ä–µ–∑ API
                        const updateResponse = await fetch(`/api/channels/${channelId}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                agents: updatedAgents
                            })
                        });
                        
                        if (!updateResponse.ok) {
                            throw new Error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–∞–Ω–∞–ª–∞');
                        }
                        
                        const updateData = await updateResponse.json();
                        if (updateData.success) {
                            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏
                            const notification = document.createElement('div');
                            notification.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #4caf50; color: white; padding: 15px 20px; border-radius: 5px; z-index: 10000; box-shadow: 0 4px 6px rgba(0,0,0,0.1);';
                            notification.textContent = '‚úÖ –ê–≥–µ–Ω—Ç —É–¥–∞–ª—ë–Ω –∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã';
                            document.body.appendChild(notification);
                            
                            setTimeout(() => {
                                notification.remove();
                            }, 3000);
                        }
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∞–≥–µ–Ω—Ç–∞:', error);
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ, –Ω–æ –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç –≤ DOM
                    alert('‚ö†Ô∏è –ê–≥–µ–Ω—Ç —É–¥–∞–ª—ë–Ω –∏–∑ —Ñ–æ—Ä–º—ã, –Ω–æ –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–∂–º–∏—Ç–µ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å" –≤—Ä—É—á–Ω—É—é.');
                }
            }
        }

        function collectAgents() {
            const agents = [];
            const agentItems = document.querySelectorAll('.agent-item');
            
            agentItems.forEach(item => {
                const phone = item.querySelector('.agent-phone').value.trim();
                const sessionName = item.querySelector('.agent-session').value.trim();
                
                if (phone && sessionName) {
                    agents.push({
                        phone: phone,
                        session_name: sessionName
                    });
                }
            });
            
            return agents;
        }

        // Initialize CRM fields visibility on page load
        document.addEventListener('DOMContentLoaded', function() {
            toggleCrmFields();
        });

        document.getElementById('channel-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const loading = document.getElementById('loading');
            loading.classList.add('active');

            try {
                // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã
                const formData = {
                    name: document.getElementById('name').value.trim(),
                    telegram_id: parseInt(document.getElementById('telegram_id').value.trim()),
                    input_sources: document.getElementById('input_sources').value
                        .split('\n')
                        .map(s => s.trim())
                        .filter(s => s.length > 0),
                    include_keywords: document.getElementById('include_keywords').value
                        .split('\n')
                        .map(s => s.trim())
                        .filter(s => s.length > 0),
                    exclude_keywords: document.getElementById('exclude_keywords').value
                        .split('\n')
                        .map(s => s.trim())
                        .filter(s => s.length > 0),
                    enabled: document.getElementById('enabled').checked,
                    
                    // CRM –ø–æ–ª—è
                    crm_enabled: document.getElementById('crm_enabled').checked,
                    crm_group_id: parseInt(document.getElementById('crm_group_id').value.trim()) || 0,
                    agents: collectAgents(),
                    auto_response_enabled: document.getElementById('auto_response_enabled').checked,
                    auto_response_template: document.getElementById('auto_response_template').value.trim(),

                    // –ü—Ä–æ–º–ø—Ç—ã
                    prompts: collectPrompts()
                };

                // –í–∞–ª–∏–¥–∞—Ü–∏—è
                if (!formData.name) {
                    alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞');
                    loading.classList.remove('active');
                    return;
                }

                if (!formData.telegram_id || isNaN(formData.telegram_id)) {
                    alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π ID Telegram –∫–∞–Ω–∞–ª–∞');
                    loading.classList.remove('active');
                    return;
                }

                if (formData.input_sources.length === 0) {
                    alert('–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –∏—Å—Ç–æ—á–Ω–∏–∫ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞');
                    loading.classList.remove('active');
                    return;
                }

                // –í–∞–ª–∏–¥–∞—Ü–∏—è CRM –∞–≥–µ–Ω—Ç–æ–≤
                if (formData.crm_enabled && formData.agents.length === 0) {
                    alert('–ü—Ä–∏ –≤–∫–ª—é—á–µ–Ω–Ω–æ–º CRM –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–æ–±–∞–≤–∏—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–≥–æ –∞–≥–µ–Ω—Ç–∞');
                    loading.classList.remove('active');
                    return;
                }

                // –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞
                const url = isNew ? '/api/channels' : `/api/channels/${channelId}`;
                const method = isNew ? 'POST' : 'PUT';

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (data.success) {
                    alert(isNew ? '–ö–∞–Ω–∞–ª —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!' : '–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!');
                    window.location.href = '/';
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + (data.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                    loading.classList.remove('active');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏');
                loading.classList.remove('active');
            }
        });
    </script>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∞–≥–µ–Ω—Ç–∞ -->
    <div id="agentAuthModal" class="auth-modal">
        <div class="auth-modal-content">
            <h3 style="margin-top: 0;">üîê –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∞–≥–µ–Ω—Ç–∞</h3>
            
            <div id="authStep1" class="auth-step">
                <p>–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞–≥–µ–Ω—Ç–∞ <strong id="authPhone"></strong>...</p>
                <div class="loading-spinner">‚è≥</div>
            </div>
            
            <div id="authStep2" class="auth-step" style="display: none;">
                <p>‚úâÔ∏è –ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ <strong id="authPhoneConfirm"></strong></p>
                <div class="form-group">
                    <label>–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥:</label>
                    <input type="text" id="authCode" class="input" placeholder="12345" maxlength="6" style="text-align: center; font-size: 1.2rem;">
                </div>
                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <button type="button" id="verifyCodeBtn" onclick="verifyAgentCode(event)" class="btn btn-primary" style="flex: 1;">
                        –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å
                    </button>
                    <button type="button" onclick="closeAuthModal()" class="btn btn-secondary" style="flex: 1;">
                        –û—Ç–º–µ–Ω–∞
                    </button>
                </div>
                <div id="authError" class="auth-error" style="display: none;"></div>
            </div>

            <div id="authStep2_5" class="auth-step" style="display: none;">
                <p>üîê –¢—Ä–µ–±—É–µ—Ç—Å—è –ø–∞—Ä–æ–ª—å –¥–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏</p>
                <div class="form-group">
                    <label>–í–≤–µ–¥–∏—Ç–µ 2FA –ø–∞—Ä–æ–ª—å:</label>
                    <input type="password" id="auth2FAPassword" class="input" placeholder="–í–∞—à –ø–∞—Ä–æ–ª—å" style="text-align: center; font-size: 1.2rem;">
                </div>
                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <button type="button" id="verify2FABtn" onclick="verify2FAPassword(event)" class="btn btn-primary" style="flex: 1;">
                        –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å
                    </button>
                    <button type="button" onclick="closeAuthModal()" class="btn btn-secondary" style="flex: 1;">
                        –û—Ç–º–µ–Ω–∞
                    </button>
                </div>
                <div id="auth2FAError" class="auth-error" style="display: none;"></div>
            </div>
            
            <div id="authStep3" class="auth-step" style="display: none;">
                <div style="text-align: center;">
                    <div style="font-size: 3rem; margin: 20px 0;">‚úÖ</div>
                    <p style="font-size: 1.1rem; margin: 10px 0;">–ê–≥–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω!</p>
                    <p style="font-weight: bold; color: #2ecc71;" id="authUserInfo"></p>
                    <button type="button" onclick="closeAuthModal()" class="btn btn-primary" style="margin-top: 15px;">
                        –ó–∞–∫—Ä—ã—Ç—å
                    </button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>

