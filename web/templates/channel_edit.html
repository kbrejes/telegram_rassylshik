<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% if is_new %}–°–æ–∑–¥–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞{% else %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞{% endif %} - Job Notification Bot</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>{% if is_new %}‚ûï –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞{% else %}‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞{% endif %}</h1>
            <p>–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∫–∞–Ω–∞–ª –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –≤–∞–∫–∞–Ω—Å–∏—è—Ö</p>
        </div>

        <div class="card">
            <a href="/" class="button button-secondary button-small" style="margin-bottom: 1rem;">
                ‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É
            </a>

            <form id="channel-form">
                <div class="form-group">
                    <label for="name">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞ *</label>
                    <input 
                        type="text" 
                        id="name" 
                        name="name" 
                        class="input" 
                        placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: Python —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∏"
                        value="{% if channel %}{{ channel.name }}{% endif %}"
                        required
                    >
                    <span class="help-text">–£–¥–æ–±–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏</span>
                </div>

                <div class="form-group">
                    <label for="telegram_id">ID Telegram –∫–∞–Ω–∞–ª–∞/—á–∞—Ç–∞ *</label>
                    <input 
                        type="text" 
                        id="telegram_id" 
                        name="telegram_id" 
                        class="input" 
                        placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: -1001234567890"
                        value="{% if channel %}{{ channel.telegram_id }}{% endif %}"
                        required
                    >
                    <span class="help-text">
                        ID –∫–∞–Ω–∞–ª–∞ –∫—É–¥–∞ –±—É–¥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å—Å—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è. 
                        –ü–æ–ª—É—á–∏—Ç—å –º–æ–∂–Ω–æ —á–µ—Ä–µ–∑ @getmyid_bot
                    </span>
                </div>

                <div class="form-group">
                    <label for="input_sources">–ò—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ *</label>
                    <textarea 
                        id="input_sources" 
                        name="input_sources" 
                        class="input textarea" 
                        placeholder="@channel1&#10;@channel2&#10;@channel3"
                        required
                    >{% if channel %}{{ channel.input_sources|join('\n') }}{% endif %}</textarea>
                    <span class="help-text">
                        –°–ø–∏—Å–æ–∫ –∫–∞–Ω–∞–ª–æ–≤ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ (–ø–æ –æ–¥–Ω–æ–º—É –Ω–∞ —Å—Ç—Ä–æ–∫—É).
                        –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å @username –∏–ª–∏ ID –∫–∞–Ω–∞–ª–∞.
                    </span>
                </div>

                <div class="form-group">
                    <label for="include_keywords">–í–∫–ª—é—á–∞—é—â–∏–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞</label>
                    <textarea 
                        id="include_keywords" 
                        name="include_keywords" 
                        class="input textarea" 
                        placeholder="python&#10;django&#10;flask"
                    >{% if channel %}{{ channel.filters.include_keywords|join('\n') }}{% endif %}</textarea>
                    <span class="help-text">
                        –ï—Å–ª–∏ –æ—Å—Ç–∞–≤–∏—Ç—å –ø—É—Å—Ç—ã–º - –±—É–¥—É—Ç –ø—Ä–∏—Ö–æ–¥–∏—Ç—å –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ (–Ω–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è). 
                        –ï—Å–ª–∏ –∑–∞–ø–æ–ª–Ω–∏—Ç—å - —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –∏–∑ —ç—Ç–∏—Ö —Å–ª–æ–≤.
                    </span>
                </div>

                <div class="form-group">
                    <label for="exclude_keywords">–ò—Å–∫–ª—é—á–∞—é—â–∏–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞</label>
                    <textarea 
                        id="exclude_keywords" 
                        name="exclude_keywords" 
                        class="input textarea" 
                        placeholder="junior&#10;—Å—Ç–∞–∂–µ—Ä&#10;trainee"
                    >{% if channel %}{{ channel.filters.exclude_keywords|join('\n') }}{% endif %}</textarea>
                    <span class="help-text">
                        –°–æ–æ–±—â–µ–Ω–∏—è —Å —ç—Ç–∏–º–∏ —Å–ª–æ–≤–∞–º–∏ –±—É–¥—É—Ç –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω—ã (–ø–æ –æ–¥–Ω–æ–º—É –Ω–∞ —Å—Ç—Ä–æ–∫—É)
                    </span>
                </div>

                <div class="form-group">
                    <label>
                        <input 
                            type="checkbox" 
                            id="enabled" 
                            name="enabled" 
                            {% if is_new or (channel and channel.enabled) %}checked{% endif %}
                        >
                        –ö–∞–Ω–∞–ª –∞–∫—Ç–∏–≤–µ–Ω
                    </label>
                    <span class="help-text">
                        –û—Ç–∫–ª—é—á–∏—Ç–µ –µ—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ –≤—Ä–µ–º–µ–Ω–Ω–æ –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
                    </span>
                </div>

                <hr style="margin: 2rem 0; border: none; border-top: 2px solid #e0e0e0;">

                <h3 style="margin-bottom: 1rem;">ü§ñ CRM –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å</h3>

                <div class="form-group">
                    <label>
                        <input 
                            type="checkbox" 
                            id="crm_enabled" 
                            name="crm_enabled" 
                            {% if channel and channel.crm_enabled %}checked{% endif %}
                            onchange="toggleCrmFields()"
                        >
                        –í–∫–ª—é—á–∏—Ç—å CRM (–∞–≤—Ç–æ–æ—Ç–≤–µ—Ç—ã + —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏—è –≤ —Ç–æ–ø–∏–∫–∏)
                    </label>
                    <span class="help-text">
                        –ë–æ—Ç –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–∫–ª–∏–∫–∞—Ç—å—Å—è –Ω–∞ –≤–∞–∫–∞–Ω—Å–∏–∏ –∏ —Å–æ–∑–¥–∞–≤–∞—Ç—å —Ç–æ–ø–∏–∫–∏ –≤ CRM –≥—Ä—É–ø–ø–µ
                    </span>
                </div>

                <div id="crm-fields" style="display: none;">
                    <div class="form-group">
                        <label for="crm_group_id">ID CRM –≥—Ä—É–ø–ø—ã —Å —Ç–æ–ø–∏–∫–∞–º–∏</label>
                        <input 
                            type="text" 
                            id="crm_group_id" 
                            name="crm_group_id" 
                            class="input" 
                            placeholder="-1001234567890"
                            value="{% if channel %}{{ channel.crm_group_id if channel.crm_group_id else '' }}{% endif %}"
                        >
                        <span class="help-text">
                            ID –≥—Ä—É–ø–ø—ã –≥–¥–µ –±—É–¥—É—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å—Å—è —Ç–æ–ø–∏–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–æ–Ω—Ç–∞–∫—Ç–∞.
                            –ì—Ä—É–ø–ø–∞ –¥–æ–ª–∂–Ω–∞ –∏–º–µ—Ç—å –≤–∫–ª—é—á–µ–Ω–Ω—ã–µ —Ç–µ–º—ã (Topics).
                        </span>
                    </div>

                    <div class="form-group">
                        <label>–ê–≥–µ–Ω—Ç—ã –¥–ª—è –∞–≤—Ç–æ–æ—Ç–≤–µ—Ç–æ–≤</label>
                        <div id="agents-list">
                            {% if channel and channel.agents %}
                                {% for agent in channel.agents %}
                                <div class="agent-item" style="border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 5px;">
                                    <div style="display: flex; gap: 15px; align-items: end;">
                                        <div style="flex: 1;">
                                            <label>–¢–µ–ª–µ—Ñ–æ–Ω</label>
                                            <input type="text" class="input agent-phone" placeholder="+79991234567" value="{{ agent.phone }}" required>
                                        </div>
                                        <div style="flex: 1;">
                                            <label>–ò–º—è —Å–µ—Å—Å–∏–∏</label>
                                            <input type="text" class="input agent-session" placeholder="agent_1" value="{{ agent.session_name }}" required>
                                        </div>
                                        <button type="button" class="btn btn-danger" onclick="removeAgent(this)">–£–¥–∞–ª–∏—Ç—å</button>
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                                <!-- Backward compatibility: show old format if exists -->
                                {% if channel and channel.agent_phone %}
                                <div class="agent-item" style="border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 5px;">
                                    <div style="display: flex; gap: 15px; align-items: end;">
                                        <div style="flex: 1;">
                                            <label>–¢–µ–ª–µ—Ñ–æ–Ω</label>
                                            <input type="text" class="input agent-phone" placeholder="+79991234567" value="{{ channel.agent_phone }}" required>
                                        </div>
                                        <div style="flex: 1;">
                                            <label>–ò–º—è —Å–µ—Å—Å–∏–∏</label>
                                            <input type="text" class="input agent-session" placeholder="agent_1" value="{{ channel.agent_session_name }}" required>
                                        </div>
                                        <button type="button" class="btn btn-danger" onclick="removeAgent(this)">–£–¥–∞–ª–∏—Ç—å</button>
                                    </div>
                                </div>
                                {% endif %}
                            {% endif %}
                        </div>
                        <button type="button" class="btn btn-secondary" onclick="addAgent()" style="margin-top: 10px;">
                            + –î–æ–±–∞–≤–∏—Ç—å –∞–≥–µ–Ω—Ç–∞
                        </button>
                        <span class="help-text">
                            –ù–µ—Å–∫–æ–ª—å–∫–æ –∞–≥–µ–Ω—Ç–æ–≤ –ø–æ–∑–≤–æ–ª—è—é—Ç –∏–∑–±–µ–∂–∞—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π Telegram API. 
                            –ü—Ä–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ –æ–¥–Ω–æ–≥–æ –∞–≥–µ–Ω—Ç–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å–ª–µ–¥—É—é—â–∏–π.
                        </span>
                        
                        <!-- Hidden fields for backward compatibility -->
                        <input type="hidden" name="agent_phone" value="{% if channel %}{{ channel.agent_phone }}{% endif %}">
                        <input type="hidden" name="agent_session_name" value="{% if channel %}{{ channel.agent_session_name }}{% endif %}">
                    </div>

                    <div class="form-group">
                        <label>
                            <input 
                                type="checkbox" 
                                id="auto_response_enabled" 
                                name="auto_response_enabled" 
                                {% if channel and channel.auto_response_enabled %}checked{% endif %}
                            >
                            –í–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–æ—Ç–≤–µ—Ç—ã
                        </label>
                        <span class="help-text">
                            –ê–≥–µ–Ω—Ç –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞ –≤–∞–∫–∞–Ω—Å–∏—é
                        </span>
                    </div>

                    <div class="form-group">
                        <label for="auto_response_template">–®–∞–±–ª–æ–Ω –∞–≤—Ç–æ–æ—Ç–≤–µ—Ç–∞</label>
                        <textarea 
                            id="auto_response_template" 
                            name="auto_response_template" 
                            class="input textarea" 
                            placeholder="–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ó–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–ª–∞ –≤–∞—à–∞ –≤–∞–∫–∞–Ω—Å–∏—è. –†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –ø–æ–¥—Ä–æ–±–Ω–µ–µ?"
                        >{% if channel %}{{ channel.auto_response_template }}{% endif %}</textarea>
                        <span class="help-text">
                            –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –∫–æ—Ç–æ—Ä—ã–π –∞–≥–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç —Ä–∞–±–æ—Ç–æ–¥–∞—Ç–µ–ª—é
                        </span>
                    </div>
                </div>

                <div class="alert alert-info">
                    <strong>üí° –°–æ–≤–µ—Ç:</strong> –ù–∞—á–Ω–∏—Ç–µ —Å –Ω–µ–±–æ–ª—å—à–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤,
                    –∑–∞—Ç–µ–º –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ —Ä–∞—Å—à–∏—Ä—è–π—Ç–µ —Å–ø–∏—Å–æ–∫ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤.
                </div>

                <div class="button-group">
                    <button type="submit" class="button button-primary">
                        {% if is_new %}‚úì –°–æ–∑–¥–∞—Ç—å –∫–∞–Ω–∞–ª{% else %}‚úì –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è{% endif %}
                    </button>
                    <a href="/" class="button button-secondary">–û—Ç–º–µ–Ω–∞</a>
                </div>
            </form>
        </div>
    </div>

    <div class="loading-overlay" id="loading">
        <div class="spinner"></div>
        <p>–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...</p>
    </div>

    <script>
        const isNew = {{ 'true' if is_new else 'false' }};
        const channelId = {% if channel %}'{{ channel.id }}'{% else %}null{% endif %};

        // Toggle CRM fields visibility
        function toggleCrmFields() {
            const crmEnabled = document.getElementById('crm_enabled').checked;
            const crmFields = document.getElementById('crm-fields');
            crmFields.style.display = crmEnabled ? 'block' : 'none';
        }

        let currentAgentAuth = null;

        async function addAgent() {
            const agentsList = document.getElementById('agents-list');
            const agentCount = agentsList.children.length + 1;
            
            const phone = prompt("üì± –í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∞–≥–µ–Ω—Ç–∞ (—Å –∫–æ–¥–æ–º —Å—Ç—Ä–∞–Ω—ã, –Ω–∞–ø—Ä–∏–º–µ—Ä +79991234567):");
            if (!phone) return;
            
            const sessionName = prompt("üìÅ –í–≤–µ–¥–∏—Ç–µ –∏–º—è —Å–µ—Å—Å–∏–∏ –¥–ª—è –∞–≥–µ–Ω—Ç–∞:", `agent_${agentCount}`);
            if (!sessionName) return;
            
            currentAgentAuth = { phone, sessionName };
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            showAuthModal();
            
            // –ò–Ω–∏—Ü–∏–∏—Ä—É–µ–º –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é
            try {
                const response = await fetch('/api/agents/init', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        phone: phone, 
                        session_name: sessionName 
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    if (data.needs_code) {
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –¥–ª—è –≤–≤–æ–¥–∞ –∫–æ–¥–∞
                        showAuthStep2();
                    } else if (data.already_authenticated) {
                        // –£–∂–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
                        showAuthStep3(data.user_info);
                        setTimeout(() => {
                            addAgentToList(phone, sessionName);
                            closeAuthModal();
                        }, 2000);
                    }
                } else {
                    alert(`‚ùå ${data.message}`);
                    closeAuthModal();
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É');
                closeAuthModal();
            }
        }
        
        function addAgentToList(phone, sessionName) {
            const agentsList = document.getElementById('agents-list');
            
            const agentItem = document.createElement('div');
            agentItem.className = 'agent-item';
            agentItem.style.cssText = 'border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 5px;';
            
            agentItem.innerHTML = `
                <div style="display: flex; gap: 15px; align-items: end;">
                    <div style="flex: 1;">
                        <label>–¢–µ–ª–µ—Ñ–æ–Ω</label>
                        <input type="text" class="input agent-phone" placeholder="+79991234567" value="${phone}" readonly>
                    </div>
                    <div style="flex: 1;">
                        <label>–ò–º—è —Å–µ—Å—Å–∏–∏</label>
                        <input type="text" class="input agent-session" placeholder="agent_1" value="${sessionName}" readonly>
                    </div>
                    <button type="button" class="btn btn-danger" onclick="removeAgent(this)">–£–¥–∞–ª–∏—Ç—å</button>
                </div>
            `;
            
            agentsList.appendChild(agentItem);
        }
        
        async function verifyAgentCode() {
            const code = document.getElementById('authCode').value.trim();
            if (!code) {
                alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥');
                return;
            }
            
            const verifyBtn = event.target;
            verifyBtn.disabled = true;
            verifyBtn.textContent = '–ü—Ä–æ–≤–µ—Ä–∫–∞...';
            
            try {
                const response = await fetch('/api/agents/verify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_name: currentAgentAuth.sessionName,
                        code: code
                    })
                });
                
                const data = await response.json();
                
                if (data.success && data.authenticated) {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Å–ø–µ—Ö
                    showAuthStep3(data.user_info);
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –∞–≥–µ–Ω—Ç–∞ –≤ —Å–ø–∏—Å–æ–∫
                    setTimeout(() => {
                        addAgentToList(currentAgentAuth.phone, currentAgentAuth.sessionName);
                        closeAuthModal();
                    }, 2000);
                } else if (data.needs_password) {
                    // –¢—Ä–µ–±—É–µ—Ç—Å—è 2FA –ø–∞—Ä–æ–ª—å
                    showAuthStep2_5();
                } else {
                    document.getElementById('authError').textContent = data.message;
                    document.getElementById('authError').style.display = 'block';
                    verifyBtn.disabled = false;
                    verifyBtn.textContent = '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å';
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                document.getElementById('authError').textContent = '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É';
                document.getElementById('authError').style.display = 'block';
                verifyBtn.disabled = false;
                verifyBtn.textContent = '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å';
            }
        }
        
        function showAuthModal() {
            document.getElementById('agentAuthModal').style.display = 'flex';
            document.getElementById('authPhone').textContent = currentAgentAuth.phone;
            document.getElementById('authStep1').style.display = 'block';
            document.getElementById('authStep2').style.display = 'none';
            document.getElementById('authStep2_5').style.display = 'none';
            document.getElementById('authStep3').style.display = 'none';
        }
        
        function showAuthStep2() {
            document.getElementById('authStep1').style.display = 'none';
            document.getElementById('authStep2').style.display = 'block';
            document.getElementById('authPhoneConfirm').textContent = currentAgentAuth.phone;
            document.getElementById('authCode').value = '';
            document.getElementById('authError').style.display = 'none';
        }
        
        function showAuthStep2_5() {
            document.getElementById('authStep1').style.display = 'none';
            document.getElementById('authStep2').style.display = 'none';
            document.getElementById('authStep2_5').style.display = 'block';
            document.getElementById('authStep3').style.display = 'none';
            document.getElementById('auth2FAPassword').value = '';
            document.getElementById('auth2FAError').style.display = 'none';
        }
        
        function showAuthStep3(userInfo) {
            document.getElementById('authStep1').style.display = 'none';
            document.getElementById('authStep2').style.display = 'none';
            document.getElementById('authStep2_5').style.display = 'none';
            document.getElementById('authStep3').style.display = 'block';
            document.getElementById('authUserInfo').textContent = `${userInfo.name} (@${userInfo.username})`;
        }
        
        async function verify2FAPassword() {
            const password = document.getElementById('auth2FAPassword').value.trim();
            if (!password) {
                alert('–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å');
                return;
            }
            
            const verifyBtn = event.target;
            verifyBtn.disabled = true;
            verifyBtn.textContent = '–ü—Ä–æ–≤–µ—Ä–∫–∞...';
            
            try {
                const response = await fetch('/api/agents/verify-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_name: currentAgentAuth.sessionName,
                        password: password
                    })
                });
                
                const data = await response.json();
                
                if (data.success && data.authenticated) {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Å–ø–µ—Ö
                    showAuthStep3(data.user_info);
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –∞–≥–µ–Ω—Ç–∞ –≤ —Å–ø–∏—Å–æ–∫
                    setTimeout(() => {
                        addAgentToList(currentAgentAuth.phone, currentAgentAuth.sessionName);
                        closeAuthModal();
                    }, 2000);
                } else {
                    document.getElementById('auth2FAError').textContent = data.message;
                    document.getElementById('auth2FAError').style.display = 'block';
                    verifyBtn.disabled = false;
                    verifyBtn.textContent = '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å';
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                document.getElementById('auth2FAError').textContent = '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É';
                document.getElementById('auth2FAError').style.display = 'block';
                verifyBtn.disabled = false;
                verifyBtn.textContent = '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å';
            }
        }
        
        function closeAuthModal() {
            document.getElementById('agentAuthModal').style.display = 'none';
            currentAgentAuth = null;
        }

        async function removeAgent(button) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å –∞–≥–µ–Ω—Ç–∞?')) {
                return;
            }
            
            const agentItem = button.closest('.agent-item');
            const phone = agentItem.querySelector('.agent-phone').value.trim();
            const sessionName = agentItem.querySelector('.agent-session').value.trim();
            
            // –£–¥–∞–ª—è–µ–º –∏–∑ DOM
            agentItem.remove();
            
            // –ï—Å–ª–∏ –∫–∞–Ω–∞–ª —É–∂–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω, –æ–±–Ω–æ–≤–ª—è–µ–º —á–µ—Ä–µ–∑ API
            // channelId –æ–ø—Ä–µ–¥–µ–ª—ë–Ω –≤ –Ω–∞—á–∞–ª–µ —Å–∫—Ä–∏–ø—Ç–∞
            if (channelId && channelId !== 'new') {
                try {
                    // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –∫–∞–Ω–∞–ª–∞
                    const response = await fetch(`/api/channels/${channelId}`);
                    if (!response.ok) {
                        throw new Error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∫–∞–Ω–∞–ª–∞');
                    }
                    const channelData = await response.json();
                    
                    if (channelData.success && channelData.channel) {
                        // –£–¥–∞–ª—è–µ–º –∞–≥–µ–Ω—Ç–∞ –∏–∑ —Å–ø–∏—Å–∫–∞
                        const updatedAgents = (channelData.channel.agents || []).filter(
                            a => !(a.phone === phone && a.session_name === sessionName)
                        );
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–Ω–∞–ª —á–µ—Ä–µ–∑ API
                        const updateResponse = await fetch(`/api/channels/${channelId}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                agents: updatedAgents
                            })
                        });
                        
                        if (!updateResponse.ok) {
                            throw new Error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–∞–Ω–∞–ª–∞');
                        }
                        
                        const updateData = await updateResponse.json();
                        if (updateData.success) {
                            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏
                            const notification = document.createElement('div');
                            notification.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #4caf50; color: white; padding: 15px 20px; border-radius: 5px; z-index: 10000; box-shadow: 0 4px 6px rgba(0,0,0,0.1);';
                            notification.textContent = '‚úÖ –ê–≥–µ–Ω—Ç —É–¥–∞–ª—ë–Ω –∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã';
                            document.body.appendChild(notification);
                            
                            setTimeout(() => {
                                notification.remove();
                            }, 3000);
                        }
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∞–≥–µ–Ω—Ç–∞:', error);
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ, –Ω–æ –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç –≤ DOM
                    alert('‚ö†Ô∏è –ê–≥–µ–Ω—Ç —É–¥–∞–ª—ë–Ω –∏–∑ —Ñ–æ—Ä–º—ã, –Ω–æ –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–∂–º–∏—Ç–µ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å" –≤—Ä—É—á–Ω—É—é.');
                }
            }
        }

        function collectAgents() {
            const agents = [];
            const agentItems = document.querySelectorAll('.agent-item');
            
            agentItems.forEach(item => {
                const phone = item.querySelector('.agent-phone').value.trim();
                const sessionName = item.querySelector('.agent-session').value.trim();
                
                if (phone && sessionName) {
                    agents.push({
                        phone: phone,
                        session_name: sessionName
                    });
                }
            });
            
            return agents;
        }

        // Initialize CRM fields visibility on page load
        document.addEventListener('DOMContentLoaded', function() {
            toggleCrmFields();
            
            // –ï—Å–ª–∏ –Ω–µ—Ç –∞–≥–µ–Ω—Ç–æ–≤, –¥–æ–±–∞–≤–ª—è–µ–º –æ–¥–∏–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            const agentsList = document.getElementById('agents-list');
            if (agentsList.children.length === 0) {
                addAgent();
            }
        });

        document.getElementById('channel-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const loading = document.getElementById('loading');
            loading.classList.add('active');

            try {
                // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã
                const formData = {
                    name: document.getElementById('name').value.trim(),
                    telegram_id: parseInt(document.getElementById('telegram_id').value.trim()),
                    input_sources: document.getElementById('input_sources').value
                        .split('\n')
                        .map(s => s.trim())
                        .filter(s => s.length > 0),
                    include_keywords: document.getElementById('include_keywords').value
                        .split('\n')
                        .map(s => s.trim())
                        .filter(s => s.length > 0),
                    exclude_keywords: document.getElementById('exclude_keywords').value
                        .split('\n')
                        .map(s => s.trim())
                        .filter(s => s.length > 0),
                    enabled: document.getElementById('enabled').checked,
                    
                    // CRM –ø–æ–ª—è
                    crm_enabled: document.getElementById('crm_enabled').checked,
                    crm_group_id: parseInt(document.getElementById('crm_group_id').value.trim()) || 0,
                    agents: collectAgents(),
                    auto_response_enabled: document.getElementById('auto_response_enabled').checked,
                    auto_response_template: document.getElementById('auto_response_template').value.trim(),
                    
                    // Backward compatibility - –ø—É—Å—Ç—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è, —Ç–∞–∫ –∫–∞–∫ —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è agents[]
                    agent_phone: "",
                    agent_session_name: ""
                };

                // –í–∞–ª–∏–¥–∞—Ü–∏—è
                if (!formData.name) {
                    alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞');
                    loading.classList.remove('active');
                    return;
                }

                if (!formData.telegram_id || isNaN(formData.telegram_id)) {
                    alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π ID Telegram –∫–∞–Ω–∞–ª–∞');
                    loading.classList.remove('active');
                    return;
                }

                if (formData.input_sources.length === 0) {
                    alert('–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –∏—Å—Ç–æ—á–Ω–∏–∫ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞');
                    loading.classList.remove('active');
                    return;
                }

                // –í–∞–ª–∏–¥–∞—Ü–∏—è CRM –∞–≥–µ–Ω—Ç–æ–≤
                if (formData.crm_enabled && formData.agents.length === 0) {
                    alert('–ü—Ä–∏ –≤–∫–ª—é—á–µ–Ω–Ω–æ–º CRM –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–æ–±–∞–≤–∏—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–≥–æ –∞–≥–µ–Ω—Ç–∞');
                    loading.classList.remove('active');
                    return;
                }

                // –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞
                const url = isNew ? '/api/channels' : `/api/channels/${channelId}`;
                const method = isNew ? 'POST' : 'PUT';

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (data.success) {
                    alert(isNew ? '–ö–∞–Ω–∞–ª —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!' : '–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!');
                    window.location.href = '/';
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + (data.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                    loading.classList.remove('active');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏');
                loading.classList.remove('active');
            }
        });
    </script>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∞–≥–µ–Ω—Ç–∞ -->
    <div id="agentAuthModal" class="auth-modal">
        <div class="auth-modal-content">
            <h3 style="margin-top: 0;">üîê –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∞–≥–µ–Ω—Ç–∞</h3>
            
            <div id="authStep1" class="auth-step">
                <p>–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞–≥–µ–Ω—Ç–∞ <strong id="authPhone"></strong>...</p>
                <div class="loading-spinner">‚è≥</div>
            </div>
            
            <div id="authStep2" class="auth-step" style="display: none;">
                <p>‚úâÔ∏è –ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ <strong id="authPhoneConfirm"></strong></p>
                <div class="form-group">
                    <label>–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥:</label>
                    <input type="text" id="authCode" class="input" placeholder="12345" maxlength="6" style="text-align: center; font-size: 1.2rem;">
                </div>
                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <button type="button" onclick="verifyAgentCode()" class="btn btn-primary" style="flex: 1;">
                        –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å
                    </button>
                    <button type="button" onclick="closeAuthModal()" class="btn btn-secondary" style="flex: 1;">
                        –û—Ç–º–µ–Ω–∞
                    </button>
                </div>
                <div id="authError" class="auth-error" style="display: none;"></div>
            </div>
            
            <div id="authStep2_5" class="auth-step" style="display: none;">
                <p>üîê –¢—Ä–µ–±—É–µ—Ç—Å—è –ø–∞—Ä–æ–ª—å –¥–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏</p>
                <div class="form-group">
                    <label>–í–≤–µ–¥–∏—Ç–µ 2FA –ø–∞—Ä–æ–ª—å:</label>
                    <input type="password" id="auth2FAPassword" class="input" placeholder="–í–∞—à –ø–∞—Ä–æ–ª—å" style="text-align: center; font-size: 1.2rem;">
                </div>
                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <button type="button" onclick="verify2FAPassword()" class="btn btn-primary" style="flex: 1;">
                        –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å
                    </button>
                    <button type="button" onclick="closeAuthModal()" class="btn btn-secondary" style="flex: 1;">
                        –û—Ç–º–µ–Ω–∞
                    </button>
                </div>
                <div id="auth2FAError" class="auth-error" style="display: none;"></div>
            </div>
            
            <div id="authStep3" class="auth-step" style="display: none;">
                <div style="text-align: center;">
                    <div style="font-size: 3rem; margin: 20px 0;">‚úÖ</div>
                    <p style="font-size: 1.1rem; margin: 10px 0;">–ê–≥–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω!</p>
                    <p style="font-weight: bold; color: #2ecc71;" id="authUserInfo"></p>
                    <button type="button" onclick="closeAuthModal()" class="btn btn-primary" style="margin-top: 15px;">
                        –ó–∞–∫—Ä—ã—Ç—å
                    </button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>

