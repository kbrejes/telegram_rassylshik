<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Notification Bot - –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        .auth-container {
            max-width: 500px;
            margin: 0 auto;
        }

        .auth-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .auth-step {
            display: none;
        }

        .auth-step.active {
            display: block;
        }

        .auth-icon {
            font-size: 4rem;
            text-align: center;
            margin-bottom: 1rem;
        }

        .auth-title {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .auth-title h2 {
            color: var(--text);
            margin-bottom: 0.5rem;
        }

        .auth-title p {
            color: var(--text-light);
        }

        .status-badge {
            display: inline-block;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 600;
            margin-bottom: 1.5rem;
        }

        .status-badge.waiting {
            background: #fff3e0;
            color: #e65100;
        }

        .status-badge.success {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .status-badge.error {
            background: #ffebee;
            color: #c62828;
        }

        .code-input {
            text-align: center;
            font-size: 1.5rem;
            letter-spacing: 0.5rem;
            font-weight: bold;
        }

        .user-info {
            background: #f9f9f9;
            border-radius: 8px;
            padding: 1.5rem;
            margin-top: 1rem;
        }

        .user-info-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border);
        }

        .user-info-item:last-child {
            border-bottom: none;
        }

        .user-info-label {
            color: var(--text-light);
        }

        .user-info-value {
            font-weight: 600;
            color: var(--text);
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-content {
            text-align: center;
        }

        .nav-link {
            display: block;
            text-align: center;
            margin-top: 1rem;
            color: white;
            text-decoration: none;
        }

        .nav-link:hover {
            text-decoration: underline;
        }

        .flood-wait-timer {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--warning);
            text-align: center;
            margin: 1rem 0;
        }
    </style>
</head>
<body>
    <div class="container auth-container">
        <div class="header">
            <h1>Bot Authorization</h1>
            <nav class="nav-menu">
                <a href="/">Channels</a>
                <a href="/agents">Agents</a>
                <a href="/ai-stats">AI Stats</a>
                <a href="/auth" class="active">Bot Auth</a>
            </nav>
        </div>

        <!-- Bot Connection Status -->
        <div class="auth-card" style="margin-bottom: 1rem; padding: 1rem;">
            <div style="display: flex; align-items: center; gap: 10px;">
                <span class="status-dot disconnected" id="bot-connection-dot"></span>
                <div>
                    <strong id="bot-connection-status">Checking...</strong>
                    <div style="font-size: 0.85rem; color: var(--text-light);" id="bot-connection-info"></div>
                </div>
            </div>
        </div>

        <div class="auth-card">
            <!-- Step 0: Check Status -->
            <div id="step-check" class="auth-step active">
                <div class="auth-icon">
                    <div class="spinner"></div>
                </div>
                <div class="auth-title">
                    <h2>–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞...</h2>
                    <p>–ü–æ–¥–æ–∂–¥–∏—Ç–µ, –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–µ—Å—Å–∏–∏</p>
                </div>
            </div>

            <!-- Step 1: Enter Phone -->
            <div id="step-phone" class="auth-step">
                <div class="auth-icon">
                    <span>üì±</span>
                </div>
                <div class="auth-title">
                    <h2>–í—Ö–æ–¥ –≤ Telegram</h2>
                    <p>–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –±–æ—Ç–∞</p>
                </div>

                <form id="phone-form">
                    <div class="form-group">
                        <label for="phone">–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</label>
                        <input type="tel" id="phone" class="input" placeholder="+79991234567" required>
                        <span class="help-text">–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –≤ –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ</span>
                    </div>
                    <button type="submit" class="button button-primary" style="width: 100%;">
                        –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥
                    </button>
                </form>

                <div id="phone-error" class="auth-error" style="display: none;"></div>
            </div>

            <!-- Step 2: Enter Code -->
            <div id="step-code" class="auth-step">
                <div class="auth-icon">
                    <span>üîê</span>
                </div>
                <div class="auth-title">
                    <h2>–ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è</h2>
                    <p>–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∏–∑ Telegram</p>
                </div>

                <form id="code-form">
                    <div class="form-group">
                        <label for="code">–ö–æ–¥ –∏–∑ Telegram</label>
                        <input type="text" id="code" class="input code-input" placeholder="12345" maxlength="6" required>
                        <span class="help-text">–ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ Telegram</span>
                    </div>
                    <button type="submit" class="button button-primary" style="width: 100%;">
                        –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å
                    </button>
                </form>

                <div id="code-error" class="auth-error" style="display: none;"></div>
            </div>

            <!-- Step 3: Enter 2FA Password -->
            <div id="step-password" class="auth-step">
                <div class="auth-icon">
                    <span>üîë</span>
                </div>
                <div class="auth-title">
                    <h2>–î–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è</h2>
                    <p>–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å 2FA</p>
                </div>

                <form id="password-form">
                    <div class="form-group">
                        <label for="password">–ü–∞—Ä–æ–ª—å 2FA</label>
                        <input type="password" id="password" class="input" placeholder="–í–∞—à –ø–∞—Ä–æ–ª—å" required>
                    </div>
                    <button type="submit" class="button button-primary" style="width: 100%;">
                        –í–æ–π—Ç–∏
                    </button>
                </form>

                <div id="password-error" class="auth-error" style="display: none;"></div>
            </div>

            <!-- Step 4: Success -->
            <div id="step-success" class="auth-step">
                <div class="auth-icon">
                    <span>‚úÖ</span>
                </div>
                <div class="auth-title">
                    <span class="status-badge success">–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω</span>
                    <h2>–ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω!</h2>
                    <p>–ë–æ—Ç –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ</p>
                </div>

                <div class="user-info" id="user-info">
                    <!-- User info will be populated here -->
                </div>

                <a href="/" class="button button-primary" style="width: 100%; margin-top: 1.5rem; text-align: center;">
                    –ü–µ—Ä–µ–π—Ç–∏ –∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é
                </a>
            </div>

            <!-- Step 5: Flood Wait -->
            <div id="step-flood" class="auth-step">
                <div class="auth-icon">
                    <span>‚è≥</span>
                </div>
                <div class="auth-title">
                    <span class="status-badge waiting">–û–∂–∏–¥–∞–Ω–∏–µ</span>
                    <h2>–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤</h2>
                    <p>Telegram –æ–≥—Ä–∞–Ω–∏—á–∏–ª —á–∞—Å—Ç–æ—Ç—É –∑–∞–ø—Ä–æ—Å–æ–≤</p>
                </div>

                <div class="flood-wait-timer" id="flood-timer">
                    <!-- Timer will be shown here -->
                </div>

                <p style="text-align: center; color: var(--text-light);">
                    –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Å–µ—Å—Å–∏—é
                </p>
            </div>
        </div>

        <a href="/" class="nav-link">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é –∫–∞–Ω–∞–ª–∞–º–∏</a>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <p style="margin-top: 1rem;">–ü–æ–¥–æ–∂–¥–∏—Ç–µ...</p>
        </div>
    </div>

    <script>
        // State
        let currentPhone = '';

        // Helper functions
        function showStep(stepId) {
            document.querySelectorAll('.auth-step').forEach(step => {
                step.classList.remove('active');
            });
            document.getElementById(stepId).classList.add('active');
        }

        function showLoading(show) {
            document.getElementById('loading-overlay').classList.toggle('active', show);
        }

        function showError(containerId, message) {
            const container = document.getElementById(containerId);
            container.textContent = message;
            container.style.display = 'block';
        }

        function hideError(containerId) {
            document.getElementById(containerId).style.display = 'none';
        }

        function displayUserInfo(userInfo) {
            const container = document.getElementById('user-info');
            container.innerHTML = `
                <div class="user-info-item">
                    <span class="user-info-label">–ò–º—è</span>
                    <span class="user-info-value">${userInfo.name || 'N/A'}</span>
                </div>
                <div class="user-info-item">
                    <span class="user-info-label">Username</span>
                    <span class="user-info-value">@${userInfo.username || 'N/A'}</span>
                </div>
                <div class="user-info-item">
                    <span class="user-info-label">–¢–µ–ª–µ—Ñ–æ–Ω</span>
                    <span class="user-info-value">${userInfo.phone || 'N/A'}</span>
                </div>
                <div class="user-info-item">
                    <span class="user-info-label">ID</span>
                    <span class="user-info-value">${userInfo.id || 'N/A'}</span>
                </div>
            `;
        }

        function formatTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            return `${hours}—á ${minutes}–º ${secs}—Å`;
        }

        // Check initial status
        async function checkStatus() {
            try {
                const response = await fetch('/api/bot/auth/status');
                const data = await response.json();

                if (data.authenticated) {
                    displayUserInfo(data.user_info);
                    showStep('step-success');
                } else {
                    showStep('step-phone');
                }
            } catch (error) {
                console.error('Error checking status:', error);
                showStep('step-phone');
            }
        }

        // Handle phone form submission
        document.getElementById('phone-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            hideError('phone-error');

            const phone = document.getElementById('phone').value.trim();
            if (!phone) return;

            currentPhone = phone;
            showLoading(true);

            try {
                const response = await fetch('/api/bot/auth/init', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ phone: phone })
                });

                const data = await response.json();
                showLoading(false);

                if (data.success) {
                    if (data.already_authenticated) {
                        displayUserInfo(data.user_info);
                        showStep('step-success');
                    } else if (data.needs_code) {
                        showStep('step-code');
                    }
                } else {
                    if (data.flood_wait) {
                        showFloodWait(data.flood_wait);
                    } else {
                        showError('phone-error', data.message || '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–¥–∞');
                    }
                }
            } catch (error) {
                showLoading(false);
                console.error('Error:', error);
                showError('phone-error', '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
            }
        });

        // Handle code form submission
        document.getElementById('code-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            hideError('code-error');

            const code = document.getElementById('code').value.trim();
            if (!code) return;

            showLoading(true);

            try {
                const response = await fetch('/api/bot/auth/verify-code', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code: code })
                });

                const data = await response.json();
                showLoading(false);

                if (data.success) {
                    if (data.needs_password) {
                        showStep('step-password');
                    } else if (data.authenticated) {
                        displayUserInfo(data.user_info);
                        showStep('step-success');
                    }
                } else {
                    showError('code-error', data.message || '–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥');
                }
            } catch (error) {
                showLoading(false);
                console.error('Error:', error);
                showError('code-error', '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
            }
        });

        // Handle password form submission
        document.getElementById('password-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            hideError('password-error');

            const password = document.getElementById('password').value;
            if (!password) return;

            showLoading(true);

            try {
                const response = await fetch('/api/bot/auth/verify-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: password })
                });

                const data = await response.json();
                showLoading(false);

                if (data.success && data.authenticated) {
                    displayUserInfo(data.user_info);
                    showStep('step-success');
                } else {
                    showError('password-error', data.message || '–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å');
                }
            } catch (error) {
                showLoading(false);
                console.error('Error:', error);
                showError('password-error', '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
            }
        });

        // Show flood wait with timer
        function showFloodWait(seconds) {
            showStep('step-flood');

            const timerEl = document.getElementById('flood-timer');
            let remaining = seconds;

            function updateTimer() {
                if (remaining <= 0) {
                    showStep('step-phone');
                    return;
                }

                timerEl.textContent = formatTime(remaining);
                remaining--;
                setTimeout(updateTimer, 1000);
            }

            updateTimer();
        }

        // Check bot connection status
        async function checkBotConnection() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();

                const dot = document.getElementById('bot-connection-dot');
                const statusText = document.getElementById('bot-connection-status');
                const infoText = document.getElementById('bot-connection-info');

                const botStatus = data.status?.bot || {};
                const isConnected = botStatus.connected === true;
                const isAuthorized = botStatus.authorized === true;

                if (isConnected) {
                    dot.className = 'status-dot connected';
                    statusText.textContent = 'Bot Running';
                    const userInfo = botStatus.user_info;
                    if (userInfo) {
                        infoText.textContent = `${userInfo.first_name || ''} @${userInfo.username || 'N/A'}`;
                    } else {
                        infoText.textContent = isAuthorized ? 'Authorized' : '';
                    }
                } else {
                    dot.className = 'status-dot disconnected';
                    statusText.textContent = 'Bot Not Running';
                    infoText.textContent = 'Bot process is not active';
                }
            } catch (error) {
                document.getElementById('bot-connection-dot').className = 'status-dot disconnected';
                document.getElementById('bot-connection-status').textContent = 'Status Unknown';
                document.getElementById('bot-connection-info').textContent = 'Could not connect to API';
            }
        }

        // Initial checks
        checkStatus();
        checkBotConnection();

        // Refresh connection status every 5 seconds
        setInterval(checkBotConnection, 5000);
    </script>
</body>
</html>
