<!DOCTYPE html>
<html lang="en" class="h-full" x-data="{ darkMode: localStorage.getItem('darkMode') === 'true' }" x-init="$watch('darkMode', val => localStorage.setItem('darkMode', val))" :class="{ 'dark': darkMode }">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vacancy Details - Job Notification Bot</title>
    {% include 'partials/design_system.html' %}
    <script src="/static/js/cache.js"></script>
    <style>
        /* Collapse sidebar */
        #sidebar { transform: translateX(-100%) !important; position: fixed !important; }
        #sidebar.sidebar-open { transform: translateX(0) !important; }
        /* Tooltip */
        .tooltip-container { position: relative; display: inline-flex; }
        .tooltip-content {
            display: none;
            position: fixed;
            left: 12px;
            right: 12px;
            top: 60px;
            padding: 12px;
            background: #18181b;
            color: #fff;
            border-radius: 10px;
            font-size: 13px;
            line-height: 1.5;
            z-index: 9999;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            max-height: calc(var(--vh, 100vh) - 80px);
            overflow-y: auto;
        }
        .tooltip-container.active .tooltip-content { display: block; }
        @media (hover: hover) and (min-width: 768px) {
            .tooltip-content {
                /* Keep fixed positioning on desktop too to avoid overflow clipping */
                position: fixed;
                left: auto;
                right: auto;
                top: 60px;
                width: max-content;
                max-width: min(400px, calc(100vw - 24px));
            }
            .tooltip-container:hover .tooltip-content { display: block; }
        }
        /* Swipe animations */
        @keyframes slideOutLeft {
            from { transform: translateX(0); }
            to { transform: translateX(-100%); }
        }
        @keyframes slideOutRight {
            from { transform: translateX(0); }
            to { transform: translateX(100%); }
        }
        @keyframes slideInLeft {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
        @keyframes slideInRight {
            from { transform: translateX(-100%); }
            to { transform: translateX(0); }
        }
        .slide-out-left { animation: slideOutLeft 0.2s ease-out forwards; }
        .slide-out-right { animation: slideOutRight 0.2s ease-out forwards; }
        .slide-in-left { animation: slideInLeft 0.2s ease-out forwards; }
        .slide-in-right { animation: slideInRight 0.2s ease-out forwards; }
        #chat-container { will-change: transform; }
    </style>
    <script>
        // Fix mobile viewport height
        function setVh() {
            document.documentElement.style.setProperty('--vh', window.innerHeight + 'px');
        }
        setVh();
        window.addEventListener('resize', setVh);
    </script>
</head>
<body class="bg-gray-50 dark:bg-dark-950 transition-colors duration-200" style="height: var(--vh, 100vh); overflow: hidden;">
    <div class="flex" style="height: var(--vh, 100vh);">
        {% set active_page = 'channels' %}
        {% include 'partials/sidebar_new.html' %}

        <main class="flex-1 flex flex-col min-w-0 overflow-hidden" style="height: var(--vh, 100vh);">
            <header class="sticky top-0 z-30 flex items-center gap-4 px-4 py-3 bg-white dark:bg-dark-800 border-b border-gray-200 dark:border-dark-700">
                <button onclick="toggleSidebar()" class="p-2 -ml-2 rounded-lg hover:bg-gray-100 dark:hover:bg-dark-700">
                    <svg class="w-5 h-5 text-gray-600 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                    </svg>
                </button>
                <div class="flex items-center gap-2 flex-1 min-w-0 overflow-x-auto">
                    <div id="header-status-badge" class="flex items-center gap-2"></div>
                    <div id="agent-badge-container" class="flex-shrink-0"></div>
                </div>
                <a href="/" class="p-1.5 text-gray-400 hover:text-gray-600 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-dark-700 rounded-lg transition-colors" title="Close">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </a>
            </header>

            <div class="flex-1 flex flex-col p-4 lg:p-6 min-h-0 overflow-hidden">
                <div id="loading" class="flex items-center justify-center py-12 text-gray-400">
                    <svg class="w-5 h-5 animate-spin mr-2" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                    </svg>
                    Loading vacancy...
                </div>

                <div id="error" class="hidden text-center py-12">
                    <div class="text-red-500 mb-4">Failed to load vacancy</div>
                    <a href="/" class="text-accent hover:underline">Back to channels</a>
                </div>

                <div id="content" class="hidden flex-1 flex flex-col gap-4 min-h-0">
                    <!-- Contact tabs -->
                    <div id="contacts-tabs" class="flex gap-2 overflow-x-auto pb-2 flex-shrink-0"></div>

                    <!-- CRM Conversation -->
                        <div id="chat-container" class="bg-white dark:bg-dark-800 rounded-xl flex-1 flex flex-col min-h-[300px] lg:min-h-0 overflow-hidden">
                            <div id="conversation-header" class="px-4 py-3 border-b border-gray-100 dark:border-dark-700 flex items-center gap-3 flex-shrink-0">
                                <div id="contact-avatar" class="w-8 h-8 rounded-full bg-gray-200 dark:bg-dark-600 flex items-center justify-center text-xs font-medium text-gray-600 dark:text-gray-300"></div>
                                <span id="contact-name" class="text-sm font-medium text-gray-900 dark:text-white"></span>
                            </div>
                            <div id="message-log" class="flex-1 overflow-y-auto p-4 scrollbar-thin">
                                <div class="flex items-center justify-center py-6 text-sm text-gray-400 dark:text-gray-500">
                                    <svg class="w-4 h-4 animate-spin mr-2" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                    Loading conversation...
                                </div>
                            </div>
                            <div id="chat-input-container" class="hidden px-4 py-3 border-t border-gray-100 dark:border-dark-700 flex-shrink-0">
                                <!-- Agent selector -->
                                <div id="agent-selector-container" class="mb-2">
                                    <div class="flex items-center gap-2">
                                        <span class="text-xs text-gray-500 dark:text-gray-400">Send as:</span>
                                        <select id="agent-selector"
                                            class="flex-1 px-2 py-1.5 rounded-lg bg-gray-100 dark:bg-dark-700 text-gray-900 dark:text-white text-xs border-none focus:ring-2 focus:ring-accent outline-none">
                                            <option value="">Auto (best available)</option>
                                        </select>
                                        <button onclick="refreshAgents()" class="p-1.5 rounded-lg bg-gray-100 dark:bg-dark-700 hover:bg-gray-200 dark:hover:bg-dark-600 transition" title="Refresh agents">
                                            <svg id="refresh-agents-icon" class="w-3.5 h-3.5 text-gray-500 dark:text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                                <!-- Message input -->
                                <div class="flex gap-2">
                                    <input type="text" id="chat-message-input" placeholder="Type a message..."
                                        class="flex-1 px-4 py-2.5 rounded-lg bg-gray-100 dark:bg-dark-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-accent outline-none text-sm"
                                        onkeydown="if(event.key === 'Enter') sendChatMessage()">
                                    <button onclick="sendChatMessage()" class="px-4 py-2.5 rounded-lg bg-accent text-white hover:bg-accent-hover transition flex-shrink-0">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        let currentVacancyId = {{ vacancy_id }};
        let currentVacancy = null;
        let currentContactId = null;
        let currentContactUsername = null;  // Fallback when no contact_id (no CRM topic yet)
        let currentAgentSession = null;
        let agentsStatus = {};
        let recentVacancies = [];

        // Set initial history state
        history.replaceState({ vacancyId: currentVacancyId }, '', `/vacancy/${currentVacancyId}`);

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('sidebar-open');
            document.getElementById('sidebar-overlay').classList.toggle('hidden');
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Tooltip click handling for mobile
        function toggleTooltip(event) {
            event.stopPropagation();
            event.preventDefault();
            // Use event.target and traverse up (more reliable with inline handlers)
            const container = event.target.closest('.tooltip-container');
            if (!container) return;

            const wasActive = container.classList.contains('active');

            // Close all tooltips
            document.querySelectorAll('.tooltip-container.active').forEach(t => t.classList.remove('active'));

            // Toggle this one
            if (!wasActive) {
                container.classList.add('active');
            }
        }

        // Close tooltips when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.tooltip-container')) {
                document.querySelectorAll('.tooltip-container.active').forEach(t => t.classList.remove('active'));
            }
        });

        async function loadVacancy() {
            try {
                // Try to load from cache first, then fetch fresh
                const cachedVacancy = AppCache.get(`vacancy_${currentVacancyId}`);
                const cachedRecent = AppCache.get('recent_vacancies');

                if (cachedVacancy && cachedRecent) {
                    // Show cached data immediately
                    currentVacancy = cachedVacancy.vacancy;
                    currentContactId = cachedVacancy.vacancy.contact_id;
                    currentContactUsername = cachedVacancy.vacancy.contact_username;
                    recentVacancies = cachedRecent.filter(v => v.has_messages || v.contact_name || v.contact_username);
                    renderVacancy(cachedVacancy.vacancy);
                    renderContactCircles();
                    document.getElementById('loading').classList.add('hidden');
                    document.getElementById('content').classList.remove('hidden');
                    loadConversation();
                }

                // Fetch fresh data in background
                const [vacancyRes, recentRes] = await Promise.all([
                    fetch(`/api/vacancies/${currentVacancyId}`),
                    fetch('/api/vacancies/log?limit=20&filter_status=passed')
                ]);

                const vacancyData = await vacancyRes.json();
                const recentData = await recentRes.json();

                if (!vacancyData.success) {
                    if (!cachedVacancy) throw new Error(vacancyData.error || 'Failed to load vacancy');
                    return;
                }

                // Cache the data
                AppCache.set(`vacancy_${currentVacancyId}`, vacancyData, 60000);
                if (recentData.success) {
                    AppCache.set('recent_vacancies', recentData.vacancies, 30000);
                }

                currentVacancy = vacancyData.vacancy;
                currentContactId = vacancyData.vacancy.contact_id;
                currentContactUsername = vacancyData.vacancy.contact_username;

                if (recentData.success) {
                    recentVacancies = recentData.vacancies.filter(v => v.has_messages || v.contact_name || v.contact_username);
                }

                renderVacancy(vacancyData.vacancy);
                renderContactCircles();

                document.getElementById('loading').classList.add('hidden');
                document.getElementById('content').classList.remove('hidden');

                if (!cachedVacancy) loadConversation();
            } catch (error) {
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('error').classList.remove('hidden');
                console.error('Error loading vacancy:', error);
            }
        }

        function renderContactCircles() {
            const contacts = recentVacancies.slice(0, 10);
            if (contacts.length === 0) return;

            const tabsHtml = contacts.map(v => {
                const isActive = v.id === currentVacancyId;
                const initials = v.contact_name
                    ? v.contact_name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase()
                    : (v.contact_username ? v.contact_username[0].toUpperCase() : '?');
                const activeClass = isActive
                    ? 'bg-accent/20 text-accent'
                    : 'bg-gray-100 dark:bg-dark-700 text-gray-600 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-dark-600';
                return `
                    <button onclick="switchVacancy(${v.id})" data-vacancy-id="${v.id}" class="flex items-center gap-2 px-3 py-1.5 rounded-full ${activeClass} text-sm font-medium whitespace-nowrap transition-all">
                        <span class="w-6 h-6 rounded-full ${isActive ? 'bg-accent/30' : 'bg-gray-200 dark:bg-dark-600'} flex items-center justify-center text-xs">${initials}</span>
                        ${escapeHtml(v.contact_name || v.contact_username || 'Contact')}
                    </button>
                `;
            }).join('');

            document.getElementById('contacts-tabs').innerHTML = tabsHtml;

            // Scroll active tab into view
            requestAnimationFrame(() => {
                const activeTab = document.querySelector(`[data-vacancy-id="${currentVacancyId}"]`);
                if (activeTab) {
                    activeTab.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
                }
            });
        }

        async function switchVacancy(newId) {
            if (newId === currentVacancyId) return;

            currentVacancyId = newId;
            history.pushState({ vacancyId: newId }, '', `/vacancy/${newId}`);

            // Show loading in message log
            document.getElementById('message-log').innerHTML = `
                <div class="flex items-center justify-center py-6 text-sm text-gray-400 dark:text-gray-500">
                    <svg class="w-4 h-4 animate-spin mr-2" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Loading...
                </div>
            `;
            document.getElementById('chat-input-container').classList.add('hidden');

            // Update tabs immediately
            renderContactCircles();

            // Load new vacancy data
            try {
                const cachedVacancy = AppCache.get(`vacancy_${newId}`);
                if (cachedVacancy) {
                    currentVacancy = cachedVacancy.vacancy;
                    currentContactId = cachedVacancy.vacancy.contact_id;
                    currentContactUsername = cachedVacancy.vacancy.contact_username;
                    renderVacancy(cachedVacancy.vacancy);
                }

                const response = await fetch(`/api/vacancies/${newId}`);
                const data = await response.json();

                if (data.success) {
                    AppCache.set(`vacancy_${newId}`, data, 60000);
                    currentVacancy = data.vacancy;
                    currentContactId = data.vacancy.contact_id;
                    currentContactUsername = data.vacancy.contact_username;
                    renderVacancy(data.vacancy);
                }

                loadConversation();
            } catch (error) {
                console.error('Error switching vacancy:', error);
            }
        }

        // Handle browser back/forward
        window.addEventListener('popstate', (e) => {
            if (e.state?.vacancyId) {
                switchVacancy(e.state.vacancyId);
            }
        });

        function renderVacancy(v) {
            const statusBadge = document.getElementById('header-status-badge');
            const aiReason = escapeHtml(v.ai_reason || 'No analysis available');
            const sourceText = escapeHtml(v.text_full || v.text_preview || 'No text available');
            const channelName = escapeHtml(v.chat_title || 'Unknown');

            // Status badge with AI reason tooltip + lightbulb with source text
            if (v.is_relevant) {
                statusBadge.innerHTML = `
                    <div class="tooltip-container">
                        <span onclick="toggleTooltip(event)" class="px-3 py-1 text-sm font-medium rounded-full bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 cursor-help">Passed</span>
                        <div class="tooltip-content">${aiReason}</div>
                    </div>
                    <div class="tooltip-container">
                        <button onclick="toggleTooltip(event)" class="p-1.5 text-accent hover:text-accent-hover dark:text-accent-light dark:hover:text-accent hover:bg-accent/10 rounded-lg transition-colors">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                            </svg>
                        </button>
                        <div class="tooltip-content tooltip-source">
                            <div class="text-xs text-gray-400 mb-2">${channelName}</div>
                            <div class="whitespace-pre-wrap">${sourceText}</div>
                        </div>
                    </div>
                `;
            } else {
                const label = getFilteredLabel(v.ai_reason);
                statusBadge.innerHTML = `
                    <div class="tooltip-container">
                        <span onclick="toggleTooltip(event)" class="px-3 py-1 text-sm font-medium rounded-full bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400 cursor-help">${label}</span>
                        <div class="tooltip-content">${aiReason}</div>
                    </div>
                    <div class="tooltip-container">
                        <button onclick="toggleTooltip(event)" class="p-1.5 text-accent hover:text-accent-hover dark:text-accent-light dark:hover:text-accent hover:bg-accent/10 rounded-lg transition-colors">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                            </svg>
                        </button>
                        <div class="tooltip-content tooltip-source">
                            <div class="text-xs text-gray-400 mb-2">${channelName}</div>
                            <div class="whitespace-pre-wrap">${sourceText}</div>
                        </div>
                    </div>
                `;
            }

            // Contact avatar and name
            const contactName = v.contact_name || v.contact_username || 'Contact';
            const initials = v.contact_name
                ? v.contact_name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase()
                : (v.contact_username ? v.contact_username[0].toUpperCase() : '?');
            document.getElementById('contact-avatar').textContent = initials;
            document.getElementById('contact-name').textContent = contactName;
        }

        function getFilteredLabel(reason) {
            if (!reason) return 'Filtered';
            const r = reason.toLowerCase();
            if (r.includes('salary') || r.includes('зарплат')) return 'Low salary';
            if (r.includes('remote') || r.includes('office') || r.includes('офис') || r.includes('удален')) return 'Not remote';
            if (r.includes('recruiter') || r.includes('hr') || r.includes('рекрутер')) return 'Recruiter';
            if (r.includes('experience') || r.includes('опыт') || r.includes('senior') || r.includes('lead')) return 'Experience';
            if (r.includes('location') || r.includes('локац') || r.includes('город')) return 'Location';
            if (r.includes('stack') || r.includes('технолог') || r.includes('python') || r.includes('java')) return 'Tech stack';
            return 'Filtered';
        }

        async function loadAgentsStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                if (data.success && data.status?.agents) {
                    agentsStatus = data.status.agents;
                    updateAgentBadge();
                }
            } catch (e) {
                console.error('Failed to load agents status:', e);
            }
        }

        function updateAgentBadge() {
            const container = document.getElementById('agent-badge-container');
            if (!container || !currentAgentSession) return;

            const agent = agentsStatus[currentAgentSession];
            const firstName = agent?.user_info?.first_name || '';
            const lastName = agent?.user_info?.last_name || '';
            const fullName = `${firstName} ${lastName}`.trim() || currentAgentSession;
            const agentUsername = agent?.user_info?.username;
            const isConnected = agent?.status === 'connected';
            const floodWaitUntil = agent?.flood_wait_until;

            let statusText = 'Offline';
            let statusClass = 'text-gray-400';
            if (isConnected && !floodWaitUntil) {
                statusText = 'Online';
                statusClass = 'text-green-500';
            } else if (floodWaitUntil) {
                const remaining = Math.max(0, Math.floor((floodWaitUntil * 1000 - Date.now()) / 1000));
                if (remaining > 0) {
                    const hours = Math.floor(remaining / 3600);
                    const mins = Math.floor((remaining % 3600) / 60);
                    statusText = `Flood limit: ${hours}h ${mins}m`;
                } else {
                    statusText = 'Online';
                }
                statusClass = 'text-amber-500';
            }

            container.innerHTML = `
                <div class="tooltip-container">
                    <button onclick="toggleTooltip(event)" class="p-1.5 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 hover:bg-gray-100 dark:hover:bg-dark-700 rounded-lg transition-colors">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                        </svg>
                    </button>
                    <div class="tooltip-content">
                        <div class="font-medium">${escapeHtml(fullName)}</div>
                        ${agentUsername ? `<div class="text-gray-400">@${escapeHtml(agentUsername)}</div>` : ''}
                        <div class="mt-1 text-xs ${statusClass}">${statusText}</div>
                    </div>
                </div>
            `;
        }

        async function loadConversation() {
            // Use cached fetch from cache.js
            loadCachedVacancyMessages(currentVacancyId, (data) => {
                const messageLog = document.getElementById('message-log');

                if (!data.success) {
                    messageLog.innerHTML = `<div class="text-center text-gray-400 py-6">Failed to load conversation</div>`;
                    return;
                }

                if (!data.conversations || data.conversations.length === 0 || !data.conversations[0].messages?.length) {
                    // Show empty chat - just the input area, no placeholder text
                    messageLog.innerHTML = '';

                    // Update contact info from conversation if available
                    if (data.conversations && data.conversations[0]) {
                        currentContactId = data.conversations[0].contact_id;
                        currentAgentSession = data.conversations[0].agent_session;
                    }

                    // Show chat input if we have a contact to message
                    // Either contact_id (from CRM topic) or contact_username (from vacancy)
                    if (currentContactId || currentContactUsername) {
                        document.getElementById('chat-input-container').classList.remove('hidden');
                        loadAgents();
                    }
                    return;
                }

                const conv = data.conversations[0];
                currentContactId = conv.contact_id;
                currentAgentSession = conv.agent_session;
                updateAgentBadge();

                // Show chat input
                document.getElementById('chat-input-container').classList.remove('hidden');
                loadAgents();  // Load available agents for selector

                // Render messages
                // From operator's view: our messages (assistant) on right, their messages (user) on left
                messageLog.innerHTML = conv.messages.map(msg => {
                    if (msg.role === 'system') return ''; // Skip system messages
                    const isOurs = msg.role === 'assistant';
                    return `
                        <div class="flex ${isOurs ? 'justify-end' : 'justify-start'} mb-3">
                            <div class="${isOurs ? 'bg-accent text-white' : 'bg-gray-100 dark:bg-dark-700 text-gray-900 dark:text-white'} rounded-2xl px-4 py-2.5 max-w-[80%]">
                                <div class="text-sm whitespace-pre-wrap">${escapeHtml(msg.content)}</div>
                            </div>
                        </div>
                    `;
                }).join('');

                // Scroll to bottom
                messageLog.scrollTop = messageLog.scrollHeight;
            });
        }

        let availableAgents = [];

        async function loadAgents() {
            // Need either contact_id or username to send messages
            if (!currentContactId && !currentContactUsername) return;

            const selector = document.getElementById('agent-selector');
            const refreshIcon = document.getElementById('refresh-agents-icon');

            // Add spin animation
            refreshIcon?.classList.add('animate-spin');

            try {
                // Use general agents endpoint (doesn't require contact_id)
                const response = await fetch('/api/vacancies/agents');
                const data = await response.json();

                if (data.success && data.agents) {
                    availableAgents = data.agents;

                    // Clear and rebuild options
                    selector.innerHTML = '<option value="">Auto (best available)</option>';

                    data.agents.forEach(agent => {
                        const option = document.createElement('option');
                        option.value = agent.session_name;
                        if (agent.is_available) {
                            option.textContent = `✓ ${agent.display_name}`;
                            option.className = 'text-green-600 dark:text-green-400';
                        } else {
                            option.textContent = `⏳ ${agent.display_name} (${formatWaitTime(agent.flood_wait_remaining)})`;
                            option.className = 'text-orange-600 dark:text-orange-400';
                        }
                        selector.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading agents:', error);
            } finally {
                refreshIcon?.classList.remove('animate-spin');
            }
        }

        function refreshAgents() {
            loadAgents();
        }

        function formatWaitTime(seconds) {
            if (seconds < 60) return `${seconds}s`;
            if (seconds < 3600) return `${Math.ceil(seconds / 60)}m`;
            return `${Math.ceil(seconds / 3600)}h`;
        }

        async function sendChatMessage() {
            const input = document.getElementById('chat-message-input');
            const agentSelector = document.getElementById('agent-selector');
            const message = input?.value?.trim();
            // Need either contact_id or contact_username to send
            if (!message || (!currentContactId && !currentContactUsername)) return;

            const selectedAgent = agentSelector?.value || null;

            input.value = '';
            input.disabled = true;

            // Add message to UI immediately with pending state
            const messageLog = document.getElementById('message-log');
            const msgId = 'msg-' + Date.now();
            const agentLabel = selectedAgent ? ` (via ${selectedAgent})` : '';
            messageLog.innerHTML += `
                <div id="${msgId}" class="flex justify-end mb-3">
                    <div class="bg-accent text-white rounded-2xl px-4 py-2.5 max-w-[80%] relative">
                        <div class="text-sm whitespace-pre-wrap">${escapeHtml(message)}</div>
                        <div class="sending-indicator absolute -bottom-1 -right-1 w-4 h-4 rounded-full bg-white/20 flex items-center justify-center">
                            <svg class="w-2.5 h-2.5 animate-spin text-white/70" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                            </svg>
                        </div>
                    </div>
                </div>
            `;
            messageLog.scrollTop = messageLog.scrollHeight;

            try {
                // Use contact_id if available, otherwise use username
                const requestBody = {
                    contact_id: currentContactId,
                    contact_username: currentContactUsername,
                    message
                };
                if (selectedAgent) {
                    requestBody.agent_session = selectedAgent;
                }

                const response = await fetch('/api/vacancies/send-message', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });
                const data = await response.json();
                const msgEl = document.getElementById(msgId);

                if (data.success) {
                    // Remove sending indicator on success
                    msgEl?.querySelector('.sending-indicator')?.remove();
                    // Refresh agent status after sending
                    loadAgents();
                } else {
                    // Show error state
                    if (msgEl) {
                        const bubble = msgEl.querySelector('.bg-accent');
                        bubble.classList.remove('bg-accent');
                        bubble.classList.add('bg-red-500');
                        const indicator = msgEl.querySelector('.sending-indicator');
                        if (indicator) {
                            indicator.innerHTML = `<svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>`;
                            indicator.classList.remove('bg-white/20');
                            indicator.classList.add('bg-red-700');
                            indicator.title = data.error || 'Failed to send';
                        }
                    }
                    // Refresh agents to show updated status
                    loadAgents();
                }
            } catch (error) {
                console.error('Error sending message:', error);
                const msgEl = document.getElementById(msgId);
                if (msgEl) {
                    const bubble = msgEl.querySelector('.bg-accent');
                    bubble?.classList.remove('bg-accent');
                    bubble?.classList.add('bg-red-500');
                    msgEl.querySelector('.sending-indicator')?.remove();
                }
            } finally {
                input.disabled = false;
                input.focus();
            }
        }

        // Swipe gesture support for mobile
        let touchStartX = 0;
        let touchStartY = 0;
        let touchEndX = 0;
        let touchEndY = 0;
        const minSwipeDistance = 80;
        let swipeDirection = null;
        let isAnimating = false;

        function animatedSwitch(newId, direction) {
            if (isAnimating) return;
            isAnimating = true;

            const chatContainer = document.getElementById('chat-container');
            if (!chatContainer) {
                switchVacancy(newId);
                isAnimating = false;
                return;
            }

            // Slide out animation
            const outClass = direction === 'left' ? 'slide-out-left' : 'slide-out-right';
            const inClass = direction === 'left' ? 'slide-in-left' : 'slide-in-right';

            chatContainer.classList.add(outClass);

            setTimeout(() => {
                chatContainer.classList.remove(outClass);
                swipeDirection = direction;
                switchVacancy(newId);

                // Slide in animation after content loads
                requestAnimationFrame(() => {
                    chatContainer.classList.add(inClass);
                    setTimeout(() => {
                        chatContainer.classList.remove(inClass);
                        isAnimating = false;
                    }, 200);
                });
            }, 180);
        }

        function handleSwipe() {
            const deltaX = touchEndX - touchStartX;
            const deltaY = touchEndY - touchStartY;

            // Only trigger if horizontal swipe is dominant and long enough
            if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > minSwipeDistance) {
                const contacts = recentVacancies.slice(0, 10);
                const currentIndex = contacts.findIndex(v => v.id === currentVacancyId);

                if (currentIndex === -1) return;

                if (deltaX < 0) {
                    // Swipe left -> next chat
                    const nextIndex = currentIndex + 1;
                    if (nextIndex < contacts.length) {
                        animatedSwitch(contacts[nextIndex].id, 'left');
                    }
                } else {
                    // Swipe right -> previous chat
                    const prevIndex = currentIndex - 1;
                    if (prevIndex >= 0) {
                        animatedSwitch(contacts[prevIndex].id, 'right');
                    }
                }
            }
        }

        // Add touch listeners to the main content area
        document.addEventListener('DOMContentLoaded', () => {
            const mainContent = document.querySelector('main');
            if (mainContent) {
                mainContent.addEventListener('touchstart', (e) => {
                    touchStartX = e.changedTouches[0].screenX;
                    touchStartY = e.changedTouches[0].screenY;
                }, { passive: true });

                mainContent.addEventListener('touchend', (e) => {
                    touchEndX = e.changedTouches[0].screenX;
                    touchEndY = e.changedTouches[0].screenY;
                    handleSwipe();
                }, { passive: true });
            }
        });

        // Load on page ready
        document.addEventListener('DOMContentLoaded', () => {
            loadVacancy();
            loadAgentsStatus();
        });
    </script>
</body>
</html>
