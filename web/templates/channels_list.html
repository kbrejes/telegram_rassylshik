<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Notification Bot - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞–Ω–∞–ª–∞–º–∏</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì¢ Job Notification Bot</h1>
            <p>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞–Ω–∞–ª–∞–º–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</p>
        </div>

        <div class="card">
            <div class="channels-header">
                <h2>–í–∞—à–∏ –∫–∞–Ω–∞–ª—ã</h2>
                <a href="/channel/new" class="button button-primary">
                    ‚ûï –î–æ–±–∞–≤–∏—Ç—å –∫–∞–Ω–∞–ª
                </a>
            </div>

            {% if channels %}
                <div class="channels-list">
                    {% for channel in channels %}
                    <div class="channel-item">
                        <div class="channel-header">
                            <div class="channel-info">
                                <h3>{{ channel.name }}</h3>
                                <div>
                                    <span class="channel-status {% if channel.enabled %}enabled{% else %}disabled{% endif %}">
                                        {% if channel.enabled %}‚úì –ê–∫—Ç–∏–≤–µ–Ω{% else %}‚úó –û—Ç–∫–ª—é—á–µ–Ω{% endif %}
                                    </span>
                                    {% if channel.crm_enabled %}
                                    <span class="channel-status enabled" style="margin-left: 0.5rem;">
                                        ü§ñ CRM ({{ channel.agents|length }})
                                    </span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="channel-meta">
                            <div class="channel-meta-item">
                                <strong>ID:</strong> {{ channel.telegram_id }}
                            </div>
                            <div class="channel-meta-item">
                                <strong>–ò—Å—Ç–æ—á–Ω–∏–∫–æ–≤:</strong> {{ channel.input_sources|length }}
                            </div>
                            {% if channel.crm_enabled %}
                            <div class="channel-meta-item">
                                <strong>ü§ñ –ê–≥–µ–Ω—Ç–æ–≤:</strong> {{ channel.agents|length }}
                            </div>
                            <div class="channel-meta-item">
                                <strong>üìã CRM –≥—Ä—É–ø–ø–∞:</strong> {{ channel.crm_group_id }}
                            </div>
                            {% endif %}
                        </div>

                        <div class="channel-filters">
                            <strong>–í–∫–ª—é—á–∞—é—â–∏–µ —Ñ–∏–ª—å—Ç—Ä—ã:</strong>
                            <div class="filter-tags">
                                {% if channel.filters.include_keywords %}
                                    {% for keyword in channel.filters.include_keywords %}
                                    <span class="filter-tag include">{{ keyword }}</span>
                                    {% endfor %}
                                {% else %}
                                    <span class="help-text">–ù–µ—Ç —Ñ–∏–ª—å—Ç—Ä–æ–≤</span>
                                {% endif %}
                            </div>

                            {% if channel.filters.exclude_keywords %}
                            <strong style="margin-top: 0.5rem; display: block;">–ò—Å–∫–ª—é—á–∞—é—â–∏–µ —Ñ–∏–ª—å—Ç—Ä—ã:</strong>
                            <div class="filter-tags">
                                {% for keyword in channel.filters.exclude_keywords %}
                                <span class="filter-tag exclude">{{ keyword }}</span>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>

                        <div class="channel-actions">
                            <a href="/channel/{{ channel.id }}" class="button button-secondary button-small">
                                ‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                            </a>
                            <button onclick="deleteChannel('{{ channel.id }}')" class="button button-danger button-small">
                                üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="empty-state">
                    <div class="empty-state-icon">üì≠</div>
                    <h3>–ü–æ–∫–∞ –Ω–µ—Ç –∫–∞–Ω–∞–ª–æ–≤</h3>
                    <p>–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π –∫–∞–Ω–∞–ª –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</p>
                    <a href="/channel/new" class="button button-primary" style="margin-top: 1rem;">
                        –°–æ–∑–¥–∞—Ç—å –∫–∞–Ω–∞–ª
                    </a>
                </div>
            {% endif %}
        </div>

        <div class="card">
            <h2>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
            <div class="stats-grid" id="stats-grid">
                <div class="stat-card">
                    <div class="stat-value">{{ channels|length }}</div>
                    <div class="stat-label">–í—Å–µ–≥–æ –∫–∞–Ω–∞–ª–æ–≤</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">{{ channels|selectattr('enabled')|list|length }}</div>
                    <div class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="total-sources">0</div>
                    <div class="stat-label">–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="total-agents">0</div>
                    <div class="stat-label">ü§ñ –ê–≥–µ–Ω—Ç–æ–≤ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="crm-channels">0</div>
                    <div class="stat-label">CRM –∫–∞–Ω–∞–ª–æ–≤</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        async function loadStats() {
            try {
                const response = await fetch('/api/stats');
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('total-sources').textContent = data.stats.total_input_sources;
                    document.getElementById('total-agents').textContent = data.stats.total_agents;
                    document.getElementById('crm-channels').textContent = data.stats.crm_enabled_channels;
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error);
            }
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ –∫–∞–Ω–∞–ª–∞
        async function deleteChannel(channelId) {
            const deleteTelegram = confirm(
                '‚ö†Ô∏è –£–¥–∞–ª–∏—Ç—å –∫–∞–Ω–∞–ª?\n\n' +
                '–ù–∞–∂–º–∏—Ç–µ OK —á—Ç–æ–±—ã —É–¥–∞–ª–∏—Ç—å –∫–∞–Ω–∞–ª –í–ú–ï–°–¢–ï —Å Telegram –∫–∞–Ω–∞–ª–æ–º –∏ CRM –≥—Ä—É–ø–ø–æ–π.\n\n' +
                '–ù–∞–∂–º–∏—Ç–µ –û—Ç–º–µ–Ω–∞ —á—Ç–æ–±—ã –æ—Ç–º–µ–Ω–∏—Ç—å —É–¥–∞–ª–µ–Ω–∏–µ.'
            );

            if (!deleteTelegram) {
                // –°–ø—Ä–æ—Å–∏–º, –º–æ–∂–µ—Ç —Ö–æ—á–µ—Ç —É–¥–∞–ª–∏—Ç—å —Ç–æ–ª—å–∫–æ –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞
                const deleteConfigOnly = confirm(
                    '–£–¥–∞–ª–∏—Ç—å —Ç–æ–ª—å–∫–æ –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏?\n\n' +
                    'Telegram –∫–∞–Ω–∞–ª –∏ CRM –≥—Ä—É–ø–ø–∞ –æ—Å—Ç–∞–Ω—É—Ç—Å—è –≤ Telegram.\n\n' +
                    'OK - —É–¥–∞–ª–∏—Ç—å —Ç–æ–ª—å–∫–æ –∫–æ–Ω—Ñ–∏–≥\n' +
                    '–û—Ç–º–µ–Ω–∞ - –Ω–µ —É–¥–∞–ª—è—Ç—å –Ω–∏—á–µ–≥–æ'
                );
                if (!deleteConfigOnly) {
                    return;
                }
            }

            try {
                const url = `/api/channels/${channelId}?delete_telegram=${deleteTelegram}`;
                const response = await fetch(url, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (!response.ok) {
                    const errorMsg = data.detail || data.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
                    alert(`‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∫–∞–Ω–∞–ª–∞:\n\n${errorMsg}`);
                    return;
                }

                if (data.success) {
                    let message = '‚úÖ –ö–∞–Ω–∞–ª —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω!\n\n–£–¥–∞–ª–µ–Ω–æ:\n';
                    if (data.deleted) {
                        message += data.deleted.map(item => `‚Ä¢ ${item}`).join('\n');
                    }
                    if (data.pending && data.pending.length > 0) {
                        message += '\n\n‚è≥ –ë—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–æ –ø–æ–∑–∂–µ (rate limit):\n';
                        message += data.pending.map(item => `‚Ä¢ ${item}`).join('\n');
                    }
                    if (data.errors && data.errors.length > 0) {
                        message += '\n\n‚ö†Ô∏è –û—à–∏–±–∫–∏:\n';
                        message += data.errors.map(err => `‚Ä¢ ${err}`).join('\n');
                    }
                    alert(message);
                    window.location.reload();
                } else {
                    const errorMsg = data.message || data.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
                    alert(`‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∫–∞–Ω–∞–ª–∞:\n\n${errorMsg}`);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∫–∞–Ω–∞–ª–∞:', error);
                alert(`‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∫–∞–Ω–∞–ª–∞:\n\n${error.message}`);
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        loadStats();
    </script>
</body>
</html>

