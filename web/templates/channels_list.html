<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Notification Bot</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        .channel-card {
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            transition: box-shadow 0.2s;
        }

        .channel-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .channel-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .channel-card-header h3 {
            margin: 0;
            font-size: 1.25rem;
        }

        .channel-card-actions {
            display: flex;
            gap: 8px;
        }

        .agents-row {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .agent-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            background: #f5f5f5;
            border: 1px solid #e0e0e0;
        }

        .agent-badge .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .agent-badge .dot.connected {
            background: #4caf50;
            box-shadow: 0 0 6px rgba(76, 175, 80, 0.5);
        }

        .agent-badge .dot.disconnected {
            background: #9e9e9e;
        }

        .agent-badge .dot.flood_wait {
            background: #ff9800;
            box-shadow: 0 0 6px rgba(255, 152, 0, 0.5);
        }

        .agent-badge .dot.error {
            background: #f44336;
            box-shadow: 0 0 6px rgba(244, 67, 54, 0.5);
        }

        .no-agents {
            color: #999;
            font-size: 0.9rem;
        }

        /* Toggle switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .3s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: #4caf50;
        }

        input:checked + .toggle-slider:before {
            transform: translateX(20px);
        }

        .channel-card.disabled {
            opacity: 0.6;
        }

        .channel-card.disabled h3 {
            color: #999;
        }

        .bot-status-bar {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .bot-status-bar .dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .bot-status-bar .dot.online {
            background: #4caf50;
            box-shadow: 0 0 8px rgba(76, 175, 80, 0.5);
        }

        .bot-status-bar .dot.offline {
            background: #f44336;
        }

        .bot-status-bar .info {
            flex: 1;
        }

        .bot-status-bar .info strong {
            display: block;
        }

        .bot-status-bar .info small {
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Job Notification Bot</h1>
            <nav class="nav-menu">
                <a href="/" class="active">Channels</a>
                <a href="/agents">Agents</a>
                <a href="/vacancy-log">Vacancy Log</a>
                <a href="/candidate">Candidate</a>
                <a href="/ai-stats">AI Stats</a>
                <a href="/auth">Bot Auth</a>
            </nav>
        </div>

        <!-- Bot Status Bar -->
        <div class="bot-status-bar" id="bot-status-bar">
            <span class="dot offline" id="bot-dot"></span>
            <div class="info">
                <strong id="bot-name">Bot</strong>
                <small id="bot-info">Checking...</small>
            </div>
            <a href="/status" class="button button-small button-secondary">Manage</a>
        </div>

        <div class="card">
            <div class="channels-header">
                <h2>Channels</h2>
                <a href="/channel/new" class="button button-primary">+ Add Channel</a>
            </div>

            {% if channels %}
                <div class="channels-list">
                    {% for channel in channels %}
                    <div class="channel-card{% if not channel.enabled %} disabled{% endif %}" data-channel-id="{{ channel.id }}">
                        <div class="channel-card-header">
                            <h3>{{ channel.name }}</h3>
                            <div class="channel-card-actions">
                                <label class="toggle-switch" title="{% if channel.enabled %}Enabled{% else %}Disabled{% endif %}">
                                    <input type="checkbox" {% if channel.enabled %}checked{% endif %} onchange="toggleChannel('{{ channel.id }}', this.checked)">
                                    <span class="toggle-slider"></span>
                                </label>
                                <a href="/channel/{{ channel.id }}" class="button button-secondary button-small">Edit</a>
                                <button onclick="deleteChannel('{{ channel.id }}')" class="button button-danger button-small">Delete</button>
                            </div>
                        </div>

                        <div class="agents-row" id="agents-{{ channel.id }}">
                            {% if channel.agents %}
                                {% for agent in channel.agents %}
                                <div class="agent-badge" data-session="{{ agent.session_name }}">
                                    <span class="dot disconnected"></span>
                                    <span class="name">{{ agent.session_name }}</span>
                                </div>
                                {% endfor %}
                            {% else %}
                                <span class="no-agents">No agents configured</span>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="empty-state">
                    <div class="empty-state-icon">ðŸ“­</div>
                    <h3>No channels yet</h3>
                    <p>Create your first channel</p>
                    <a href="/channel/new" class="button button-primary" style="margin-top: 1rem;">
                        Create Channel
                    </a>
                </div>
            {% endif %}
        </div>
    </div>

    <script>
        // Load status and update UI
        async function loadStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();

                if (data.success) {
                    // Update bot status bar
                    const bot = data.status.bot;
                    const botDot = document.getElementById('bot-dot');
                    const botName = document.getElementById('bot-name');
                    const botInfo = document.getElementById('bot-info');

                    if (bot.connected && bot.authorized) {
                        botDot.className = 'dot online';
                        if (bot.user_info) {
                            botName.textContent = bot.user_info.first_name || 'Bot';
                            botInfo.textContent = '@' + (bot.user_info.username || 'connected');
                        } else {
                            botName.textContent = 'Bot';
                            botInfo.textContent = 'Connected';
                        }
                    } else {
                        botDot.className = 'dot offline';
                        botName.textContent = 'Bot';
                        botInfo.textContent = 'Offline';
                    }

                    // Update agent statuses
                    const agents = data.status.agents || {};
                    document.querySelectorAll('.agent-badge').forEach(badge => {
                        const sessionName = badge.dataset.session;
                        const agentStatus = agents[sessionName];
                        const dot = badge.querySelector('.dot');
                        const nameSpan = badge.querySelector('.name');

                        if (agentStatus) {
                            dot.className = 'dot ' + (agentStatus.status || 'disconnected');

                            // Update name with user info if available
                            if (agentStatus.user_info) {
                                const name = agentStatus.user_info.first_name || sessionName;
                                const username = agentStatus.user_info.username;
                                nameSpan.textContent = username ? `${name} (@${username})` : name;
                            }
                        } else {
                            dot.className = 'dot disconnected';
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading status:', error);
            }
        }

        // Toggle channel enabled/disabled
        async function toggleChannel(channelId, enabled) {
            try {
                const response = await fetch(`/api/channels/${channelId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enabled: enabled })
                });

                const data = await response.json();

                if (data.success) {
                    const card = document.querySelector(`.channel-card[data-channel-id="${channelId}"]`);
                    const toggle = card.querySelector('.toggle-switch');
                    if (enabled) {
                        card.classList.remove('disabled');
                        toggle.title = 'Enabled';
                    } else {
                        card.classList.add('disabled');
                        toggle.title = 'Disabled';
                    }
                } else {
                    alert('Error: ' + (data.message || 'Failed to update channel'));
                    // Revert toggle state
                    const checkbox = document.querySelector(`.channel-card[data-channel-id="${channelId}"] input[type="checkbox"]`);
                    checkbox.checked = !enabled;
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error updating channel');
                // Revert toggle state
                const checkbox = document.querySelector(`.channel-card[data-channel-id="${channelId}"] input[type="checkbox"]`);
                checkbox.checked = !enabled;
            }
        }

        // Delete channel
        async function deleteChannel(channelId) {
            const deleteConfig = confirm('Delete this channel configuration?');
            if (!deleteConfig) {
                return;
            }

            // Ask if user also wants to delete Telegram entities (channel + CRM group)
            const deleteTelegram = confirm('Also delete the Telegram channel and CRM group?\n\nClick OK to delete everything.\nClick Cancel to keep Telegram entities.');

            try {
                const response = await fetch(`/api/channels/${channelId}?delete_telegram=${deleteTelegram}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    let msg = 'Channel deleted!';
                    if (data.deleted && data.deleted.length > 0) {
                        msg += '\n\nDeleted: ' + data.deleted.join(', ');
                    }
                    if (data.pending && data.pending.length > 0) {
                        msg += '\n\nPending (rate limited): ' + data.pending.join(', ');
                    }
                    if (data.errors && data.errors.length > 0) {
                        msg += '\n\nErrors: ' + data.errors.join(', ');
                    }
                    alert(msg);
                    window.location.reload();
                } else {
                    alert('Error: ' + (data.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error deleting channel');
            }
        }

        // Load on page load and refresh every 5 seconds
        loadStatus();
        setInterval(loadStatus, 5000);
    </script>
</body>
</html>
