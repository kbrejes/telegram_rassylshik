<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–æ–∑–¥–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞ - Job Notification Bot</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        .wizard-container {
            max-width: 700px;
            margin: 0 auto;
        }

        .wizard-step {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .wizard-step h3 {
            margin: 0 0 15px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .step-number {
            width: 28px;
            height: 28px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
        }

        /* Collapsible sections */
        .collapsible-section {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-top: 15px;
        }

        .collapsible-header {
            padding: 12px 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .collapsible-header:hover {
            background: #f0f0f0;
        }

        .collapsible-content {
            padding: 15px;
            display: none;
            border-top: 1px solid #e0e0e0;
        }

        .collapsible-section.open .collapsible-content {
            display: block;
        }

        .collapsible-section.open .collapsible-header {
            border-radius: 8px 8px 0 0;
        }

        .arrow {
            transition: transform 0.2s;
        }

        .collapsible-section.open .arrow {
            transform: rotate(180deg);
        }

        /* Saved lists */
        .saved-list-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .saved-list-selector select {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        /* Agent cards */
        .agents-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .agent-card {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .agent-card:hover {
            border-color: #667eea;
        }

        .agent-card.selected {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        .agent-card .agent-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .agent-card .agent-phone {
            font-size: 0.85rem;
            color: #666;
        }

        .agent-card .checkmark {
            float: right;
            color: #667eea;
            display: none;
        }

        .agent-card.selected .checkmark {
            display: inline;
        }

        /* Template selector */
        .template-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 15px;
        }

        .template-option {
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 10px 15px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .template-option:hover {
            border-color: #667eea;
        }

        .template-option.selected {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        .template-name {
            font-weight: 500;
            margin-bottom: 3px;
        }

        .template-preview {
            font-size: 0.85rem;
            color: #666;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Add new agent button */
        .add-agent-card {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
            text-align: center;
            color: #666;
            transition: all 0.2s;
        }

        .add-agent-card:hover {
            border-color: #667eea;
            color: #667eea;
        }

        /* Submit button */
        .submit-section {
            text-align: center;
            padding: 20px;
        }

        .btn-submit {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-submit:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Status messages */
        .status-message {
            padding: 10px 15px;
            border-radius: 6px;
            margin-top: 10px;
            display: none;
        }

        .status-message.success {
            background: #d4edda;
            color: #155724;
            display: block;
        }

        .status-message.error {
            background: #f8d7da;
            color: #721c24;
            display: block;
        }

        /* Loading spinner */
        .loading-inline {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .help-text {
            font-size: 0.85rem;
            color: #666;
            margin-top: 5px;
        }

        .input, .textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
        }

        .textarea {
            min-height: 100px;
            resize: vertical;
        }

        .textarea-auto {
            width: 100% !important;
            min-height: 60px;
            max-height: 600px;
            overflow-y: auto;
            resize: none;
            box-sizing: border-box;
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Create Channel</h1>
            <nav class="nav-menu">
                <a href="/">Channels</a>
                <a href="/agents">Agents</a>
                <a href="/vacancy-log">Vacancy Log</a>
                <a href="/candidate">Candidate</a>
                <a href="/ai-stats">AI Stats</a>
                <a href="/auth">Bot Auth</a>
            </nav>
        </div>

        <div class="wizard-container">
            <!-- Step 1: Name -->
            <div class="wizard-step">
                <h3><span class="step-number">1</span> –ù–∞–∑–æ–≤–∏—Ç–µ –∫–∞–Ω–∞–ª</h3>
                <input
                    type="text"
                    id="channel_name"
                    class="input"
                    placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: Python –≤–∞–∫–∞–Ω—Å–∏–∏"
                    required
                >
                <p class="help-text">–≠—Ç–æ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è –≤–∞—à–µ–≥–æ —É–¥–æ–±—Å—Ç–≤–∞, –µ–≥–æ —É–≤–∏–¥–∏—Ç–µ —Ç–æ–ª—å–∫–æ –≤—ã</p>
            </div>

            <!-- Step 2: Sources -->
            <div class="wizard-step">
                <h3><span class="step-number">2</span> –ö–∞–∫–∏–µ –∫–∞–Ω–∞–ª—ã –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º?</h3>

                <div class="saved-list-selector">
                    <select id="source_presets" onchange="loadSourcePreset()">
                        <option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ ‚Äî</option>
                    </select>
                    <button type="button" class="btn-helper" onclick="saveCurrentSources()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ–∫—É—â–∏–π</button>
                </div>

                <textarea
                    id="input_sources"
                    class="textarea"
                    placeholder="@channel1&#10;@channel2&#10;@channel3"
                ></textarea>
                <p class="help-text">–£–∫–∞–∂–∏—Ç–µ –∫–∞–Ω–∞–ª—ã –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ (–ø–æ –æ–¥–Ω–æ–º—É –Ω–∞ —Å—Ç—Ä–æ–∫—É). –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ @username</p>
            </div>

            <!-- Step 3: Agents -->
            <div class="wizard-step">
                <h3><span class="step-number">3</span> –í—ã–±–µ—Ä–∏—Ç–µ –∞–≥–µ–Ω—Ç–æ–≤</h3>
                <p class="help-text" style="margin-top: 0;">–ê–≥–µ–Ω—Ç—ã –±—É–¥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –æ—Ç–∫–ª–∏–∫–∏ –æ—Ç –≤–∞—à–µ–≥–æ –∏–º–µ–Ω–∏</p>

                <div class="agents-grid" id="agents_grid">
                    <!-- Agents will be loaded here -->
                    <div class="add-agent-card" onclick="showAddAgentModal()">
                        ‚ûï –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–≥–æ –∞–≥–µ–Ω—Ç–∞
                    </div>
                </div>

                <div id="no_agents_warning" class="status-message" style="display: none; background: #fff3cd; color: #856404;">
                    ‚ö†Ô∏è –ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã—Ö –∞–≥–µ–Ω—Ç–æ–≤. –î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–≥–æ –∞–≥–µ–Ω—Ç–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã CRM.
                </div>
            </div>

            <!-- Step 4: Auto-response template -->
            <div class="wizard-step">
                <h3><span class="step-number">4</span> –®–∞–±–ª–æ–Ω –∞–≤—Ç–æ–æ—Ç–≤–µ—Ç–∞</h3>

                <div class="template-list" id="template_list">
                    <!-- Templates will be loaded here -->
                </div>

                <div class="collapsible-section" id="custom_template_section">
                    <div class="collapsible-header" onclick="toggleSection(this)">
                        <span>‚úèÔ∏è –ù–∞–ø–∏—Å–∞—Ç—å —Å–≤–æ–π —à–∞–±–ª–æ–Ω</span>
                        <span class="arrow">‚ñº</span>
                    </div>
                    <div class="collapsible-content">
                        <textarea
                            id="auto_response_template"
                            class="textarea"
                            placeholder="–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ú–µ–Ω—è –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–ª–∞ –≤–∞—à–∞ –≤–∞–∫–∞–Ω—Å–∏—è..."
                        ></textarea>
                        <div style="margin-top: 10px; display: flex; gap: 10px;">
                            <input type="text" id="new_template_name" class="input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞" style="flex: 1;">
                            <button type="button" class="btn-helper" onclick="saveTemplate()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 5: Optional filters (collapsible) -->
            <div class="wizard-step">
                <h3 style="margin-bottom: 5px;">‚öôÔ∏è –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
                <p class="help-text" style="margin-top: 0;">–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ ‚Äî –º–æ–∂–Ω–æ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å</p>

                <div class="collapsible-section">
                    <div class="collapsible-header" onclick="toggleSection(this)">
                        <span>üîç –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ (—Ñ–∏–ª—å—Ç—Ä—ã)</span>
                        <span class="arrow">‚ñº</span>
                    </div>
                    <div class="collapsible-content">
                        <div style="margin-bottom: 15px;">
                            <label><strong>–í–∫–ª—é—á–∞—é—â–∏–µ —Å–ª–æ–≤–∞</strong></label>
                            <textarea
                                id="include_keywords"
                                class="textarea"
                                placeholder="python&#10;django&#10;senior"
                                style="min-height: 80px;"
                            ></textarea>
                            <p class="help-text">–í–∞–∫–∞–Ω—Å–∏—è –¥–æ–ª–∂–Ω–∞ —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –∏–∑ —ç—Ç–∏—Ö —Å–ª–æ–≤</p>
                        </div>
                        <div>
                            <label><strong>–ò—Å–∫–ª—é—á–∞—é—â–∏–µ —Å–ª–æ–≤–∞</strong></label>
                            <textarea
                                id="exclude_keywords"
                                class="textarea"
                                placeholder="junior&#10;—Å—Ç–∞–∂–µ—Ä&#10;intern"
                                style="min-height: 80px;"
                            ></textarea>
                            <p class="help-text">–í–∞–∫–∞–Ω—Å–∏–∏ —Å —ç—Ç–∏–º–∏ —Å–ª–æ–≤–∞–º–∏ –±—É–¥—É—Ç –ø—Ä–æ–ø—É—â–µ–Ω—ã</p>
                        </div>
                    </div>
                </div>

                <div class="collapsible-section">
                    <div class="collapsible-header" onclick="toggleSection(this)">
                        <span>ü§ñ AI –ø—Ä–æ–º–ø—Ç—ã</span>
                        <span class="arrow">‚ñº</span>
                    </div>
                    <div class="collapsible-content">
                        <p class="help-text" style="margin-bottom: 15px;">–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ AI –ø—Ä–∏ –æ–±—â–µ–Ω–∏–∏ —Å –∫–æ–Ω—Ç–∞–∫—Ç–∞–º–∏. –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã.</p>

                        <div style="margin-bottom: 15px;">
                            <label><strong>–ë–∞–∑–æ–≤—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç</strong></label>
                            <textarea id="prompt_base_context" class="textarea textarea-auto" placeholder="–ó–∞–≥—Ä—É–∑–∫–∞..."></textarea>
                            <p class="help-text">–û–±—â–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏ —Å—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è AI</p>
                        </div>

                        <div style="margin-bottom: 15px;">
                            <label><strong>Discovery (–∑–Ω–∞–∫–æ–º—Å—Ç–≤–æ)</strong></label>
                            <textarea id="prompt_discovery" class="textarea textarea-auto" placeholder="–ó–∞–≥—Ä—É–∑–∫–∞..."></textarea>
                        </div>

                        <div style="margin-bottom: 15px;">
                            <label><strong>Engagement (–≤–æ–≤–ª–µ—á–µ–Ω–∏–µ)</strong></label>
                            <textarea id="prompt_engagement" class="textarea textarea-auto" placeholder="–ó–∞–≥—Ä—É–∑–∫–∞..."></textarea>
                        </div>

                        <div style="margin-bottom: 15px;">
                            <label><strong>Call Ready (–≥–æ—Ç–æ–≤ –∫ –∑–≤–æ–Ω–∫—É)</strong></label>
                            <textarea id="prompt_call_ready" class="textarea textarea-auto" placeholder="–ó–∞–≥—Ä—É–∑–∫–∞..."></textarea>
                        </div>

                        <div style="margin-bottom: 15px;">
                            <label><strong>Call Pending (–∑–≤–æ–Ω–æ–∫ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω)</strong></label>
                            <textarea id="prompt_call_pending" class="textarea textarea-auto" placeholder="–ó–∞–≥—Ä—É–∑–∫–∞..."></textarea>
                        </div>

                        <div>
                            <label><strong>Call Declined (–∑–≤–æ–Ω–æ–∫ –æ—Ç–∫–ª–æ–Ω–µ–Ω)</strong></label>
                            <textarea id="prompt_call_declined" class="textarea textarea-auto" placeholder="–ó–∞–≥—Ä—É–∑–∫–∞..."></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Submit -->
            <div class="submit-section">
                <button type="button" class="btn-submit" onclick="createChannel()" id="submit_btn">
                    üöÄ –°–æ–∑–¥–∞—Ç—å –∫–∞–Ω–∞–ª
                </button>
                <div id="submit_status" class="status-message"></div>
            </div>

            <div style="text-align: center; margin-top: 10px;">
                <a href="/" style="color: #666;">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Å–ø–∏—Å–∫—É –∫–∞–Ω–∞–ª–æ–≤</a>
            </div>
        </div>
    </div>

    <!-- Add Agent Modal -->
    <div id="add_agent_modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: white; padding: 25px; border-radius: 12px; max-width: 400px; width: 90%;">
            <h3 style="margin-top: 0;">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∞–≥–µ–Ω—Ç–∞</h3>
            <div style="margin-bottom: 15px;">
                <label>üì± –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</label>
                <input type="text" id="new_agent_phone" class="input" placeholder="+7 999 123 4567">
            </div>
            <div id="agent_code_section" style="display: none; margin-bottom: 15px;">
                <label>üîë –ö–æ–¥ –∏–∑ Telegram</label>
                <input type="text" id="new_agent_code" class="input" placeholder="12345">
            </div>
            <div id="agent_2fa_section" style="display: none; margin-bottom: 15px;">
                <label>üîê –ü–∞—Ä–æ–ª—å 2FA</label>
                <input type="password" id="new_agent_2fa" class="input" placeholder="–ü–∞—Ä–æ–ª—å">
            </div>
            <div id="agent_modal_status" class="status-message"></div>
            <div style="display: flex; gap: 10px; margin-top: 15px;">
                <button type="button" class="btn-helper" style="flex: 1;" onclick="closeAgentModal()">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn-submit" style="flex: 1; padding: 10px;" onclick="processAgentAuth()" id="agent_auth_btn">
                    –ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥
                </button>
            </div>
        </div>
    </div>

    <script>
        // State
        let selectedAgents = [];
        let selectedTemplateId = null;
        let availableAgents = [];
        let savedTemplates = [];
        let savedSourceLists = [];
        let agentAuthState = { step: 'phone', sessionName: null };
        let defaultPrompts = {};

        // Auto-resize textarea to fit content
        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 600) + 'px';
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await loadAvailableAgents();
            await loadSavedTemplates();
            await loadSavedSourceLists();
            await loadDefaultPrompts();

            // Setup auto-resize for all textareas with textarea-auto class
            document.querySelectorAll('.textarea-auto').forEach(textarea => {
                textarea.addEventListener('input', () => autoResize(textarea));
                // Initial resize after content is loaded
                setTimeout(() => autoResize(textarea), 100);
            });
        });

        // Load default prompts from server
        async function loadDefaultPrompts() {
            try {
                const response = await fetch('/api/channels/prompts/defaults');
                const data = await response.json();
                if (data.success && data.prompts) {
                    defaultPrompts = data.prompts;
                    document.getElementById('prompt_base_context').value = data.prompts.base_context || '';
                    document.getElementById('prompt_discovery').value = data.prompts.discovery || '';
                    document.getElementById('prompt_engagement').value = data.prompts.engagement || '';
                    document.getElementById('prompt_call_ready').value = data.prompts.call_ready || '';
                    document.getElementById('prompt_call_pending').value = data.prompts.call_pending || '';
                    document.getElementById('prompt_call_declined').value = data.prompts.call_declined || '';
                }
            } catch (e) {
                console.error('Error loading prompts:', e);
            }
        }

        // Collect prompts from form
        function collectPrompts() {
            return {
                base_context: document.getElementById('prompt_base_context').value,
                discovery: document.getElementById('prompt_discovery').value,
                engagement: document.getElementById('prompt_engagement').value,
                call_ready: document.getElementById('prompt_call_ready').value,
                call_pending: document.getElementById('prompt_call_pending').value,
                call_declined: document.getElementById('prompt_call_declined').value
            };
        }

        // Toggle collapsible sections
        function toggleSection(header) {
            const section = header.parentElement;
            section.classList.toggle('open');

            // Auto-resize textareas when section opens
            if (section.classList.contains('open')) {
                setTimeout(() => {
                    section.querySelectorAll('.textarea-auto').forEach(textarea => {
                        autoResize(textarea);
                    });
                }, 10);
            }
        }

        // Load available agents from backend
        async function loadAvailableAgents() {
            try {
                const response = await fetch('/api/agents');
                const data = await response.json();
                if (data.success) {
                    availableAgents = data.agents || [];
                    renderAgentsGrid();
                }
            } catch (e) {
                console.error('Error loading agents:', e);
            }
        }

        function renderAgentsGrid() {
            const grid = document.getElementById('agents_grid');
            const warning = document.getElementById('no_agents_warning');

            let html = '';
            availableAgents.forEach(agent => {
                const isSelected = selectedAgents.includes(agent.session_name);
                // Build meta info: @username | phone
                let meta = '';
                if (agent.username) meta = `@${agent.username}`;
                if (agent.phone) meta += (meta ? ' | ' : '') + agent.phone;
                if (!meta) meta = agent.session_name;

                html += `
                    <div class="agent-card ${isSelected ? 'selected' : ''}"
                         onclick="toggleAgent('${agent.session_name}')">
                        <span class="checkmark">‚úì</span>
                        <div class="agent-name">${agent.name || '–ê–≥–µ–Ω—Ç'}</div>
                        <div class="agent-phone">${meta}</div>
                    </div>
                `;
            });
            html += `<div class="add-agent-card" onclick="showAddAgentModal()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–≥–æ –∞–≥–µ–Ω—Ç–∞</div>`;

            grid.innerHTML = html;
            warning.style.display = availableAgents.length === 0 ? 'block' : 'none';
        }

        function toggleAgent(sessionName) {
            const idx = selectedAgents.indexOf(sessionName);
            if (idx > -1) {
                selectedAgents.splice(idx, 1);
            } else {
                selectedAgents.push(sessionName);
            }
            renderAgentsGrid();
        }

        // Load saved templates
        async function loadSavedTemplates() {
            try {
                const response = await fetch('/api/templates');
                const data = await response.json();
                if (data.success) {
                    savedTemplates = data.templates || [];
                    renderTemplates();
                }
            } catch (e) {
                console.error('Error loading templates:', e);
                // Default template
                savedTemplates = [
                    { id: 'default', name: '–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –æ—Ç–∫–ª–∏–∫', text: '–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ú–µ–Ω—è –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–ª–∞ –≤–∞—à–∞ –≤–∞–∫–∞–Ω—Å–∏—è. –ë—É–¥—É —Ä–∞–¥ –æ–±—Å—É–¥–∏—Ç—å –¥–µ—Ç–∞–ª–∏!' }
                ];
                renderTemplates();
            }
        }

        function renderTemplates() {
            const list = document.getElementById('template_list');
            let html = '';
            savedTemplates.forEach(t => {
                const isSelected = selectedTemplateId === t.id;
                html += `
                    <div class="template-option ${isSelected ? 'selected' : ''}" onclick="selectTemplate('${t.id}')">
                        <div class="template-name">${isSelected ? '‚úì ' : ''}${t.name}</div>
                        <div class="template-preview">${t.text.substring(0, 60)}${t.text.length > 60 ? '...' : ''}</div>
                    </div>
                `;
            });
            list.innerHTML = html;

            // Auto-select first template
            if (savedTemplates.length > 0 && !selectedTemplateId) {
                selectTemplate(savedTemplates[0].id);
            }
        }

        function selectTemplate(id) {
            selectedTemplateId = id;
            const template = savedTemplates.find(t => t.id === id);
            if (template) {
                document.getElementById('auto_response_template').value = template.text;
            }
            renderTemplates();
        }

        async function saveTemplate() {
            const name = document.getElementById('new_template_name').value.trim();
            const text = document.getElementById('auto_response_template').value.trim();

            if (!name || !text) {
                alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ —Ç–µ–∫—Å—Ç —à–∞–±–ª–æ–Ω–∞');
                return;
            }

            try {
                const response = await fetch('/api/templates', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, text })
                });
                const data = await response.json();
                if (data.success) {
                    await loadSavedTemplates();
                    document.getElementById('new_template_name').value = '';
                    alert('‚úÖ –®–∞–±–ª–æ–Ω —Å–æ—Ö—Ä–∞–Ω—ë–Ω!');
                }
            } catch (e) {
                console.error('Error saving template:', e);
            }
        }

        // Source lists
        async function loadSavedSourceLists() {
            try {
                const response = await fetch('/api/source-lists');
                const data = await response.json();
                if (data.success) {
                    savedSourceLists = data.lists || [];
                    renderSourcePresets();
                }
            } catch (e) {
                console.error('Error loading source lists:', e);
            }
        }

        function renderSourcePresets() {
            const select = document.getElementById('source_presets');
            let html = '<option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ ‚Äî</option>';
            savedSourceLists.forEach(list => {
                html += `<option value="${list.id}">${list.name} (${list.sources.length} –∫–∞–Ω–∞–ª–æ–≤)</option>`;
            });
            select.innerHTML = html;
        }

        function loadSourcePreset() {
            const select = document.getElementById('source_presets');
            const list = savedSourceLists.find(l => l.id === select.value);
            if (list) {
                document.getElementById('input_sources').value = list.sources.join('\n');
            }
        }

        async function saveCurrentSources() {
            const sources = document.getElementById('input_sources').value.trim();
            if (!sources) {
                alert('–°–Ω–∞—á–∞–ª–∞ –≤–≤–µ–¥–∏—Ç–µ –∫–∞–Ω–∞–ª—ã');
                return;
            }

            const name = prompt('–ù–∞–∑–≤–∞–Ω–∏–µ —Å–ø–∏—Å–∫–∞:', '–ú–æ–∏ –∫–∞–Ω–∞–ª—ã');
            if (!name) return;

            try {
                const response = await fetch('/api/source-lists', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name,
                        sources: sources.split('\n').map(s => s.trim()).filter(s => s)
                    })
                });
                const data = await response.json();
                if (data.success) {
                    await loadSavedSourceLists();
                    alert('‚úÖ –°–ø–∏—Å–æ–∫ —Å–æ—Ö—Ä–∞–Ω—ë–Ω!');
                }
            } catch (e) {
                console.error('Error saving sources:', e);
            }
        }

        // Agent modal
        function showAddAgentModal() {
            document.getElementById('add_agent_modal').style.display = 'flex';
            agentAuthState = { step: 'phone', sessionName: null };
            document.getElementById('new_agent_phone').value = '';
            document.getElementById('new_agent_code').value = '';
            document.getElementById('new_agent_2fa').value = '';
            document.getElementById('agent_code_section').style.display = 'none';
            document.getElementById('agent_2fa_section').style.display = 'none';
            document.getElementById('agent_auth_btn').textContent = '–ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥';
            document.getElementById('agent_modal_status').className = 'status-message';
        }

        function closeAgentModal() {
            document.getElementById('add_agent_modal').style.display = 'none';
        }

        async function processAgentAuth() {
            const btn = document.getElementById('agent_auth_btn');
            const status = document.getElementById('agent_modal_status');

            btn.disabled = true;

            try {
                if (agentAuthState.step === 'phone') {
                    const phone = document.getElementById('new_agent_phone').value.trim();
                    if (!phone) {
                        status.textContent = '–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞';
                        status.className = 'status-message error';
                        btn.disabled = false;
                        return;
                    }

                    btn.innerHTML = '–û—Ç–ø—Ä–∞–≤–∫–∞... <span class="loading-inline"></span>';

                    const response = await fetch('/api/agents/auth/start', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ phone })
                    });
                    const data = await response.json();

                    if (data.success) {
                        // Check if already authenticated
                        if (data.already_authenticated) {
                            status.textContent = '‚úÖ –ê–≥–µ–Ω—Ç —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç: ' + (data.name || '–£—Å–ø–µ—à–Ω–æ');
                            status.className = 'status-message success';
                            await loadAvailableAgents();
                            setTimeout(closeAgentModal, 1500);
                        } else {
                            agentAuthState.step = 'code';
                            agentAuthState.sessionName = data.session_name;
                            document.getElementById('agent_code_section').style.display = 'block';
                            btn.textContent = '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∫–æ–¥';
                            status.textContent = '–ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ Telegram';
                            status.className = 'status-message success';
                        }
                    } else {
                        status.textContent = data.message || '–û—à–∏–±–∫–∞';
                        status.className = 'status-message error';
                    }
                } else if (agentAuthState.step === 'code') {
                    const code = document.getElementById('new_agent_code').value.trim();
                    if (!code) {
                        status.textContent = '–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥';
                        status.className = 'status-message error';
                        btn.disabled = false;
                        return;
                    }

                    btn.innerHTML = '–ü—Ä–æ–≤–µ—Ä–∫–∞... <span class="loading-inline"></span>';

                    const response = await fetch('/api/agents/auth/verify', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            session_name: agentAuthState.sessionName,
                            code
                        })
                    });
                    const data = await response.json();

                    if (data.success) {
                        status.textContent = '‚úÖ –ê–≥–µ–Ω—Ç –ø–æ–¥–∫–ª—é—á—ë–Ω: ' + (data.name || '–£—Å–ø–µ—à–Ω–æ');
                        status.className = 'status-message success';
                        await loadAvailableAgents();
                        setTimeout(closeAgentModal, 1500);
                    } else if (data.requires_2fa) {
                        agentAuthState.step = '2fa';
                        document.getElementById('agent_2fa_section').style.display = 'block';
                        btn.textContent = '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ø–∞—Ä–æ–ª—å';
                        status.textContent = '–¢—Ä–µ–±—É–µ—Ç—Å—è –ø–∞—Ä–æ–ª—å 2FA';
                        status.className = 'status-message';
                    } else {
                        status.textContent = data.message || '–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥';
                        status.className = 'status-message error';
                    }
                } else if (agentAuthState.step === '2fa') {
                    const password = document.getElementById('new_agent_2fa').value;

                    btn.innerHTML = '–ü—Ä–æ–≤–µ—Ä–∫–∞... <span class="loading-inline"></span>';

                    const response = await fetch('/api/agents/auth/2fa', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            session_name: agentAuthState.sessionName,
                            password
                        })
                    });
                    const data = await response.json();

                    if (data.success) {
                        status.textContent = '‚úÖ –ê–≥–µ–Ω—Ç –ø–æ–¥–∫–ª—é—á—ë–Ω: ' + (data.name || '–£—Å–ø–µ—à–Ω–æ');
                        status.className = 'status-message success';
                        await loadAvailableAgents();
                        setTimeout(closeAgentModal, 1500);
                    } else {
                        status.textContent = data.message || '–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å';
                        status.className = 'status-message error';
                    }
                }
            } catch (e) {
                status.textContent = '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è';
                status.className = 'status-message error';
            }

            btn.disabled = false;
        }

        // Create channel
        async function createChannel() {
            const btn = document.getElementById('submit_btn');
            const status = document.getElementById('submit_status');

            // Validation
            const name = document.getElementById('channel_name').value.trim();
            const sources = document.getElementById('input_sources').value.trim();
            const template = document.getElementById('auto_response_template').value.trim();

            if (!name) {
                status.textContent = '–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞';
                status.className = 'status-message error';
                return;
            }

            if (!sources) {
                status.textContent = '–£–∫–∞–∂–∏—Ç–µ –∫–∞–Ω–∞–ª—ã –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞';
                status.className = 'status-message error';
                return;
            }

            if (selectedAgents.length === 0) {
                status.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–≥–æ –∞–≥–µ–Ω—Ç–∞';
                status.className = 'status-message error';
                return;
            }

            btn.disabled = true;
            btn.innerHTML = 'üîÑ –°–æ–∑–¥–∞–Ω–∏–µ... <span class="loading-inline"></span>';
            status.className = 'status-message';

            try {
                const response = await fetch('/api/channels/create-full', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name,
                        input_sources: sources.split('\n').map(s => s.trim()).filter(s => s),
                        agents: selectedAgents,
                        auto_response_template: template || '–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ú–µ–Ω—è –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–ª–∞ –≤–∞—à–∞ –≤–∞–∫–∞–Ω—Å–∏—è.',
                        include_keywords: document.getElementById('include_keywords').value.split('\n').map(s => s.trim()).filter(s => s),
                        exclude_keywords: document.getElementById('exclude_keywords').value.split('\n').map(s => s.trim()).filter(s => s),
                        prompts: collectPrompts()
                    })
                });

                const data = await response.json();

                if (data.success) {
                    status.innerHTML = '‚úÖ –ö–∞–Ω–∞–ª —Å–æ–∑–¥–∞–Ω! –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ...';
                    status.className = 'status-message success';
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 1500);
                } else {
                    status.textContent = '‚ùå ' + (data.message || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è');
                    status.className = 'status-message error';
                    btn.disabled = false;
                    btn.textContent = 'üöÄ –°–æ–∑–¥–∞—Ç—å –∫–∞–Ω–∞–ª';
                }
            } catch (e) {
                status.textContent = '‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É';
                status.className = 'status-message error';
                btn.disabled = false;
                btn.textContent = 'üöÄ –°–æ–∑–¥–∞—Ç—å –∫–∞–Ω–∞–ª';
            }
        }
    </script>

    {% include 'partials/chat_widget.html' %}
</body>
</html>
