<!DOCTYPE html>
<html lang="en" class="h-full" x-data="{ darkMode: localStorage.getItem('darkMode') === 'true' }" x-init="$watch('darkMode', val => localStorage.setItem('darkMode', val))" :class="{ 'dark': darkMode }">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agents - Job Notification Bot</title>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/static/js/cache.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        sidebar: {
                            DEFAULT: 'hsl(240 5.9% 10%)',
                            foreground: 'hsl(240 4.8% 95.9%)',
                            accent: 'hsl(240 3.7% 15.9%)',
                            border: 'hsl(240 3.7% 15.9%)',
                        },
                        accent: '#8b5cf6',
                        dark: {
                            950: '#09090b',
                            900: '#0c0c0f',
                            850: '#111114',
                            800: '#18181b',
                            700: '#27272a',
                            600: '#3f3f46',
                        }
                    },
                    boxShadow: {
                        'glow': '0 0 15px rgba(139, 92, 246, 0.15)',
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .scrollbar-thin::-webkit-scrollbar {
                width: 6px;
            }
            .scrollbar-thin::-webkit-scrollbar-track {
                background: transparent;
            }
            .scrollbar-thin::-webkit-scrollbar-thumb {
                background: #374151;
                border-radius: 3px;
            }
        }
        @layer components {
            . {
                @apply transition-all duration-300;
            }
            .dark .:hover {
                box-shadow: 0 0 20px rgba(139, 92, 246, 0.1);
            }
        }
    </style>
    <script>
        if (localStorage.getItem('darkMode') === 'true') {
            document.documentElement.classList.add('dark');
        }
    </script>
</head>
<body class="h-full bg-gray-50 dark:bg-dark-950 transition-colors duration-200">
    <div class="flex h-full">
        <!-- Sidebar -->
        <aside id="sidebar" class="fixed inset-y-0 left-0 z-50 w-64 bg-white dark:bg-sidebar transform transition-transform duration-200 ease-in-out lg:translate-x-0 lg:static lg:inset-auto -translate-x-full">
            <div class="flex flex-col h-full">
                <!-- Logo -->
                <div class="flex items-center gap-3 px-6 py-5 border-b border-gray-200 dark:border-sidebar-border">
                    <div class="flex items-center justify-center w-8 h-8 rounded-lg bg-gradient-to-br from-violet-500 to-purple-600">
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-sm font-semibold text-gray-900 dark:text-sidebar-foreground">Job Notification</h1>
                        <p class="text-xs text-gray-500">Bot Dashboard</p>
                    </div>
                </div>

                <!-- Navigation -->
                <nav class="flex-1 px-3 py-4 space-y-1 overflow-y-auto scrollbar-thin">
                    <a href="/" class="flex items-center gap-3 px-3 py-2 text-sm font-medium rounded-lg text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-sidebar-accent hover:text-gray-900 dark:hover:text-sidebar-foreground transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                        </svg>
                        Channels
                    </a>
                    <a href="/agents" class="flex items-center gap-3 px-3 py-2 text-sm font-medium rounded-lg bg-gray-100 dark:bg-sidebar-accent text-gray-900 dark:text-sidebar-foreground">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                        </svg>
                        Agents
                    </a>
                    <a href="/vacancy-log" class="flex items-center gap-3 px-3 py-2 text-sm font-medium rounded-lg text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-sidebar-accent hover:text-gray-900 dark:hover:text-sidebar-foreground transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/>
                        </svg>
                        Vacancy Log
                    </a>
                    <a href="/candidate" class="flex items-center gap-3 px-3 py-2 text-sm font-medium rounded-lg text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-sidebar-accent hover:text-gray-900 dark:hover:text-sidebar-foreground transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                        </svg>
                        Candidate
                    </a>
                    <a href="/ai-stats" class="flex items-center gap-3 px-3 py-2 text-sm font-medium rounded-lg text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-sidebar-accent hover:text-gray-900 dark:hover:text-sidebar-foreground transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                        </svg>
                        AI Stats
                    </a>
                    <a href="/auth" class="flex items-center gap-3 px-3 py-2 text-sm font-medium rounded-lg text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-sidebar-accent hover:text-gray-900 dark:hover:text-sidebar-foreground transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"/>
                        </svg>
                        Bot Auth
                    </a>
                </nav>

                <!-- Theme Toggle & Bot Status -->
                <div class="px-3 py-4 border-t border-gray-200 dark:border-sidebar-border space-y-3">
                    <button @click="darkMode = !darkMode" class="flex items-center gap-2 w-full px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-sidebar-accent transition-colors group">
                        <svg x-show="darkMode" class="w-4 h-4 text-amber-400" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clip-rule="evenodd"/>
                        </svg>
                        <svg x-show="!darkMode" class="w-4 h-4 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"/>
                        </svg>
                        <span class="text-sm text-gray-500 dark:text-gray-400 group-hover:text-gray-900 dark:group-hover:text-sidebar-foreground" x-text="darkMode ? 'Light mode' : 'Dark mode'"></span>
                    </button>

                    <div class="flex items-center gap-3 px-3 py-2 rounded-lg bg-gray-100 dark:bg-sidebar-accent">
                        <span id="sidebar-bot-dot" class="w-2.5 h-2.5 rounded-full bg-gray-500"></span>
                        <div class="flex-1 min-w-0">
                            <p id="sidebar-bot-name" class="text-sm font-medium text-gray-900 dark:text-sidebar-foreground truncate">Bot</p>
                            <p id="sidebar-bot-info" class="text-xs text-gray-500 truncate">Checking...</p>
                        </div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Mobile sidebar overlay -->
        <div id="sidebar-overlay" class="fixed inset-0 bg-black/50 z-40 lg:hidden hidden" onclick="toggleSidebar()"></div>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col min-h-screen min-w-0 lg:ml-0 overflow-x-hidden">
            <!-- Top Header (Mobile) -->
            <header class="sticky top-0 z-30 flex items-center gap-3 px-3 py-2.5 bg-white dark:bg-dark-800 border-b border-gray-200 dark:border-dark-700 lg:hidden">
                <button onclick="toggleSidebar()" class="p-2 -ml-1 rounded-lg hover:bg-gray-100 dark:hover:bg-dark-700 flex-shrink-0">
                    <svg class="w-5 h-5 text-gray-600 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                    </svg>
                </button>
                <h1 class="text-base font-semibold text-gray-900 dark:text-white truncate">Agents</h1>
            </header>

            <!-- Page Content -->
            <div class="flex-1 p-4 lg:p-8">
                <!-- Page Header -->
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900 dark:text-white hidden lg:block">Agents</h1>
                    </div>
                    <button onclick="showAddAgentModal()" class="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-violet-600 dark:bg-accent rounded-lg hover:bg-violet-700 dark:hover:bg-violet-500 transition-all">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                        </svg>
                        Add Agent
                    </button>
                </div>

                <!-- System Health Summary -->
                <div id="system-health" class="mb-6 hidden">
                    <div class="bg-white dark:bg-dark-800 rounded-xl shadow-sm p-4">
                        <div class="flex flex-wrap gap-4 items-center justify-between">
                            <div class="flex flex-wrap gap-4">
                                <div class="flex items-center gap-2">
                                    <span id="health-agents-dot" class="w-2.5 h-2.5 rounded-full bg-gray-400"></span>
                                    <span class="text-sm text-gray-600 dark:text-gray-300">
                                        <span id="health-agents-count" class="font-semibold">0</span> / <span id="health-agents-total">0</span> agents active
                                    </span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span id="health-crm-dot" class="w-2.5 h-2.5 rounded-full bg-gray-400"></span>
                                    <span class="text-sm text-gray-600 dark:text-gray-300">
                                        <span id="health-crm-count" class="font-semibold">0</span> with CRM access
                                    </span>
                                </div>
                            </div>
                            <div id="health-warning" class="hidden text-sm text-amber-600 dark:text-amber-400 flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                                </svg>
                                <span id="health-warning-text"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Agents Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4" id="agents-grid">
                    <div class="col-span-full flex items-center justify-center py-12">
                        <div class="flex items-center gap-3 text-gray-400">
                            <svg class="w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            Loading agents...
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- Add Agent Modal -->
    <div id="add-agent-modal" class="fixed inset-0 z-50 hidden" onclick="closeAddAgentModal(event)">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm modal-backdrop"></div>
        <div class="flex items-center justify-center min-h-full p-4">
            <div class="relative bg-white dark:bg-dark-800 rounded-xl shadow-xl max-w-md w-full overflow-hidden dark:border dark:border-dark-700 modal-enter" onclick="event.stopPropagation()">
                <div class="flex items-center justify-between px-5 py-4 border-b border-gray-200 dark:border-dark-700">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Add New Agent</h3>
                    <button onclick="closeAddAgentModal()" class="p-1.5 text-gray-400 hover:text-gray-600 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-dark-800 rounded-lg transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
                <div class="p-5 space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Phone Number</label>
                        <input type="text" id="agent-phone" class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-dark-600 rounded-lg bg-white dark:bg-dark-800 text-gray-900 dark:text-white focus:ring-2 focus:ring-violet-500 dark:focus:ring-accent focus:border-transparent" placeholder="+1 234 567 8900">
                    </div>
                    <div id="code-section" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Verification Code</label>
                        <input type="text" id="agent-code" class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-dark-600 rounded-lg bg-white dark:bg-dark-800 text-gray-900 dark:text-white focus:ring-2 focus:ring-violet-500 dark:focus:ring-accent focus:border-transparent" placeholder="12345">
                    </div>
                    <div id="2fa-section" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">2FA Password</label>
                        <input type="password" id="agent-2fa" class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-dark-600 rounded-lg bg-white dark:bg-dark-800 text-gray-900 dark:text-white focus:ring-2 focus:ring-violet-500 dark:focus:ring-accent focus:border-transparent" placeholder="Password">
                    </div>
                    <div id="modal-status" class="hidden px-3 py-2 rounded-lg text-sm"></div>
                </div>
                <div class="flex gap-3 px-5 py-4 bg-gray-50 dark:bg-dark-850 border-t border-gray-200 dark:border-dark-700">
                    <button onclick="closeAddAgentModal()" class="flex-1 px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-dark-800 border border-gray-300 dark:border-dark-600 rounded-lg hover:bg-gray-50 dark:hover:bg-dark-700 transition-colors">
                        Cancel
                    </button>
                    <button onclick="processAgentAuth()" id="auth-btn" class="flex-1 px-4 py-2 text-sm font-medium text-white bg-violet-600 dark:bg-accent rounded-lg hover:bg-violet-700 dark:hover:bg-violet-500 transition-colors">
                        Send Code
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="fixed bottom-4 right-4 z-50 space-y-2"></div>

    <script>
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            sidebar.classList.toggle('-translate-x-full');
            overlay.classList.toggle('hidden');
        }

        let pollingInterval = null;
        let agentAuthState = { step: 'phone', sessionName: null };
        let deletedAgents = new Set();

        async function loadStatus() {
            loadCachedStatus((data) => {
                if (data && data.success) {
                    updateSidebarStatus(data);  // From cache.js
                    updateAgentsGrid(data.status.agents);
                }
            });
        }

        let cachedSessions = null;

        async function loadSessions() {
            // Return cached sessions immediately if available
            const cached = AppCache.get('sessions');
            if (cached && cached.success) {
                cachedSessions = cached.sessions;
            }

            // Fetch fresh in background
            try {
                const response = await fetch('/api/status/sessions');
                const data = await response.json();
                if (data.success) {
                    AppCache.set('sessions', data, AppCache.TTL.agents);
                    cachedSessions = data.sessions;
                }
                return data.success ? data.sessions : (cachedSessions || []);
            } catch (error) {
                console.error('Error loading sessions:', error);
                return cachedSessions || [];
            }
        }

        async function updateAgentsGrid(agents) {
            const container = document.getElementById('agents-grid');
            const sessions = await loadSessions();
            const allAgents = new Map();

            if (agents) {
                for (const [name, agent] of Object.entries(agents)) {
                    if (!deletedAgents.has(name)) {
                        allAgents.set(name, { ...agent, registered: true });
                    }
                }
            }

            for (const session of sessions) {
                if (!allAgents.has(session.session_name) && !deletedAgents.has(session.session_name)) {
                    allAgents.set(session.session_name, {
                        status: 'disconnected',
                        phone: '',
                        user_info: session.user_info,
                        registered: false
                    });
                }
            }

            renderAgentsFromMap(allAgents);
        }

        let hasAnimated = false;
        // Track agents that are currently connecting (for UI feedback)
        let connectingAgents = new Set();

        // State configuration: dot color, label, and tooltip with explanation
        const STATE_CONFIG = {
            connected: {
                dot: 'bg-green-500',
                label: 'Connected',
                labelClass: 'text-green-600 dark:text-green-400',
                tooltip: 'Agent is connected and ready to send messages.'
            },
            connecting: {
                dot: 'bg-blue-500 animate-pulse',
                label: 'Connecting...',
                labelClass: 'text-blue-600 dark:text-blue-400',
                tooltip: 'Attempting to connect to Telegram. Please wait...'
            },
            disconnected: {
                dot: 'bg-gray-400',
                label: 'Disconnected',
                labelClass: 'text-gray-500 dark:text-gray-400',
                tooltip: 'Agent session exists but is not active. Click Connect to activate.'
            },
            flood_wait: {
                dot: 'bg-amber-500 animate-pulse',
                label: 'Rate Limited',
                labelClass: 'text-amber-600 dark:text-amber-400',
                tooltip: 'Telegram rate limit hit. Agent will auto-recover after the timer. DO NOT delete - just wait.'
            },
            spam_limited: {
                dot: 'bg-orange-500',
                label: 'Spam Block',
                labelClass: 'text-orange-600 dark:text-orange-400',
                tooltip: 'Telegram flagged this account for spam (PeerFloodError). Wait 1-24 hours before using. DO NOT delete.'
            },
            group_restricted: {
                dot: 'bg-orange-500',
                label: 'Group Restricted',
                labelClass: 'text-orange-600 dark:text-orange-400',
                tooltip: 'This agent cannot be added to groups (Telegram restriction). The agent can still send DMs but cannot access CRM groups. This usually means the account is new or has privacy restrictions.'
            },
            auth_required: {
                dot: 'bg-yellow-500',
                label: 'Auth Required',
                labelClass: 'text-yellow-600 dark:text-yellow-400',
                tooltip: 'Session needs verification. Delete and re-add the agent with phone number.'
            },
            code_rate_limit: {
                dot: 'bg-yellow-500',
                label: 'Code Rate Limited',
                labelClass: 'text-yellow-600 dark:text-yellow-400',
                tooltip: 'Telegram is blocking code requests for this number. Wait 30-60 minutes, then click Retry. DO NOT delete.'
            },
            auth_expired: {
                dot: 'bg-red-500',
                label: 'Session Expired',
                labelClass: 'text-red-600 dark:text-red-400',
                tooltip: 'Session key expired. Delete and re-add the agent to authenticate again.'
            },
            blocked: {
                dot: 'bg-red-600',
                label: 'Account Blocked',
                labelClass: 'text-red-600 dark:text-red-400',
                tooltip: 'This Telegram account has been banned. You need to use a different phone number.'
            },
            db_locked: {
                dot: 'bg-orange-500',
                label: 'Session Locked',
                labelClass: 'text-orange-600 dark:text-orange-400',
                tooltip: 'Session file is locked by another process. Try restarting the bot service, then Connect again.'
            },
            session_revoked: {
                dot: 'bg-red-500',
                label: 'Session Revoked',
                labelClass: 'text-red-600 dark:text-red-400',
                tooltip: 'Session was terminated (logged out from another device or Telegram revoked it). Delete and re-add.'
            },
            error: {
                dot: 'bg-red-500',
                label: 'Error',
                labelClass: 'text-red-600 dark:text-red-400',
                tooltip: 'An error occurred. Check the error message below. Try clicking Connect again.'
            }
        };

        function getAgentState(agent, sessionName) {
            if (connectingAgents.has(sessionName)) {
                return 'connecting';
            }

            const status = agent.status || 'disconnected';

            if (status === 'flood_wait' && agent.flood_wait_until) {
                const remaining = agent.flood_wait_until - Date.now()/1000;
                if (remaining > 1800) return 'spam_limited';
                if (remaining > 0) return 'flood_wait';
                return 'disconnected';
            }

            if (agent.error_message) {
                const err = agent.error_message.toLowerCase();
                if (err.includes('database is locked')) return 'db_locked';
                if (err.includes('authkeydup') || (err.includes('session') && err.includes('revoked'))) return 'session_revoked';
                if (err.includes('blocked') || err.includes('banned') || err.includes('deactivated')) return 'blocked';
                if (err.includes('auth') && (err.includes('expired') || err.includes('invalid'))) return 'auth_expired';
                // Code rate limit - "all available options" error from Telegram
                if (err.includes('all available options') || err.includes('resendcoderequest')) return 'code_rate_limit';
                // Group restricted - agent can't be added to groups
                if (err.includes('group restricted') || err.includes('invalid object id')) return 'group_restricted';
            }

            // Check can_join_groups flag
            if (agent.can_join_groups === false) {
                return 'group_restricted';
            }

            return status;
        }

        function updateHealthSummary(allAgents) {
            const healthPanel = document.getElementById('system-health');
            healthPanel.classList.remove('hidden');

            let totalAgents = 0;
            let connectedAgents = 0;
            let crmAccessAgents = 0;
            let restrictedAgents = 0;
            let issues = [];

            for (const [sessionName, agent] of allAgents) {
                if (sessionName === 'bot_session') continue;
                totalAgents++;

                const state = getAgentState(agent, sessionName);
                if (state === 'connected' || state === 'group_restricted') {
                    connectedAgents++;
                }
                if (agent.crm_access === true) {
                    crmAccessAgents++;
                }
                if (state === 'group_restricted' || agent.can_join_groups === false) {
                    restrictedAgents++;
                }
                if (state === 'blocked' || state === 'auth_expired' || state === 'session_revoked') {
                    issues.push(`${sessionName.replace('agent_', '')}: ${STATE_CONFIG[state]?.label || state}`);
                }
            }

            // Update counts
            document.getElementById('health-agents-count').textContent = connectedAgents;
            document.getElementById('health-agents-total').textContent = totalAgents;
            document.getElementById('health-crm-count').textContent = crmAccessAgents;

            // Update dots
            const agentsDot = document.getElementById('health-agents-dot');
            const crmDot = document.getElementById('health-crm-dot');

            agentsDot.className = 'w-2.5 h-2.5 rounded-full ' +
                (connectedAgents === totalAgents && totalAgents > 0 ? 'bg-green-500' :
                 connectedAgents > 0 ? 'bg-amber-500' : 'bg-red-500');

            crmDot.className = 'w-2.5 h-2.5 rounded-full ' +
                (crmAccessAgents > 0 ? 'bg-green-500' : 'bg-red-500');

            // Show warning if needed
            const warningEl = document.getElementById('health-warning');
            const warningText = document.getElementById('health-warning-text');

            if (crmAccessAgents === 0 && connectedAgents > 0) {
                warningEl.classList.remove('hidden');
                warningText.textContent = 'No agents can access CRM - conversation mirroring is DOWN';
            } else if (restrictedAgents > 0) {
                warningEl.classList.remove('hidden');
                warningText.textContent = `${restrictedAgents} agent(s) restricted from groups - can still send DMs`;
            } else if (issues.length > 0) {
                warningEl.classList.remove('hidden');
                warningText.textContent = `Issues: ${issues.join(', ')}`;
            } else {
                warningEl.classList.add('hidden');
            }
        }

        function renderAgentsFromMap(allAgents) {
            const container = document.getElementById('agents-grid');
            let html = '';

            // Update health summary first
            updateHealthSummary(allAgents);

            for (const [sessionName, agent] of allAgents) {
                if (sessionName === 'bot_session') continue;

                const state = getAgentState(agent, sessionName);
                const config = STATE_CONFIG[state] || STATE_CONFIG.disconnected;
                const userInfo = agent.user_info;

                let displayName = sessionName;
                let username = '';
                if (userInfo) {
                    const fullName = [userInfo.first_name, userInfo.last_name].filter(Boolean).join(' ');
                    if (fullName) displayName = fullName;
                    if (userInfo.username) username = `@${userInfo.username}`;
                }

                // Flood wait badge
                let floodBadge = '';
                if (agent.flood_wait_until) {
                    const remaining = Math.max(0, Math.ceil((agent.flood_wait_until - Date.now()/1000) / 60));
                    if (remaining > 0) {
                        floodBadge = `<span class="px-2 py-0.5 text-xs font-medium rounded-full bg-amber-100 dark:bg-amber-900/30 text-amber-700 dark:text-amber-400">${remaining}m</span>`;
                    }
                }

                // CRM access badge
                let crmBadge = '';
                if (agent.crm_access === true) {
                    crmBadge = `<span class="px-2 py-0.5 text-xs font-medium rounded-full bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400" title="Can mirror to CRM groups">CRM</span>`;
                } else if (agent.crm_access === false) {
                    crmBadge = `<span class="px-2 py-0.5 text-xs font-medium rounded-full bg-gray-100 dark:bg-gray-800 text-gray-500 dark:text-gray-400" title="Cannot access CRM groups - another agent is handling CRM">No CRM</span>`;
                }

                // Build tooltip with actual error message if present
                let tooltipText = config.tooltip;
                if (agent.error_message && state !== 'connected') {
                    tooltipText = `${config.tooltip}\n\nError: ${agent.error_message}`;
                }

                // Button based on state
                let button = '';
                if (state === 'connecting') {
                    button = `<button disabled class="w-full px-3 py-1.5 text-xs font-medium text-blue-700 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/20 rounded-lg flex items-center justify-center gap-2">
                        <svg class="w-3 h-3 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                        Connecting...
                    </button>`;
                } else if (state === 'connected') {
                    button = `<button onclick="disconnectAgent('${sessionName}')" class="w-full px-3 py-1.5 text-xs font-medium text-rose-700 dark:text-rose-400 bg-rose-50 dark:bg-rose-900/20 rounded-lg hover:bg-rose-100 dark:hover:bg-rose-900/30 transition-colors">Disconnect</button>`;
                } else if (state === 'code_rate_limit') {
                    button = `<button onclick="connectAgent('${sessionName}')" class="w-full px-3 py-1.5 text-xs font-medium text-yellow-700 dark:text-yellow-400 bg-yellow-50 dark:bg-yellow-900/20 rounded-lg hover:bg-yellow-100 dark:hover:bg-yellow-900/30 transition-colors">Retry (wait ~30m)</button>`;
                } else if (state === 'blocked') {
                    button = `<button disabled class="w-full px-3 py-1.5 text-xs font-medium text-red-700 dark:text-red-400 bg-red-50 dark:bg-red-900/20 rounded-lg opacity-60 cursor-not-allowed">Account Blocked</button>`;
                } else if (state === 'flood_wait' || state === 'spam_limited') {
                    button = `<button disabled class="w-full px-3 py-1.5 text-xs font-medium text-amber-700 dark:text-amber-400 bg-amber-50 dark:bg-amber-900/20 rounded-lg opacity-60 cursor-not-allowed">Wait for cooldown</button>`;
                } else {
                    button = `<button onclick="connectAgent('${sessionName}')" class="w-full px-3 py-1.5 text-xs font-medium text-green-700 dark:text-green-400 bg-green-50 dark:bg-green-900/20 rounded-lg hover:bg-green-100 dark:hover:bg-green-900/30 transition-colors">Connect</button>`;
                }

                html += `
                    <div class="bg-white dark:bg-dark-800 rounded-xl shadow-sm hover:shadow-md transition-all relative">
                        <button onclick="deleteAgent('${sessionName}')" class="absolute top-3 right-3 p-1.5 text-gray-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-colors">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                            </svg>
                        </button>
                        <div class="p-4">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="w-2.5 h-2.5 rounded-full ${config.dot} flex-shrink-0"></span>
                                <span class="font-semibold text-gray-900 dark:text-white truncate">${displayName}</span>
                                ${username ? `<span class="text-xs text-gray-500 dark:text-gray-400">${username}</span>` : ''}
                            </div>
                            <div class="flex items-center gap-2 mb-3 ml-4 flex-wrap">
                                <span class="text-xs font-medium ${config.labelClass} cursor-pointer hover:underline tooltip-trigger" data-tooltip="${tooltipText}" onclick="showTooltip(this)">${config.label}</span>
                                ${floodBadge}
                                ${crmBadge}
                            </div>
                            ${button}
                        </div>
                    </div>
                `;
            }

            html += `
                <div onclick="showAddAgentModal()" class="flex flex-col items-center justify-center p-8 bg-gray-50 dark:bg-dark-800 border-2 border-dashed border-gray-300 dark:border-dark-600 rounded-xl cursor-pointer hover:border-violet-400 dark:hover:border-violet-500 hover:bg-violet-50 dark:hover:bg-dark-850 transition-all">
                    <div class="w-12 h-12 flex items-center justify-center rounded-full bg-gray-100 dark:bg-dark-800 text-gray-400 mb-3">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                        </svg>
                    </div>
                    <span class="text-sm font-medium text-gray-600 dark:text-gray-400">Add New Agent</span>
                </div>
            `;

            container.innerHTML = html;

            if (!hasAnimated) {
                hasAnimated = true;
                container.classList.add('animate-in');
                setTimeout(() => container.classList.remove('animate-in'), 300);
            }
        }

        async function connectAgent(sessionName) {
            // Add to connecting set and re-render immediately
            connectingAgents.add(sessionName);
            loadStatus(); // Re-render with connecting state

            try {
                const response = await fetch(`/api/status/agents/${sessionName}/connect`, { method: 'POST' });
                const data = await response.json();
                if (data.success) {
                    showToast(`Connect queued for ${sessionName}`, 'success');
                    // Poll more frequently while connecting
                    setTimeout(() => {
                        connectingAgents.delete(sessionName);
                        loadStatus();
                    }, 3000);
                } else {
                    connectingAgents.delete(sessionName);
                    showToast(`Error: ${data.message}`, 'error');
                    loadStatus();
                }
            } catch (error) {
                connectingAgents.delete(sessionName);
                showToast(`Error: ${error.message}`, 'error');
                loadStatus();
            }
        }

        async function disconnectAgent(sessionName) {
            try {
                const response = await fetch(`/api/status/agents/${sessionName}/disconnect`, { method: 'POST' });
                const data = await response.json();
                if (data.success) {
                    showToast(`Disconnected ${sessionName}`, 'success');
                    setTimeout(loadStatus, 1000);
                } else {
                    showToast(`Error: ${data.message}`, 'error');
                }
            } catch (error) {
                showToast(`Error: ${error.message}`, 'error');
            }
        }

        async function deleteAgent(sessionName) {
            if (!confirm(`Delete agent ${sessionName}?\nThis will remove the session file.`)) return;

            try {
                const response = await fetch(`/api/status/agents/${sessionName}`, { method: 'DELETE' });
                const data = await response.json();
                if (data.success) {
                    showToast(`Deleted ${sessionName}`, 'success');
                    deletedAgents.add(sessionName);
                    loadStatus();
                } else {
                    showToast(`Error: ${data.message}`, 'error');
                }
            } catch (error) {
                showToast(`Error: ${error.message}`, 'error');
            }
        }

        async function connectAll() {
            showToast('Connecting all agents...', 'info');
            try {
                const response = await fetch('/api/status/agents/connect-all', { method: 'POST' });
                const data = await response.json();
                if (data.success) {
                    showToast('Connect all queued', 'success');
                    setTimeout(loadStatus, 2000);
                } else {
                    showToast(`Error: ${data.message}`, 'error');
                }
            } catch (error) {
                showToast(`Error: ${error.message}`, 'error');
            }
        }

        async function disconnectAll() {
            if (!confirm('Disconnect all agents?')) return;

            try {
                const response = await fetch('/api/status/agents/disconnect-all', { method: 'POST' });
                const data = await response.json();
                if (data.success) {
                    showToast('Disconnected all agents', 'success');
                    setTimeout(loadStatus, 2000);
                } else {
                    showToast(`Error: ${data.message}`, 'error');
                }
            } catch (error) {
                showToast(`Error: ${error.message}`, 'error');
            }
        }

        function showAddAgentModal() {
            document.getElementById('add-agent-modal').classList.remove('hidden');
            agentAuthState = { step: 'phone', sessionName: null };
            document.getElementById('agent-phone').value = '';
            document.getElementById('agent-code').value = '';
            document.getElementById('agent-2fa').value = '';
            document.getElementById('code-section').classList.add('hidden');
            document.getElementById('2fa-section').classList.add('hidden');
            document.getElementById('auth-btn').textContent = 'Send Code';
            document.getElementById('modal-status').className = 'hidden px-3 py-2 rounded-lg text-sm';
        }

        function closeAddAgentModal(event) {
            if (event && event.target !== document.getElementById('add-agent-modal')) return;
            document.getElementById('add-agent-modal').classList.add('hidden');
        }

        async function processAgentAuth() {
            const btn = document.getElementById('auth-btn');
            const status = document.getElementById('modal-status');

            btn.disabled = true;

            try {
                if (agentAuthState.step === 'phone') {
                    const phone = document.getElementById('agent-phone').value.trim();
                    if (!phone) {
                        showModalStatus('Enter phone number', 'error');
                        btn.disabled = false;
                        return;
                    }

                    btn.innerHTML = 'Sending...';

                    const response = await fetch('/api/agents/auth/start', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ phone })
                    });
                    const data = await response.json();

                    if (data.success) {
                        if (data.already_authenticated) {
                            showModalStatus('Agent already exists: ' + (data.name || 'Success'), 'success');
                            setTimeout(() => {
                                closeAddAgentModal();
                                loadStatus();
                            }, 1500);
                        } else {
                            agentAuthState.step = 'code';
                            agentAuthState.sessionName = data.session_name;
                            document.getElementById('code-section').classList.remove('hidden');
                            btn.textContent = 'Verify Code';
                            showModalStatus('Code sent to Telegram', 'success');
                        }
                    } else {
                        showModalStatus(data.message || 'Error', 'error');
                    }
                } else if (agentAuthState.step === 'code') {
                    const code = document.getElementById('agent-code').value.trim();
                    if (!code) {
                        showModalStatus('Enter verification code', 'error');
                        btn.disabled = false;
                        return;
                    }

                    btn.innerHTML = 'Verifying...';

                    const response = await fetch('/api/agents/auth/verify', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            session_name: agentAuthState.sessionName,
                            code
                        })
                    });
                    const data = await response.json();

                    if (data.success) {
                        showModalStatus('Agent connected: ' + (data.name || 'Success'), 'success');
                        setTimeout(() => {
                            closeAddAgentModal();
                            loadStatus();
                        }, 1500);
                    } else if (data.requires_2fa) {
                        agentAuthState.step = '2fa';
                        document.getElementById('2fa-section').classList.remove('hidden');
                        btn.textContent = 'Verify Password';
                        showModalStatus('2FA password required', 'info');
                    } else {
                        showModalStatus(data.message || 'Invalid code', 'error');
                    }
                } else if (agentAuthState.step === '2fa') {
                    const password = document.getElementById('agent-2fa').value;

                    btn.innerHTML = 'Verifying...';

                    const response = await fetch('/api/agents/auth/2fa', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            session_name: agentAuthState.sessionName,
                            password
                        })
                    });
                    const data = await response.json();

                    if (data.success) {
                        showModalStatus('Agent connected: ' + (data.name || 'Success'), 'success');
                        setTimeout(() => {
                            closeAddAgentModal();
                            loadStatus();
                        }, 1500);
                    } else {
                        showModalStatus(data.message || 'Invalid password', 'error');
                    }
                }
            } catch (e) {
                showModalStatus('Connection error', 'error');
            }

            btn.disabled = false;
        }

        function showModalStatus(message, type) {
            const status = document.getElementById('modal-status');
            status.textContent = message;
            status.classList.remove('hidden', 'bg-green-100', 'text-green-700', 'bg-red-100', 'text-red-700', 'bg-blue-100', 'text-blue-700', 'dark:bg-green-900/30', 'dark:text-green-400', 'dark:bg-red-900/30', 'dark:text-red-400', 'dark:bg-blue-900/30', 'dark:text-blue-400');
            if (type === 'success') {
                status.classList.add('bg-green-100', 'text-green-700', 'dark:bg-green-900/30', 'dark:text-green-400');
            } else if (type === 'error') {
                status.classList.add('bg-red-100', 'text-red-700', 'dark:bg-red-900/30', 'dark:text-red-400');
            } else {
                status.classList.add('bg-blue-100', 'text-blue-700', 'dark:bg-blue-900/30', 'dark:text-blue-400');
            }
        }

        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');

            let bgClass = 'bg-green-500';
            if (type === 'error') bgClass = 'bg-red-500';
            if (type === 'info') bgClass = 'bg-blue-500';

            toast.className = `${bgClass} text-white px-4 py-3 rounded-lg shadow-lg text-sm animate-slide-in`;
            toast.textContent = message;
            container.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function startPolling() {
            loadStatus();
            pollingInterval = setInterval(loadStatus, 5000);
        }

        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                clearInterval(pollingInterval);
            } else {
                startPolling();
            }
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeAddAgentModal();
        });

        // Show cached agents immediately on page load (before async calls)
        (function initFromCache() {
            const cachedStatus = AppCache.get('status');
            const cachedSessions = AppCache.get('sessions');
            if (cachedStatus && cachedStatus.success && cachedStatus.status.agents) {
                const agents = cachedStatus.status.agents;
                const sessions = (cachedSessions && cachedSessions.success) ? cachedSessions.sessions : [];
                // Build allAgents map synchronously
                const allAgents = new Map();
                for (const [name, agent] of Object.entries(agents)) {
                    allAgents.set(name, { ...agent, registered: true });
                }
                for (const session of sessions) {
                    if (!allAgents.has(session.session_name)) {
                        allAgents.set(session.session_name, { status: 'disconnected', phone: '', user_info: session.user_info, registered: false });
                    }
                }
                // Render immediately
                renderAgentsFromMap(allAgents);
            }
        })();

        startPolling();
    </script>

    <!-- Custom Tooltip -->
    <div id="custom-tooltip" class="fixed z-[100] max-w-xs px-3 py-2 text-sm text-white bg-gray-900 dark:bg-gray-700 rounded-lg shadow-lg pointer-events-none opacity-0 transition-opacity duration-200" style="display: none;">
        <span id="tooltip-text"></span>
        <div id="tooltip-arrow" class="absolute w-2 h-2 bg-gray-900 dark:bg-gray-700 rotate-45"></div>
    </div>

    <script>
        let tooltipTimeout = null;

        function showTooltip(element) {
            const tooltip = document.getElementById('custom-tooltip');
            const tooltipText = document.getElementById('tooltip-text');
            const tooltipArrow = document.getElementById('tooltip-arrow');
            const text = element.dataset.tooltip;

            if (!text) return;

            // Convert newlines to <br> and escape HTML
            const escaped = text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            tooltipText.innerHTML = escaped.replace(/\n/g, '<br>');
            tooltip.style.display = 'block';

            // Position tooltip above the element
            const rect = element.getBoundingClientRect();
            const tooltipRect = tooltip.getBoundingClientRect();

            let left = rect.left + (rect.width / 2) - (tooltipRect.width / 2);
            let top = rect.top - tooltipRect.height - 8;

            // Keep within viewport
            if (left < 8) left = 8;
            if (left + tooltipRect.width > window.innerWidth - 8) {
                left = window.innerWidth - tooltipRect.width - 8;
            }
            if (top < 8) {
                top = rect.bottom + 8;
                tooltipArrow.style.top = '-4px';
                tooltipArrow.style.bottom = 'auto';
            } else {
                tooltipArrow.style.bottom = '-4px';
                tooltipArrow.style.top = 'auto';
            }

            tooltip.style.left = left + 'px';
            tooltip.style.top = top + 'px';
            tooltipArrow.style.left = (rect.left + rect.width/2 - left - 4) + 'px';

            // Show with fade
            requestAnimationFrame(() => {
                tooltip.style.opacity = '1';
            });

            // Auto-hide after 6 seconds (longer for error messages)
            clearTimeout(tooltipTimeout);
            tooltipTimeout = setTimeout(hideTooltip, 6000);
        }

        function hideTooltip() {
            const tooltip = document.getElementById('custom-tooltip');
            tooltip.style.opacity = '0';
            setTimeout(() => {
                tooltip.style.display = 'none';
            }, 200);
        }

        // Hide on click outside
        document.addEventListener('click', (e) => {
            if (!e.target.classList.contains('tooltip-trigger')) {
                hideTooltip();
            }
        });
    </script>

    <style>
        @keyframes slide-in {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .animate-slide-in {
            animation: slide-in 0.3s ease;
            transition: all 0.3s ease;
        }
    </style>

    {% include 'partials/chat_widget.html' %}
</body>
</html>
