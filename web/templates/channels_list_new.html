<!DOCTYPE html>
<html lang="en" class="h-full" x-data="{ darkMode: localStorage.getItem('darkMode') === 'true' }" x-init="$watch('darkMode', val => localStorage.setItem('darkMode', val))" :class="{ 'dark': darkMode }">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Notification Bot</title>
    <!-- Alpine.js for reactivity -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        sidebar: {
                            DEFAULT: 'hsl(240 5.9% 10%)',
                            foreground: 'hsl(240 4.8% 95.9%)',
                            accent: 'hsl(240 3.7% 15.9%)',
                            border: 'hsl(240 3.7% 15.9%)',
                        },
                        accent: '#8b5cf6',
                        dark: {
                            950: '#09090b',
                            900: '#0c0c0f',
                            850: '#111114',
                            800: '#18181b',
                            700: '#27272a',
                            600: '#3f3f46',
                        }
                    },
                    boxShadow: {
                        'glow': '0 0 15px rgba(139, 92, 246, 0.15)',
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .scrollbar-thin::-webkit-scrollbar {
                width: 6px;
            }
            .scrollbar-thin::-webkit-scrollbar-track {
                background: transparent;
            }
            .scrollbar-thin::-webkit-scrollbar-thumb {
                background: #374151;
                border-radius: 3px;
            }
        }
        @layer components {
            .card-glow {
                @apply transition-all duration-300;
            }
            .dark .card-glow:hover {
                box-shadow: 0 0 20px rgba(139, 92, 246, 0.1);
            }
        }
    </style>
    <script>
        // Apply theme immediately to prevent flash
        if (localStorage.getItem('darkMode') === 'true') {
            document.documentElement.classList.add('dark');
        }
    </script>
</head>
<body class="h-full bg-gray-50 dark:bg-dark-950 transition-colors duration-200">
    <div class="flex h-full">
        <!-- Sidebar -->
        <aside id="sidebar" class="fixed inset-y-0 left-0 z-50 w-64 bg-sidebar transform transition-transform duration-200 ease-in-out lg:translate-x-0 lg:static lg:inset-auto -translate-x-full">
            <div class="flex flex-col h-full">
                <!-- Logo -->
                <div class="flex items-center gap-3 px-6 py-5 border-b border-sidebar-border">
                    <div class="flex items-center justify-center w-8 h-8 rounded-lg bg-gradient-to-br from-violet-500 to-purple-600">
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-sm font-semibold text-sidebar-foreground">Job Notification</h1>
                        <p class="text-xs text-gray-500">Bot Dashboard</p>
                    </div>
                </div>

                <!-- Navigation -->
                <nav class="flex-1 px-3 py-4 space-y-1 overflow-y-auto scrollbar-thin">
                    <a href="/" class="flex items-center gap-3 px-3 py-2 text-sm font-medium rounded-lg bg-sidebar-accent text-sidebar-foreground">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                        </svg>
                        Channels
                    </a>
                    <a href="/agents" class="flex items-center gap-3 px-3 py-2 text-sm font-medium rounded-lg text-gray-400 hover:bg-sidebar-accent hover:text-sidebar-foreground transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                        </svg>
                        Agents
                    </a>
                    <a href="/vacancy-log" class="flex items-center gap-3 px-3 py-2 text-sm font-medium rounded-lg text-gray-400 hover:bg-sidebar-accent hover:text-sidebar-foreground transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/>
                        </svg>
                        Vacancy Log
                    </a>
                    <a href="/candidate" class="flex items-center gap-3 px-3 py-2 text-sm font-medium rounded-lg text-gray-400 hover:bg-sidebar-accent hover:text-sidebar-foreground transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                        </svg>
                        Candidate
                    </a>
                    <a href="/ai-stats" class="flex items-center gap-3 px-3 py-2 text-sm font-medium rounded-lg text-gray-400 hover:bg-sidebar-accent hover:text-sidebar-foreground transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                        </svg>
                        AI Stats
                    </a>
                    <a href="/auth" class="flex items-center gap-3 px-3 py-2 text-sm font-medium rounded-lg text-gray-400 hover:bg-sidebar-accent hover:text-sidebar-foreground transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"/>
                        </svg>
                        Bot Auth
                    </a>
                </nav>

                <!-- Theme Toggle & Bot Status -->
                <div class="px-3 py-4 border-t border-sidebar-border space-y-3">
                    <!-- Theme Toggle -->
                    <button @click="darkMode = !darkMode" class="flex items-center justify-between w-full px-3 py-2 rounded-lg hover:bg-sidebar-accent transition-colors group">
                        <span class="text-sm text-gray-400 group-hover:text-sidebar-foreground">Theme</span>
                        <div class="flex items-center gap-2">
                            <!-- Sun icon -->
                            <svg x-show="darkMode" class="w-4 h-4 text-amber-400" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clip-rule="evenodd"/>
                            </svg>
                            <!-- Moon icon -->
                            <svg x-show="!darkMode" class="w-4 h-4 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"/>
                            </svg>
                            <span class="text-xs text-gray-500" x-text="darkMode ? 'Light' : 'Dark'"></span>
                        </div>
                    </button>

                    <!-- Bot Status -->
                    <div class="flex items-center gap-3 px-3 py-2 rounded-lg bg-sidebar-accent">
                        <span id="sidebar-bot-dot" class="w-2.5 h-2.5 rounded-full bg-gray-500"></span>
                        <div class="flex-1 min-w-0">
                            <p id="sidebar-bot-name" class="text-sm font-medium text-sidebar-foreground truncate">Bot</p>
                            <p id="sidebar-bot-info" class="text-xs text-gray-500 truncate">Checking...</p>
                        </div>
                        <a href="/status" class="p-1.5 rounded-md hover:bg-gray-700 text-gray-400 hover:text-white transition-colors">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                            </svg>
                        </a>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Mobile sidebar overlay -->
        <div id="sidebar-overlay" class="fixed inset-0 bg-black/50 z-40 lg:hidden hidden" onclick="toggleSidebar()"></div>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col min-h-screen min-w-0 lg:ml-0">
            <!-- Top Header (Mobile) -->
            <header class="sticky top-0 z-30 flex items-center gap-3 px-3 py-2.5 bg-white dark:bg-dark-900 border-b border-gray-200 dark:border-dark-700 lg:hidden">
                <button onclick="toggleSidebar()" class="p-2 -ml-1 rounded-lg hover:bg-gray-100 dark:hover:bg-dark-700 flex-shrink-0">
                    <svg class="w-5 h-5 text-gray-600 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                    </svg>
                </button>
                <h1 class="text-base font-semibold text-gray-900 dark:text-white truncate">Channels</h1>
            </header>

            <!-- Page Content -->
            <div class="flex-1 p-4 lg:p-8">
                <!-- Page Header -->
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900 dark:text-white hidden lg:block">Channels</h1>
                        <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Manage your monitoring channels and agents</p>
                    </div>
                    <a href="/channel/new" class="inline-flex items-center justify-center gap-2 px-4 py-2.5 text-sm font-medium text-white bg-violet-600 dark:bg-accent rounded-lg hover:bg-violet-700 dark:hover:bg-violet-500 transition-all shadow-sm hover:shadow-md">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                        </svg>
                        Add Channel
                    </a>
                </div>

                <!-- Channels List -->
                {% if channels %}
                <div class="space-y-4">
                    {% for channel in channels %}
                    <div class="bg-white dark:bg-dark-900 rounded-xl border border-gray-200 dark:border-dark-700 shadow-sm hover:shadow-md transition-all duration-300 overflow-hidden card-glow {% if not channel.enabled %}opacity-60{% endif %}" data-channel-id="{{ channel.id }}">
                        <!-- Channel Header -->
                        <div class="flex items-center justify-between p-4 border-b border-gray-100 dark:border-dark-700">
                            <div class="flex items-center gap-3">
                                <div class="flex items-center justify-center w-10 h-10 rounded-lg {% if channel.enabled %}bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400{% else %}bg-gray-100 dark:bg-dark-700 text-gray-400{% endif %}">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                                    </svg>
                                </div>
                                <div>
                                    <h3 class="font-semibold text-gray-900 dark:text-white">{{ channel.name }}</h3>
                                    <p class="text-xs text-gray-500 dark:text-gray-500">ID: {{ channel.id }}</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <!-- Toggle Switch -->
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" class="sr-only peer" {% if channel.enabled %}checked{% endif %} onchange="toggleChannel('{{ channel.id }}', this.checked)">
                                    <div class="w-11 h-6 bg-gray-200 dark:bg-dark-600 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-violet-300 dark:peer-focus:ring-accent/30 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-violet-600 dark:peer-checked:bg-accent"></div>
                                </label>
                                <!-- Edit Button -->
                                <a href="/channel/{{ channel.id }}" class="p-2 text-gray-400 hover:text-gray-600 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-dark-700 rounded-lg transition-colors">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                    </svg>
                                </a>
                                <!-- Delete Button -->
                                <button onclick="deleteChannel('{{ channel.id }}')" class="p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-colors">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                    </svg>
                                </button>
                            </div>
                        </div>

                        <!-- Agents Row -->
                        <div class="px-4 py-3 bg-gray-50 dark:bg-dark-850 border-b border-gray-100 dark:border-dark-700">
                            <div class="flex items-center gap-2 flex-wrap" id="agents-{{ channel.id }}">
                                <span class="text-xs font-medium text-gray-500 dark:text-gray-500 mr-1">Agents:</span>
                                {% if channel.agents %}
                                    {% for agent in channel.agents %}
                                    <div class="inline-flex items-center gap-1.5 px-2.5 py-1 bg-white dark:bg-dark-700 rounded-full border border-gray-200 dark:border-dark-600 text-xs" data-session="{{ agent.session_name }}">
                                        <span class="w-2 h-2 rounded-full bg-gray-400 dot"></span>
                                        <span class="name text-gray-700 dark:text-gray-300">{{ agent.session_name }}</span>
                                    </div>
                                    {% endfor %}
                                {% else %}
                                    <span class="text-xs text-gray-400 italic">No agents configured</span>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Vacancy Peek Section -->
                        <div class="p-3 sm:p-4" id="vacancy-peek-{{ channel.id }}">
                            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 sm:gap-0 mb-3">
                                <h4 class="text-sm font-medium text-gray-700 dark:text-gray-400">Recent Vacancies</h4>
                                <div class="flex items-center gap-2">
                                    <div class="flex rounded-lg border border-gray-200 dark:border-dark-700 overflow-hidden">
                                        <button class="px-2 sm:px-2.5 py-1 text-xs font-medium bg-violet-50 dark:bg-dark-700 text-violet-700 dark:text-white border-r border-gray-200 dark:border-dark-600 sort-btn active" onclick="sortVacancies('latest')" id="sort-latest">Latest</button>
                                        <button class="px-2 sm:px-2.5 py-1 text-xs font-medium text-gray-500 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-dark-700 sort-btn" onclick="sortVacancies('messages')" id="sort-messages">Has msgs</button>
                                    </div>
                                    <a href="/vacancy-log" class="text-xs text-violet-600 dark:text-accent hover:text-violet-800 dark:hover:text-violet-400 font-medium whitespace-nowrap">View all â†’</a>
                                </div>
                            </div>

                            <!-- Stats Row -->
                            <div class="flex gap-4 mb-3" id="vacancy-stats-{{ channel.id }}">
                                <div class="text-xs text-gray-500 dark:text-gray-400">Total: <span class="font-semibold text-gray-900 dark:text-white">-</span></div>
                                <div class="text-xs text-gray-500 dark:text-gray-400">Passed: <span class="font-semibold text-green-600 dark:text-green-400">-</span></div>
                                <div class="text-xs text-gray-500 dark:text-gray-400">Filtered: <span class="font-semibold text-red-600 dark:text-red-400">-</span></div>
                            </div>

                            <!-- Vacancy Table -->
                            <div class="vacancy-peek-content max-h-40 overflow-auto rounded-lg border border-gray-200 dark:border-dark-600" id="vacancy-content-{{ channel.id }}">
                                <div class="flex items-center justify-center py-6 text-sm text-gray-400">Loading...</div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <!-- Empty State -->
                <div class="flex flex-col items-center justify-center py-16 px-4">
                    <div class="flex items-center justify-center w-16 h-16 rounded-full bg-gray-100 dark:bg-dark-800 mb-4">
                        <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"/>
                        </svg>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-1">No channels yet</h3>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">Create your first channel to start monitoring</p>
                    <a href="/channel/new" class="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-violet-600 dark:bg-accent rounded-lg hover:bg-violet-700 dark:hover:bg-violet-500 transition-all">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                        </svg>
                        Create Channel
                    </a>
                </div>
                {% endif %}
            </div>
        </main>
    </div>

    <!-- Vacancy Detail Modal -->
    <div id="modal-overlay" class="fixed inset-0 z-50 hidden" onclick="closeModal(event)">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>
        <div class="flex items-center justify-center min-h-full p-4">
            <div class="relative bg-white dark:bg-dark-900 rounded-xl shadow-xl max-w-lg w-full max-h-[80vh] overflow-hidden dark:border dark:border-dark-700" onclick="event.stopPropagation()">
                <div class="flex items-center justify-between px-5 py-4 border-b border-gray-200 dark:border-dark-700">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Vacancy Details</h3>
                    <button onclick="closeModal()" class="p-1.5 text-gray-400 hover:text-gray-600 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-dark-800 rounded-lg transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
                <div id="modal-body" class="p-5 overflow-y-auto max-h-[calc(80vh-64px)]">
                </div>
            </div>
        </div>
    </div>

    <script>
        // Sidebar toggle
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            sidebar.classList.toggle('-translate-x-full');
            overlay.classList.toggle('hidden');
        }

        let peekVacancies = [];
        let currentSort = 'latest';
        let allVacancies = [];
        let vacancyStats = null;

        // Load status and update UI
        async function loadStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();

                if (data.success) {
                    const bot = data.status.bot;
                    const botDot = document.getElementById('sidebar-bot-dot');
                    const botName = document.getElementById('sidebar-bot-name');
                    const botInfo = document.getElementById('sidebar-bot-info');

                    if (bot.connected && bot.authorized) {
                        botDot.className = 'w-2.5 h-2.5 rounded-full bg-green-500 shadow-sm shadow-green-500/50';
                        if (bot.user_info) {
                            botName.textContent = bot.user_info.first_name || 'Bot';
                            botInfo.textContent = '@' + (bot.user_info.username || 'connected');
                        } else {
                            botName.textContent = 'Bot';
                            botInfo.textContent = 'Connected';
                        }
                    } else {
                        botDot.className = 'w-2.5 h-2.5 rounded-full bg-gray-400';
                        botName.textContent = 'Bot';
                        botInfo.textContent = 'Offline';
                    }

                    // Update agent statuses
                    const agents = data.status.agents || {};
                    document.querySelectorAll('[data-session]').forEach(badge => {
                        const sessionName = badge.dataset.session;
                        const agentStatus = agents[sessionName];
                        const dot = badge.querySelector('.dot');
                        const nameSpan = badge.querySelector('.name');

                        if (agentStatus) {
                            const status = agentStatus.status || 'disconnected';
                            if (status === 'connected') {
                                dot.className = 'w-2 h-2 rounded-full bg-green-500 shadow-sm shadow-green-500/50 dot';
                            } else if (status === 'flood_wait') {
                                dot.className = 'w-2 h-2 rounded-full bg-amber-500 shadow-sm shadow-amber-500/50 dot';
                            } else if (status === 'error' || status === 'auth_expired') {
                                dot.className = 'w-2 h-2 rounded-full bg-red-500 shadow-sm shadow-red-500/50 dot';
                            } else {
                                dot.className = 'w-2 h-2 rounded-full bg-gray-400 dot';
                            }

                            if (agentStatus.user_info) {
                                const name = agentStatus.user_info.first_name || sessionName;
                                const username = agentStatus.user_info.username;
                                nameSpan.textContent = username ? `${name} (@${username})` : name;
                            }
                        } else {
                            dot.className = 'w-2 h-2 rounded-full bg-gray-400 dot';
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading status:', error);
            }
        }

        // Toggle channel enabled/disabled
        async function toggleChannel(channelId, enabled) {
            try {
                const response = await fetch(`/api/channels/${channelId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enabled: enabled })
                });

                const data = await response.json();

                if (data.success) {
                    const card = document.querySelector(`[data-channel-id="${channelId}"]`);
                    if (enabled) {
                        card.classList.remove('opacity-60');
                    } else {
                        card.classList.add('opacity-60');
                    }
                } else {
                    alert('Error: ' + (data.message || 'Failed to update channel'));
                    const checkbox = document.querySelector(`[data-channel-id="${channelId}"] input[type="checkbox"]`);
                    checkbox.checked = !enabled;
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error updating channel');
                const checkbox = document.querySelector(`[data-channel-id="${channelId}"] input[type="checkbox"]`);
                checkbox.checked = !enabled;
            }
        }

        // Delete channel
        async function deleteChannel(channelId) {
            const deleteConfig = confirm('Delete this channel configuration?');
            if (!deleteConfig) return;

            const deleteTelegram = confirm('Also delete the Telegram channel and CRM group?\n\nClick OK to delete everything.\nClick Cancel to keep Telegram entities.');

            try {
                const response = await fetch(`/api/channels/${channelId}?delete_telegram=${deleteTelegram}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    let msg = 'Channel deleted!';
                    if (data.deleted && data.deleted.length > 0) {
                        msg += '\n\nDeleted: ' + data.deleted.join(', ');
                    }
                    if (data.pending && data.pending.length > 0) {
                        msg += '\n\nPending (rate limited): ' + data.pending.join(', ');
                    }
                    if (data.errors && data.errors.length > 0) {
                        msg += '\n\nErrors: ' + data.errors.join(', ');
                    }
                    alert(msg);
                    window.location.reload();
                } else {
                    alert('Error: ' + (data.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error deleting channel');
            }
        }

        // Load vacancy peek data
        async function loadVacancyPeek() {
            try {
                const response = await fetch('/api/vacancies/log?limit=50');
                const data = await response.json();

                if (data.success) {
                    allVacancies = data.vacancies;
                    vacancyStats = data.stats;
                    renderVacancies();
                }
            } catch (error) {
                console.error('Error loading vacancy peek:', error);
            }
        }

        function sortVacancies(sortBy) {
            currentSort = sortBy;
            const isDark = document.documentElement.classList.contains('dark');

            document.querySelectorAll('.sort-btn').forEach(btn => {
                btn.classList.remove('active', 'bg-violet-50', 'text-violet-700', 'bg-dark-700', 'text-white');
                btn.classList.add('text-gray-500', 'hover:bg-gray-50');
                if (isDark) btn.classList.add('hover:bg-dark-700');
            });
            const activeBtn = document.getElementById(`sort-${sortBy}`);
            if (isDark) {
                activeBtn.classList.add('active', 'bg-dark-700', 'text-white');
            } else {
                activeBtn.classList.add('active', 'bg-violet-50', 'text-violet-700');
            }
            activeBtn.classList.remove('text-gray-500', 'hover:bg-gray-50', 'hover:bg-dark-700');

            renderVacancies();
        }

        function renderVacancies() {
            let sorted = [...allVacancies];
            if (currentSort === 'messages') {
                sorted.sort((a, b) => {
                    if (a.has_messages === b.has_messages) {
                        return new Date(b.processed_at) - new Date(a.processed_at);
                    }
                    return b.has_messages - a.has_messages;
                });
            } else {
                sorted.sort((a, b) => new Date(b.processed_at) - new Date(a.processed_at));
            }

            peekVacancies = sorted;

            document.querySelectorAll('[id^="vacancy-peek-"]').forEach(peek => {
                const channelId = peek.id.replace('vacancy-peek-', '');
                const statsContainer = document.getElementById(`vacancy-stats-${channelId}`);
                const contentContainer = document.getElementById(`vacancy-content-${channelId}`);

                if (vacancyStats) {
                    statsContainer.innerHTML = `
                        <div class="text-xs text-gray-500 dark:text-gray-400">Total: <span class="font-semibold text-gray-900 dark:text-white">${vacancyStats.total}</span></div>
                        <div class="text-xs text-gray-500 dark:text-gray-400">Passed: <span class="font-semibold text-green-600 dark:text-green-400">${vacancyStats.passed}</span></div>
                        <div class="text-xs text-gray-500 dark:text-gray-400">Filtered: <span class="font-semibold text-red-600 dark:text-red-400">${vacancyStats.filtered}</span></div>
                    `;
                }

                if (sorted.length === 0) {
                    contentContainer.innerHTML = '<div class="flex items-center justify-center py-6 text-sm text-gray-400 dark:text-gray-500">No vacancies yet</div>';
                } else {
                    let html = `<table class="w-full text-sm">
                        <thead class="bg-gray-50 dark:bg-dark-800 text-xs text-gray-500 dark:text-gray-400 uppercase">
                            <tr>
                                <th class="px-3 py-2 text-left font-medium">Source</th>
                                <th class="px-3 py-2 text-right font-medium">Status</th>
                                <th class="px-3 py-2 text-right font-medium">Time</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100 dark:divide-dark-700">`;

                    sorted.slice(0, 10).forEach((v, idx) => {
                        const statusClass = v.is_relevant ? 'bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400' : 'bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400';
                        const statusLabel = v.is_relevant ? 'Passed' : 'Filtered';
                        const time = formatTime(v.processed_at);
                        const source = v.chat_title || 'Unknown';
                        const ledClass = v.has_messages ? 'bg-cyan-500' : 'bg-gray-300 dark:bg-dark-600';

                        html += `
                            <tr class="hover:bg-gray-50 dark:hover:bg-dark-800 cursor-pointer transition-colors" onclick="showVacancyDetails(${idx})">
                                <td class="px-3 py-2 text-gray-700 dark:text-gray-300 truncate max-w-[150px]" title="${source}">${source}</td>
                                <td class="px-3 py-2 text-right">
                                    <div class="flex items-center justify-end gap-1.5">
                                        <span class="px-2 py-0.5 text-xs font-medium rounded-full ${statusClass}">${statusLabel}</span>
                                        <span class="w-1.5 h-1.5 rounded-full ${ledClass}"></span>
                                    </div>
                                </td>
                                <td class="px-3 py-2 text-right text-gray-500 dark:text-gray-400 text-xs">${time}</td>
                            </tr>
                        `;
                    });

                    html += '</tbody></table>';
                    contentContainer.innerHTML = html;
                }
            });
        }

        async function showVacancyDetails(idx) {
            const v = peekVacancies[idx];
            if (!v) return;

            const modal = document.getElementById('modal-overlay');
            const body = document.getElementById('modal-body');

            const statusClass = v.is_relevant ? 'bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400' : 'bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400';
            const statusLabel = v.is_relevant ? 'Passed' : 'Filtered';

            body.innerHTML = `
                <div class="space-y-4">
                    <div>
                        <label class="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Source</label>
                        <p class="text-sm text-gray-900 dark:text-white mt-1">${escapeHtml(v.chat_title || 'Unknown')}</p>
                    </div>
                    <div>
                        <label class="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Status</label>
                        <p class="mt-1"><span class="px-2.5 py-1 text-xs font-medium rounded-full ${statusClass}">${statusLabel}</span></p>
                    </div>
                    <div>
                        <label class="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">AI Reason</label>
                        <p class="text-sm text-gray-900 dark:text-gray-200 mt-1">${escapeHtml(v.ai_reason || 'No reason provided')}</p>
                    </div>
                    <div>
                        <label class="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Processed</label>
                        <p class="text-sm text-gray-900 dark:text-gray-200 mt-1">${v.processed_at || '-'}</p>
                    </div>
                    <div id="message-log" class="pt-4 border-t border-gray-200 dark:border-dark-700">
                        <label class="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Message Log</label>
                        <div class="mt-2 text-sm text-gray-400 dark:text-gray-500">Loading...</div>
                    </div>
                    <div class="pt-4 border-t border-gray-200 dark:border-dark-700">
                        <label class="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Full Text</label>
                        <div class="mt-2 p-3 bg-gray-50 dark:bg-dark-800 rounded-lg text-sm text-gray-700 dark:text-gray-300 whitespace-pre-wrap max-h-48 overflow-y-auto border dark:border-dark-700">${escapeHtml(v.text_full || v.text_preview || '')}</div>
                    </div>
                </div>
            `;

            modal.classList.remove('hidden');

            // Load conversation data
            try {
                const response = await fetch(`/api/vacancies/messages/${v.id}`);
                const data = await response.json();
                const logContainer = document.getElementById('message-log');

                if (data.success && data.conversations && data.conversations.length > 0) {
                    let html = '<label class="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">CRM Conversation</label>';

                    data.conversations.forEach(conv => {
                        const phaseClass = conv.call_scheduled ? 'bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400' :
                                          conv.call_offered ? 'bg-amber-100 dark:bg-amber-900/30 text-amber-700 dark:text-amber-400' : 'bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400';

                        html += `
                            <div class="mt-2 p-3 bg-gray-50 dark:bg-dark-800 rounded-lg border dark:border-dark-700">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm font-medium text-gray-900 dark:text-white">${escapeHtml(conv.contact_name || 'Contact')}</span>
                                    <span class="px-2 py-0.5 text-xs font-medium rounded-full ${phaseClass}">${conv.current_phase}</span>
                                </div>
                        `;

                        if (conv.messages && conv.messages.length > 0) {
                            html += '<div class="space-y-2 mt-3">';
                            conv.messages.forEach(msg => {
                                if (msg.role === 'system') return;
                                const msgClass = msg.role === 'assistant' ? 'bg-violet-100 dark:bg-violet-900/30 text-violet-800 dark:text-violet-300 ml-auto' : 'bg-white dark:bg-dark-700 border border-gray-200 dark:border-dark-600 text-gray-800 dark:text-gray-200 mr-auto';
                                const sender = msg.role === 'assistant' ? 'Bot' : conv.contact_name || 'Contact';
                                html += `
                                    <div class="max-w-[85%] p-2.5 rounded-lg text-xs ${msgClass}">
                                        <div class="font-medium mb-1 opacity-70">${escapeHtml(sender)}</div>
                                        <div class="whitespace-pre-wrap">${escapeHtml(msg.content || '')}</div>
                                    </div>
                                `;
                            });
                            html += '</div>';
                        } else {
                            html += `
                                <div class="text-xs text-gray-500 dark:text-gray-400 space-y-1">
                                    <div>Total messages: ${conv.total_messages}</div>
                                    <div>Call offered: ${conv.call_offered ? 'Yes' : 'No'}</div>
                                    <div>Call scheduled: ${conv.call_scheduled ? 'Yes' : 'No'}</div>
                                </div>
                            `;
                        }

                        html += '</div>';
                    });

                    logContainer.innerHTML = html;
                } else {
                    logContainer.innerHTML = `
                        <label class="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">CRM Conversation</label>
                        <div class="mt-2 text-sm text-gray-400 dark:text-gray-500">No conversation linked yet</div>
                    `;
                }
            } catch (error) {
                console.error('Error loading conversation:', error);
                document.getElementById('message-log').innerHTML = `
                    <label class="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">CRM Conversation</label>
                    <div class="mt-2 text-sm text-red-500">Failed to load conversation</div>
                `;
            }
        }

        function closeModal(event) {
            if (event && event.target !== document.getElementById('modal-overlay')) return;
            document.getElementById('modal-overlay').classList.add('hidden');
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatTime(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr + 'Z');
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            return date.toLocaleDateString();
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeModal();
        });

        // Load on page load
        loadStatus();
        loadVacancyPeek();
        setInterval(loadStatus, 5000);
        setInterval(loadVacancyPeek, 30000);
    </script>

    {% include 'partials/chat_widget.html' %}
</body>
</html>
